<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Maxime Rivest">
<meta name="dcterms.date" content="2025-07-21">
<meta name="description" content="In this tutorial, I will show you how to make DSPy optimize a System Prompt Automatically.">

<title>Hacking DSPy into doing Automatic System Prompt Optimization – Maxime Rivest</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-532FMB8ETS"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-532FMB8ETS', { 'anonymize_ip': true});
</script>
<style>
.cell-output-stdout {
  overflow-y: scroll;
  max-height: 300px;
}
</style>


<link rel="stylesheet" href="../custom.css">
<meta name="twitter:title" content="Hacking DSPy into doing Automatic System Prompt Optimization – Maxime Rivest">
<meta name="twitter:description" content="In this tutorial, I will show you how to make DSPy optimize a System Prompt Automatically.">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Maxime Rivest</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://x.com/maximerivest"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.youtube.com/@maximerivest"> <i class="bi bi-youtube" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/maximerivest"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../posts.html"> 
<span class="menu-text">Posts</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#making-an-automatic-system-prompt-tool" id="toc-making-an-automatic-system-prompt-tool" class="nav-link active" data-scroll-target="#making-an-automatic-system-prompt-tool">Making an automatic System Prompt tool</a></li>
  <li><a href="#the-task" id="toc-the-task" class="nav-link" data-scroll-target="#the-task">The task</a></li>
  <li><a href="#training-set" id="toc-training-set" class="nav-link" data-scroll-target="#training-set">Training set</a></li>
  <li><a href="#metric" id="toc-metric" class="nav-link" data-scroll-target="#metric">Metric</a></li>
  <li><a href="#program" id="toc-program" class="nav-link" data-scroll-target="#program">Program</a></li>
  <li><a href="#making-a-simple-custom-adapter" id="toc-making-a-simple-custom-adapter" class="nav-link" data-scroll-target="#making-a-simple-custom-adapter">Making a Simple Custom Adapter</a></li>
  <li><a href="#automatically-generating-a-system-prompt" id="toc-automatically-generating-a-system-prompt" class="nav-link" data-scroll-target="#automatically-generating-a-system-prompt">Automatically Generating a System Prompt</a>
  <ul class="collapse">
  <li><a href="#letting-miprov2-write-the-system-prompt" id="toc-letting-miprov2-write-the-system-prompt" class="nav-link" data-scroll-target="#letting-miprov2-write-the-system-prompt">Letting MIPROv2 write the System Prompt</a></li>
  <li><a href="#using-llm-in-the-metric" id="toc-using-llm-in-the-metric" class="nav-link" data-scroll-target="#using-llm-in-the-metric">Using LLM in the Metric</a></li>
  <li><a href="#optimizing-with-few-shots-examples-too" id="toc-optimizing-with-few-shots-examples-too" class="nav-link" data-scroll-target="#optimizing-with-few-shots-examples-too">Optimizing with Few-Shots Examples too</a></li>
  <li><a href="#changing-optimizer" id="toc-changing-optimizer" class="nav-link" data-scroll-target="#changing-optimizer">Changing Optimizer</a></li>
  <li><a href="#teacher-student-optimization" id="toc-teacher-student-optimization" class="nav-link" data-scroll-target="#teacher-student-optimization">Teacher-Student optimization</a></li>
  <li><a href="#bringing-it-all-together" id="toc-bringing-it-all-together" class="nav-link" data-scroll-target="#bringing-it-all-together">Bringing it all together</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/MaximeRivest/maximerivest-blog/edit/main/posts/automatic-system-prompt-optimization.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header">
<div class="quarto-title-block"><div><h1 class="title">Hacking DSPy into doing Automatic System Prompt Optimization</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
<p class="author">Maxime Rivest</p>

<p class="date">2025-07-21</p>
</header>


<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Setting up
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>For this tutorial, you will only need to install dspy and setup a LLM connections. I will be using several LLMs to demonstrate how easy it is to switch between them and show the student/teacher concept. You can however set only one up if you want. If you use a locally hosted model, (you can!) simply skip the setting up of the API key. .</p>
<p>For this tutorial, I have will use Kimi-K2 hosted by Groq <a href="https://console.groq.com/keys">Click here to get a groq api key</a> and Llama models from OpenRouter <a href="https://openrouter.ai/settings/keys">Click here to get a OpenRouter key</a>.</p>
<div class="callout callout-style-simple callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
python library requirements
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>I like to use uv to install my libraries.</p>
<div id="23f95646" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>uv pip install dspy<span class="op">&gt;=</span><span class="fl">2.6.27</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
api key setup
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>I generally setup my key permanently but you can also do this to set it up just for here and now.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="in">import os</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="in">os.environ["GROQ_API_KEY"] = "[REDACTED]"</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="in">os.environ["OPENROUTER_API_KEY"] = "[REDACTED]"</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-simple callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Make GROQ_API_KEY permanent
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Replace GROQ_API_KEY with OPENROUTER_API_KEY to set openrouter key permanently on your system.</p>
<section id="linux-macos" class="level6">
<h6 class="anchored" data-anchor-id="linux-macos">Linux / macOS</h6>
<p>Append to your shell start-up file (pick the one you actually use):</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"export GROQ_API_KEY='gsk_[REDACTED]'"</span> <span class="op">&gt;&gt;</span> ~/.bashrc</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># or ~/.zshrc, ~/.profile, etc.</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> ~/.bashrc   <span class="co"># reload once</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="windows-cmd" class="level6">
<h6 class="anchored" data-anchor-id="windows-cmd">Windows – CMD</h6>
<div class="sourceCode" id="cb4"><pre class="sourceCode cmd code-with-copy"><code class="sourceCode dosbat"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>setx GROQ_API_KEY <span class="st">"gsk_[REDACTED]"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Close and reopen the terminal.</p>
</section>
<section id="windows-powershell" class="level6">
<h6 class="anchored" data-anchor-id="windows-powershell">Windows – PowerShell</h6>
<div class="sourceCode" id="cb5"><pre class="sourceCode powershell code-with-copy"><code class="sourceCode powershell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="op">[</span>Environment<span class="op">]::</span>SetEnvironmentVariable<span class="op">(</span><span class="st">"GROQ_API_KEY"</span><span class="op">,</span> <span class="st">"gsk_[REDACTED]"</span><span class="op">,</span> <span class="st">"User"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Refresh with <code>refreshenv</code> or open a new window.</p>
</section>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<section id="making-an-automatic-system-prompt-tool" class="level2">
<h2 class="anchored" data-anchor-id="making-an-automatic-system-prompt-tool">Making an automatic System Prompt tool</h2>
<p>In this tutorial, I’ll show you how I’ve modified and customized DSPy to make it handle system prompt optimization. Usually DSPy is doing program optimization. DSPy is very much batteries included, giving you tons of tools for everything. It’s general, and it gives you a framework for how to do things, which is powerful and useful. But that framework is about AI programming, not about system prompt optimization. That is why we will need to do some customization to DSPy. Don’t worry, DSPy was built in a way that lets us do it without too much work.</p>
<p>The nice thing about having to customize DSPy is that by the end you’ll walk away with two things. First, a way to automatically optimize system prompts. Second, you’ll have opened the hood: you’ll understand better how DSPy works and this will help you use DSPy more proficiently when you actually want to do AI programs.</p>
<p>So by the end of this tutorial we will have built this simple yet powerful automatic system prompt optimization utility and understood why we had to do what we did.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="in">optimzed_system_prompt = optimize(</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="in">    training_inputs = ["User prompt example 1", "...", "User prompt exampl n"],</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="in">    training_outputs = ["Desirable Assistant's example 1", "...", "Desirable Assistant's example 1"],</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="in">    llm_judge = "Return a 1 if it's good and a 0 if it's bad."</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Our <code>optimize</code> function will also be able to optionally take a starting system prompt, a max few-shots, and teacher and student model identifiers. Here is a mock-up of that:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="in">optimzed_system_prompt = optimize(</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="in">    training_inputs = ["User prompt example 1", "...", "User prompt exampl n"],</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="in">    training_outputs = ["Desirable Assistant's example 1", "...", "Desirable Assistant's example 1"],</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="in">    llm_judge = "Return a 1 if it's good and a 0 if it's bad.",</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="in">    system_prompt = "You are a model that perform well...",</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="in">    max_few_shots = 2,</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="in">    teacher_model = "a-smart-model",</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="in">    student_model = "a-cheap-model"</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now that we have our vision, let’s get going!</p>
</section>
<section id="the-task" class="level2">
<h2 class="anchored" data-anchor-id="the-task">The task</h2>
<p>All throughout this tutorial our task will be to make an English to Quebec-French translator.</p>
<p>The first DSPy optimizer that we want to use is <code>dspy.MIPROv2</code>. This optimizer can write (or improve) a program’s instructions. Let’s analyze the code below to learn what parts we must prepare to reach that goal of running MIPROv2 on task.</p>
<p>First we pass <code>translation_judge</code> to the optimizer initialisation. This should be a function that must return a score between 0 (bad) to 1 (good). In DSPy these are called metrics. Almost every DSPy optimizer requires a metric. After we have 2 <code>max_..._demos</code> which are set to 0, this is because as a first run we would like to only optimise the text of the system prompt without adding few-shot examples. MIPROv2 can search for few-shot examples that would improve a program’s performance.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="in">optimizer = dspy.MIPROv2(translation_judge, max_bootstrapped_demos = 0, max_labeled_demos = 0)</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="in">my_program_optimized = optimizer.compile(my_program, trainset=trainset)</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Second line of code, inside the <code>compile</code> method, we must give a DSPy <code>program</code>. This is not a string; it cannot be a system prompt. We will thus need to wrap up our system prompt + user/assistant simple LLM call into a lightweight program. And, finally, we have the trainset. In DSPy, this must be a list of <code>dspy.Example</code> objects. This is the object that all of DSPy’s internals are using, so there is no way around it; we must format our input/output training set as <code>dspy.Example</code>.</p>
<p>In summary, we need: 1. a metric 2. a program 3. a training set</p>
<p>and we must format those appropriately.</p>
<p>Let’s first tackle the training set as it is quite straightforward</p>
</section>
<section id="training-set" class="level2">
<h2 class="anchored" data-anchor-id="training-set">Training set</h2>
<p>The <code>Example()</code> object can take any arguments. You can think of those as column names in a dataframe or “keys” in JSON. It is usually pretty important to consider these names thoughtfully and normally DSPy will present them to the LLM as part of the prompts. In our case, that is a behavior from DSPy that we will change, so it does not matter what we call them. I decided to go with something very general. The <code>prompt</code> will be the user message and the <code>generation</code> will be the assistant message.</p>
<div id="9fb6d6c4" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dspy</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>examples <span class="op">=</span> [</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"I'm going to the convenience store."</span>, generation<span class="op">=</span><span class="st">"Je m'en vais au dépanneur."</span>),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"It's really cold out today."</span>, generation<span class="op">=</span><span class="st">"Il fait frette en maudit aujourd'hui."</span>),</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"Can you help me move this weekend?"</span>, generation<span class="op">=</span><span class="st">"Tu peux m'aider à déménager ce weekend?"</span>),</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"We were stuck in traffic for two hours."</span>, generation<span class="op">=</span><span class="st">"On était pognés dans le trafic pendant deux heures."</span>),</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"She's my girlfriend."</span>, generation<span class="op">=</span><span class="st">"C'est ma blonde."</span>),</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"That car is so cool!"</span>, generation<span class="op">=</span><span class="st">"C'est ben l'fun ce char-là!"</span>),</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"I'll call you tonight."</span>, generation<span class="op">=</span><span class="st">"Je vais t'appeler ce soir."</span>),</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"He's always bragging."</span>, generation<span class="op">=</span><span class="st">"Il se vente tout l'temps."</span>),</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"We grabbed a coffee at Tim's."</span>, generation<span class="op">=</span><span class="st">"On a pris un café au Tim."</span>),</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"Close the window, it's chilly."</span>, generation<span class="op">=</span><span class="st">"Ferme la fenêtre, y fait frette."</span>),</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"I have an appointment at 3."</span>, generation<span class="op">=</span><span class="st">"J'ai un rendez-vous à trois heures."</span>),</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"They're celebrating their birthday."</span>, generation<span class="op">=</span><span class="st">"Ils fêtent leur fête."</span>),</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"I parked in the back."</span>, generation<span class="op">=</span><span class="st">"J'ai stationné dans l'fond."</span>),</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"The metro is packed."</span>, generation<span class="op">=</span><span class="st">"Le métro est plein à craquer."</span>),</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"We watched a movie last night."</span>, generation<span class="op">=</span><span class="st">"On a écouté un film hier soir."</span>),</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"I need to do my groceries."</span>, generation<span class="op">=</span><span class="st">"J'dois faire mon épicerie."</span>),</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"Don't forget your boots."</span>, generation<span class="op">=</span><span class="st">"Oublie pas tes bottes."</span>),</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"It's snowing again."</span>, generation<span class="op">=</span><span class="st">"Il neige encore."</span>),</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"I'll take the bus."</span>, generation<span class="op">=</span><span class="st">"J'va prendre l'bus."</span>),</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"We're out of milk."</span>, generation<span class="op">=</span><span class="st">"On est à court de lait."</span>),</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Before we are done with our training set we must do 1 more little thing:</p>
<div id="3122f84e" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>trainset <span class="op">=</span> [x.with_inputs(<span class="st">'prompt'</span>) <span class="cf">for</span> x <span class="kw">in</span> examples]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This, again, is something we have to do because of DSPy’s general powerful nature. Briefly, it is used by DSPy’s code internally to know what fields of the Example object are input fields for the LLM. It helps internal development to separate inputs from outputs. In our case, we just need to know that we have to do it, and so we do.</p>
<p>Let’s move on to the Metric now!</p>
</section>
<section id="metric" class="level2">
<h2 class="anchored" data-anchor-id="metric">Metric</h2>
<p>Our first metric will be somewhat dumb and a little bit bad. That is because it is hard to have code that measures the quality of a translation. Despite that, we will get pretty good results, you will see.</p>
<p>In essence, all this code does is search for some very common French words that are not also common English words. If any of the words are found, the function returns a 1; otherwise it returns a 0.</p>
<div id="d7ae95bb" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_french(text):</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Naive French detector: check for common French words/accents</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    french_markers <span class="op">=</span> [</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        <span class="vs">r"\b(le|la|les|un|une|des|du|de|et|à|est|sont|avec|pour|sur|par|mais|ou|où|que|qui|quand|comment|nous|vous|ils|elles|ça|ce|cette|ces)\b"</span>,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        <span class="vs">r"[éèêàùçîôâœëïü]"</span>,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">any</span>(re.search(marker, text.lower()) <span class="cf">for</span> marker <span class="kw">in</span> french_markers)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> translation_judge(example, prediction, trace<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Return 1.0 if the output looks French, else 0.0.</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Doing the cast explicitly guarantees we never hand DSPy a None.</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> prediction.get(<span class="st">"generation"</span>, <span class="st">""</span>) <span class="kw">or</span> <span class="st">""</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">float</span>(is_french(output))</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Anything weird is just a miss</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice how <code>translation_judge</code> takes 3 arguments: <code>example</code>, <code>prediction</code>, and <code>trace</code>.</p>
<ul>
<li><code>example</code> will essentially be an instance of the <code>Example()</code> object as we defined above.</li>
<li><code>prediction</code> will be the parsed LLM output. Usually DSPy can do a lot here, but we will modify and simplify that part too.</li>
<li><code>trace</code> can be ignored except when we want models to generate good examples themselves. This is called bootstrapping, and in that case, if <code>trace</code> is not <code>None</code>, we must return a boolean for whether the LLM-generated example is good (1) or not (0). This could be used, for instance, to make our list of translation pairs longer.</li>
</ul>
<p>Moving on the the program now!</p>
</section>
<section id="program" class="level2">
<h2 class="anchored" data-anchor-id="program">Program</h2>
<p>The simplest program you can build in DSPy is one with only one input, one output, and empty instructions using <code>Predict</code>. A core concept of DSPy is around that signature, but since we do not want to do program optimization I’ll not go into it (see <a href="https://maximerivest.com/posts/dspy-one-hour-guide.html">this post</a> for a simple introduction to DSPy).</p>
<div id="e93c6399" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> signature(dspy.Signature):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" </span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    prompt <span class="op">=</span> dspy.InputField()</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    generation <span class="op">=</span> dspy.OutputField()</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>initial_program <span class="op">=</span> dspy.Predict(signature)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The most interesting part for you to note is that <code>initial_program</code> is now callable, and if we call it, we will get an LLM response, provided we set up an LLM like this:</p>
<div id="113584f2" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>kimi <span class="op">=</span> dspy.LM(<span class="st">"groq/moonshotai/kimi-k2-instruct"</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>dspy.configure(lm <span class="op">=</span> kimi)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>initial_program(prompt <span class="op">=</span> <span class="st">"Hello, how are you?"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>Prediction(
    generation="I'm doing well, thank you for asking! How can I help you today?"
)</code></pre>
</div>
</div>
<p>But we have a few problems.</p>
<div id="c47bdf5c" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>initial_program.inspect_history()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>



[2025-07-23T09:24:43.454241]

System message:

Your input fields are:
1. `prompt` (str):
Your output fields are:
1. `generation` (str):
All interactions will be structured in the following way, with the appropriate values filled in.

[[ ## prompt ## ]]
{prompt}

[[ ## generation ## ]]
{generation}

[[ ## completed ## ]]
In adhering to this structure, your objective is:


User message:

[[ ## prompt ## ]]
Hello, how are you?

Respond with the corresponding output fields, starting with the field `[[ ## generation ## ]]`, and then ending with the marker for `[[ ## completed ## ]]`.


Response:

[[ ## generation ## ]]
I'm doing well, thank you for asking! How can I help you today?

[[ ## completed ## ]]




</code></pre>
</div>
</div>
<p>The above command prints the previous interaction we had with the LLM. In that interaction, the system prompt was:</p>
<pre class="{text}"><code>Your input fields are:
1. `prompt` (str):
Your output fields are:
1. `generation` (str):
All interactions will be structured in the following way, with the appropriate values filled in.

[[ ## prompt ## ]]
{prompt}

[[ ## generation ## ]]
{generation}

[[ ## completed ## ]]
In adhering to this structure, your objective is:</code></pre>
<p>And the user message was:</p>
<pre class="{text}"><code>[[ ## prompt ## ]]
Hello, how are you?

Respond with the corresponding output fields, starting with the field `[[ ## generation ## ]]`, and then ending with the marker for `[[ ## completed ## ]]`.</code></pre>
<p>And the assistant was:</p>
<pre class="{text}"><code>[[ ## generation ## ]]
I'm doing well, thank you for asking! How can I help you today?

[[ ## completed ## ]]</code></pre>
<p>A lot of stuff was added, and if we run an optimizer as it is, we will be optimizing the LLM’s performance in that prompt template. This is a little too different from the vanilla we would have expected, which is: <code>sp = ""</code>, <code>user = "Hello, how are you?"</code>, and the assistant response could have been something like <code>assistant = "I'm doing well, thank you for asking! How can I help you today?"</code>. The culprit for the additions is DSPy’s adapter. The adapter is amazing at turning a DSPy signature into an AI program, but right now, it’s in the way.</p>
<p>Let’s replace DSPy’s adapter with our own simplified version.</p>
</section>
<section id="making-a-simple-custom-adapter" class="level2">
<h2 class="anchored" data-anchor-id="making-a-simple-custom-adapter">Making a Simple Custom Adapter</h2>
<p>Adapters are DSPy’s interface to the LLMs. They are called with a few pieces of information, and DSPy expects a parsed LLM generation to be returned. The following is the simplest we can make an adapter. We are taking in the LM that DSPy’s internals want us to use, keyword arguments if any, a signature, demos, and inputs.</p>
<p>The signature can contain only 3 things: instructions, inputs, and outputs. In our case, we have “canned” the signature, so we also know that the input is named <code>prompt</code> and the output is named <code>generation</code>, simplifying our requirements for our adapter substantially from what DSPy usually has to worry about.</p>
<div id="31408127" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the SimplestAdapter as before</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SimplestAdapter(dspy.Adapter):</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, lm, lm_kwargs, signature, demos, inputs):</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(inputs)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        system_content <span class="op">=</span> signature.instructions</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> demos:</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>            system_content</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>        messages <span class="op">=</span> [</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"role"</span>: <span class="st">"system"</span>, <span class="st">"content"</span>: system_content},</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: inputs[<span class="st">"prompt"</span>]},</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>        outputs <span class="op">=</span> lm(messages<span class="op">=</span>messages, <span class="op">**</span>lm_kwargs)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [{<span class="st">"generation"</span>: outputs[<span class="dv">0</span>]}]</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Do NOT call dspy.configure(adapter=SimplestAdapter())</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Subclass Predict to use the custom adapter only for this instance</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyPredict(dspy.Predict):</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, <span class="op">**</span>kwargs):</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>        adapter <span class="op">=</span> SimplestAdapter()</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> dspy.settings.context(adapter<span class="op">=</span>adapter):</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">super</span>().forward(<span class="op">**</span>kwargs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also have to subclass <code>dspy.Predict</code> so that we are able to make a program that uses our adapter. Usually in DSPy, the adapter is set globally or within a scoped context, but in both cases, the adapter is applied recursively. This has the effect of making some DSPy programs inside the optimizer use our simple adapter, causing them all to break. And breaking everything is generally not good…</p>
<div id="2129649e" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>my_program <span class="op">=</span> MyPredict(signature)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="automatically-generating-a-system-prompt" class="level2">
<h2 class="anchored" data-anchor-id="automatically-generating-a-system-prompt">Automatically Generating a System Prompt</h2>
<p>We are now ready to run the optimizer!!!</p>
<section id="letting-miprov2-write-the-system-prompt" class="level3">
<h3 class="anchored" data-anchor-id="letting-miprov2-write-the-system-prompt">Letting MIPROv2 write the System Prompt</h3>
<div id="d5292255" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> dspy.MIPROv2(translation_judge, max_bootstrapped_demos <span class="op">=</span> <span class="dv">0</span>, max_labeled_demos <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>my_program_optimized <span class="op">=</span> optimizer.<span class="bu">compile</span>(my_program, trainset<span class="op">=</span>trainset, requires_permission_to_run <span class="op">=</span> <span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s test the program right away:</p>
<div id="f302ad70" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>my_program_optimized(prompt <span class="op">=</span> <span class="st">"Hello, how are you?"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'prompt': 'Hello, how are you?'}</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>Prediction(
    generation='Salut, ça va-tu ben?'
)</code></pre>
</div>
</div>
<p>Good! It’s a translation and not a response to our salutation. Let’s inspect the messages.</p>
<div id="ff58d317" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>my_program_optimized.inspect_history()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>



[2025-07-23T09:24:44.063939]

System message:

You are a seasoned Québécois street linguist who grew up in Montréal’s Plateau-Mile End. Your job is to translate the user’s colloquial North-American English sentence into equally relaxed, idiomatic Québec French. Preserve every ounce of slang, contraction, and colourful swear word that a native speaker would use at the dépanneur counter on a Friday night. Keep the same tone, brevity, and punch as the original—no extra formality, no explanations, just the straight-up spoken French you’d hear in a Montréal alleyway.


User message:

Hello, how are you?


Response:

Salut, ça va-tu ben?




</code></pre>
</div>
</div>
<p>And this confirms that our adapter works! this is a completely ‘vanilla’ set of messages.</p>
</section>
<section id="using-llm-in-the-metric" class="level3">
<h3 class="anchored" data-anchor-id="using-llm-in-the-metric">Using LLM in the Metric</h3>
<p>Here we redefine our <code>translation_judge</code>, so that instead of using Python code to calculate a score between 0 and 1 we ask an LLM to do that.</p>
<p>In this case, we are using DSPy in it’s most natural way! So first we define a signature by subclassing <code>dspy.Signature</code>.</p>
<p>The doc string there is instruction that the adapter will put in a system prompt. The InputField are those we will pass to the program and the OutField are those that the program will return, in the case of <code>score: int = dspy.OutputField(desc="A single integer from 1 to 5.")</code> dspy will ensure and parse the integer out of the llm generated string for us. If an int is not provided, DSPy will even retry for us, and try different adapters.</p>
<div id="dfd2a8c4" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> QuebecTranslationJudge(dspy.Signature):</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""You are an expert Quebec French linguist. For each English sentence and its proposed French translation, evaluate the translation on a scale of 1 to 5 based on the following criteria, with 5 being a perfect, natural-sounding translation.</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co">1.  **Accuracy**: Does the French convey the same meaning as the English?</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co">2.  **Register**: Is the tone appropriately informal/colloquial (not formal textbook French)?</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co">3.  **Regional Vocabulary**: Does it use authentic Quebec French terms (e.g., "dépanneur", "frette", "char")?</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co">4.  **Contractions**: Are natural Quebec French contractions used (e.g., "j'va", "t'sais", "y fait")?</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="co">5.  **Proper Nouns &amp; Anglicisms**: Are names (e.g., "Tim's") and common anglicisms (e.g., "weekend") handled appropriately for Quebec French?</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="co">Provide brief feedback on any issues and output only the final numerical score.</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="co">IMPORTANT IF MEANING IS CHANGED SET TO 0.</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    english_sentence <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">"The original sentence in English."</span>)</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    french_translation <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">"The proposed translation in Quebec French."</span>)</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    feedback <span class="op">=</span> dspy.OutputField(desc<span class="op">=</span><span class="st">"Brief feedback on the translation's quality."</span>)</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    score: <span class="bu">int</span> <span class="op">=</span> dspy.OutputField(desc<span class="op">=</span><span class="st">"A single integer from 1 to 5."</span>)</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="co"># If you have a capable model configured globally, just do this:</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>llm_judge <span class="op">=</span> dspy.Predict(QuebecTranslationJudge)</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> translation_judge(example, prediction, trace<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a><span class="co">    An LLM-based metric that judges translation quality.</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a><span class="co">    It robustly parses the score and normalizes it to a 0.0-1.0 scale.</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    english_sentence <span class="op">=</span> example.prompt</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure the prediction's output is not empty</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>    french_translation <span class="op">=</span> prediction.get(<span class="st">"generation"</span>, <span class="st">""</span>)</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> french_translation:</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.0</span></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Call the LLM judge to get a score</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> llm_judge(</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>            english_sentence<span class="op">=</span>english_sentence,</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>            french_translation<span class="op">=</span>french_translation</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parse the score and normalize it to a 0.0-1.0 range</span></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (e.g., a score of 5 becomes 1.0, 1 becomes 0.2)</span></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>        score <span class="op">=</span> <span class="bu">float</span>(result.score)</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> score <span class="op">/</span> <span class="fl">5.0</span></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> (<span class="pp">ValueError</span>, <span class="pp">AttributeError</span>, <span class="pp">TypeError</span>):</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If the LLM fails to output a valid score, return 0.0</span></span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we have overwritten <code>translation_judge</code> let’s run the optimization again</p>
<div id="11168f32" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> dspy.MIPROv2(translation_judge, max_bootstrapped_demos <span class="op">=</span> <span class="dv">0</span>, max_labeled_demos <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>my_program_optimized <span class="op">=</span> optimizer.<span class="bu">compile</span>(my_program, trainset<span class="op">=</span>trainset, requires_permission_to_run <span class="op">=</span> <span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s test the program right away:</p>
<div id="356b2e4e" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>my_program_optimized(prompt <span class="op">=</span> <span class="st">"Hello, how are you?"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'prompt': 'Hello, how are you?'}</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>Prediction(
    generation='Salut, ça va-tu?'
)</code></pre>
</div>
</div>
<p>Good! It’s again a translation and not a response to our salutation. Let’s inspect the messages.</p>
<div id="48ce4382" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>my_program_optimized.inspect_history()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>



[2025-07-23T09:24:44.710386]

System message:

Translate the given colloquial North-American English sentence into natural, spoken Québec French. Preserve the tone, brevity, and regional flavor—use contractions, slang like “dépaneur”, and expressive modifiers such as “en maudit” where they fit naturally. Return only the French translation.


User message:

Hello, how are you?


Response:

Salut, ça va-tu?




</code></pre>
</div>
</div>
<p>And this confirms that our adapter works! this is a completely ‘vanilla’ set of messages.</p>
</section>
<section id="optimizing-with-few-shots-examples-too" class="level3">
<h3 class="anchored" data-anchor-id="optimizing-with-few-shots-examples-too">Optimizing with Few-Shots Examples too</h3>
<p>Let’s, now, make it possible for MIPROv2 to also add few-shots example into the system prompt.</p>
<p>For this we need to improve our simple adapter to have a way to format the demos. So we first define <code>format_demos</code>, this is a normal Python function that will expect a list of dspy Examples and turn that into a simple string with a light XML structure.</p>
<div id="d6076ea1" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> format_demos(demos):</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Wrap every demo once – no duplicated header lines.</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    parts <span class="op">=</span> [<span class="st">"Here are examples of your expected behavior."</span>,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>             <span class="st">"&lt;examples&gt;"</span>]</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, demo <span class="kw">in</span> <span class="bu">enumerate</span>(demos, <span class="dv">1</span>):</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>        parts <span class="op">+=</span> [</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"&lt;example_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">&gt;"</span>,</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">"User:"</span>,</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>            demo[<span class="st">"prompt"</span>],</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Assistant:"</span>,</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>            demo[<span class="st">"generation"</span>],</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"&lt;/example_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">&gt;"</span>,</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    parts.append(<span class="st">"&lt;/examples&gt;"</span>)</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(parts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s try it:</p>
<div id="d6e63799" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>examples <span class="op">=</span> [</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"She's my girlfriend."</span>, generation<span class="op">=</span><span class="st">"C'est ma blonde."</span>),</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"It's snowing again."</span>, generation<span class="op">=</span><span class="st">"Il neige encore."</span>),</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(format_demos(examples))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Here are examples of your expected behavior.
&lt;examples&gt;
&lt;example_1&gt;
User:
She's my girlfriend.
Assistant:
C'est ma blonde.
&lt;/example_1&gt;
&lt;example_2&gt;
User:
It's snowing again.
Assistant:
Il neige encore.
&lt;/example_2&gt;
&lt;/examples&gt;</code></pre>
</div>
</div>
<p>And we need to update our <code>SimplestAdapter</code> with that line: <code>system_content += "\n" + format_demos(demos)</code>.</p>
<div id="23a6eca0" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the SimplestAdapter as before</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SimplestAdapter(dspy.Adapter):</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, lm, lm_kwargs, signature, demos, inputs):</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(inputs)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>        system_content <span class="op">=</span> signature.instructions</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> demos:</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>            system_content <span class="op">+=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> format_demos(demos)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>        messages <span class="op">=</span> [</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"role"</span>: <span class="st">"system"</span>, <span class="st">"content"</span>: system_content},</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: inputs[<span class="st">"prompt"</span>]},</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>        outputs <span class="op">=</span> lm(messages<span class="op">=</span>messages, <span class="op">**</span>lm_kwargs)</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [{<span class="st">"generation"</span>: outputs[<span class="dv">0</span>]}]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s run the optimization again but with <code>max_labeled_demos = 3</code> this time.</p>
<div id="b58ee003" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> dspy.MIPROv2(translation_judge, max_bootstrapped_demos <span class="op">=</span> <span class="dv">3</span>, max_labeled_demos <span class="op">=</span> <span class="dv">3</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>my_program_optimized <span class="op">=</span> optimizer.<span class="bu">compile</span>(my_program, trainset<span class="op">=</span>trainset, requires_permission_to_run <span class="op">=</span> <span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s test the program right away:</p>
<div id="4c31a62e" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>my_program_optimized(prompt <span class="op">=</span> <span class="st">"Hello, how are you?"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'prompt': 'Hello, how are you?'}</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>Prediction(
    generation='Salut, ça va?'
)</code></pre>
</div>
</div>
<p>Good! It’s again a translation and not a response to our salutation. Let’s inspect the messages.</p>
<div id="b785be4a" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>my_program_optimized.inspect_history()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>



[2025-07-23T09:24:46.576727]

System message:

Translate the following English sentence into colloquial Québec French exactly as it would be spoken in daily conversation. Preserve the tone, brevity, and any slang or contractions typical of spoken Québécois. Return only the French translation—no explanations, no quotation marks, no extra formatting.
Here are examples of your expected behavior.
&lt;examples&gt;
&lt;example_1&gt;
User:
I'm going to the convenience store.
Assistant:
J'm'en va au dépanneur.
&lt;/example_1&gt;
&lt;example_2&gt;
User:
We were stuck in traffic for two hours.
Assistant:
On était pognés dans le trafic pendant deux heures.
&lt;/example_2&gt;
&lt;example_3&gt;
User:
Can you help me move this weekend?
Assistant:
Tu peux m'aider à déménager ce weekend?
&lt;/example_3&gt;
&lt;/examples&gt;


User message:

Hello, how are you?


Response:

Salut, ça va?




</code></pre>
</div>
</div>
<p>Now our System Prompt also contains a few examples.</p>
</section>
<section id="changing-optimizer" class="level3">
<h3 class="anchored" data-anchor-id="changing-optimizer">Changing Optimizer</h3>
<p>We can easily change Optimizer, look this code now uses <code>SIMBA</code> instead of <code>MIPROv2</code></p>
<div id="58d2ff67" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> dspy.SIMBA(metric <span class="op">=</span> translation_judge, bsize <span class="op">=</span> <span class="dv">8</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>my_program_optimized <span class="op">=</span> optimizer.<span class="bu">compile</span>(my_program, trainset<span class="op">=</span>trainset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s check the results:</p>
<div id="164fb9b5" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>my_program_optimized(prompt <span class="op">=</span> <span class="st">"Hello, how are you?"</span>)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>my_program_optimized.inspect_history()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'prompt': 'Hello, how are you?'}




[2025-07-23T09:25:02.299351]

System message:

If the prompt contains a simple declarative sentence in English (like "They're celebrating their birthday."), then you should output a direct French translation of that exact sentence, not conversational filler or advice. Focus on translating the meaning word-for-word while maintaining proper French grammar and vocabulary.

If the prompt is an enthusiastic English sentence about something being cool or awesome, then you should translate it into informal, spoken Québec French rather than standard European French. Use colloquial expressions like "ben l'fun", "char" for "car", and "ce …-là" constructions to sound natural to a Québec audience.

If the prompt is any English sentence (even a neutral declarative one like "He's always bragging."), then you should translate it into informal Québec French: contract "il" to "y'", drop the article "le" to "l'", use colloquial expressions such as "tout l'temps" and "en train de", and pick Québec-specific verbs like "fanfaronner" instead of standard French "se vanter".

If the prompt is a neutral declarative sentence that mentions a specific clock time (e.g., "at 3", "at 7:30"), then you should render that time in the informal Québec-French way: use numerals followed by "h" (e.g., "3h", "7h30") instead of spelling out the hour in words.
Here are examples of your expected behavior.
&lt;examples&gt;
&lt;example_1&gt;
User:
Can you help me move this weekend?
Assistant:
Tu peux m’aider à déménager ce week-end ?
&lt;/example_1&gt;
&lt;/examples&gt;


User message:

Hello, how are you?


Response:

Salut, ça va ?




</code></pre>
</div>
</div>
<p>In the case of SIMBA, we can see that it gradually added instructions to the system prompt.</p>
</section>
<section id="teacher-student-optimization" class="level3">
<h3 class="anchored" data-anchor-id="teacher-student-optimization">Teacher-Student optimization</h3>
<p>Let’s now optimize a for a smaller model while still using <code>Kimi</code> to generate the system prompt.</p>
<p>We must now create another LM connection, let’s stay with groq for speed and to keep things simple.</p>
<div id="65009cc7" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>llama8b <span class="op">=</span> dspy.LM(<span class="st">"groq/llama-3.1-8b-instant"</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>my_program.set_lm(lm <span class="op">=</span> llama8b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, I have to add teacher argument to compile: <code>.compile(... teacher = kimi ...)</code>.</p>
<div id="c06e790b" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> dspy.MIPROv2(translation_judge, max_bootstrapped_demos <span class="op">=</span> <span class="dv">0</span>, max_labeled_demos <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>my_program_optimized <span class="op">=</span> optimizer.<span class="bu">compile</span>(my_program, trainset<span class="op">=</span>trainset, teacher <span class="op">=</span> kimi, requires_permission_to_run <span class="op">=</span> <span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s confirm that <code>my_program_optimized</code> is set to use Llama.</p>
<div id="2c5a14e3" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>my_program_optimized.lm.model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>'groq/llama-3.1-8b-instant'</code></pre>
</div>
</div>
<p>Indeed it is!</p>
<p>Let’s try it:</p>
<div id="02bd0f48" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>my_program_optimized(prompt <span class="op">=</span> <span class="st">"Hello, how are you?"</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>my_program_optimized.inspect_history()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'prompt': 'Hello, how are you?'}




[2025-07-23T09:25:03.478036]

System message:

Translate the following informal North-American English sentence into equally informal, colloquial Québec French. Preserve the brevity, tone, and intent of the original. Use authentic Québécois phrasing, contractions, regional slang (e.g., “dépaneur”, “char”), and swear intensifiers (“en maudit”) where appropriate. Do not add or omit information.


User message:

Hello, how are you?


Response:

Salut, comment ça va?




</code></pre>
</div>
</div>
<p>Cool so now we have Llama 3.1 8b as our translator :)</p>
</section>
<section id="bringing-it-all-together" class="level3">
<h3 class="anchored" data-anchor-id="bringing-it-all-together">Bringing it all together</h3>
<p>Let’s now make the <code>optimize()</code> function we envisionned at the beginning.</p>
<p>Here, I asked o3-pro to bring it all together for us, you’ll recognize its comment style.</p>
<div id="5c791dd7" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> optimize(</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>,</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    training_inputs: <span class="bu">list</span>[<span class="bu">str</span>],</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    training_outputs: <span class="bu">list</span>[<span class="bu">str</span>],</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    llm_judge,</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    system_prompt: <span class="bu">str</span> <span class="op">=</span> <span class="st">""</span>,</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    max_few_shots: <span class="bu">int</span> <span class="op">=</span> <span class="dv">0</span>,</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    teacher_model<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    student_model<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a><span class="co">    One‑stop helper that (1) turns parallel input / output lists into a DSPy</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="co">    training‑set, (2) builds / optimises a tiny translation programme, and</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="co">    (3) returns the auto‑generated system‑prompt (with optional few‑shot</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a><span class="co">    examples baked‑in).</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a><span class="co">    training_inputs, training_outputs : list[str]</span></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a><span class="co">        Parallel lists of user prompts and the desired assistant replies.</span></span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a><span class="co">    llm_judge : str | Callable</span></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a><span class="co">        Either a *string* with judging instructions **or** a fully‑formed</span></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a><span class="co">        `metric(example, prediction, trace)-&gt;float` callable.</span></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a><span class="co">    system_prompt : str, optional</span></span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a><span class="co">        A starting prompt to improve upon (default empty).</span></span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a><span class="co">    max_few_shots : int, optional</span></span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a><span class="co">        Upper‑bound on examples the optimiser may add to the prompt.</span></span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a><span class="co">    teacher_model, student_model : str | dspy.LM | None</span></span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a><span class="co">        Identifiers *or* `dspy.LM` objects.  If only one is given, we fall</span></span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a><span class="co">        back&nbsp;gracefully to the globally configured LM.</span></span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a><span class="co">    str</span></span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a><span class="co">        The final system‑prompt text, ready to feed any chat‑completion API.</span></span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 0 .  Basic validation                                              #</span></span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(training_inputs) <span class="op">!=</span> <span class="bu">len</span>(training_outputs):</span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"`training_inputs` and `training_outputs` must "</span></span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"have the same length."</span>)</span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1 .  Build the training set                                        #</span></span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a>    examples <span class="op">=</span> [</span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a>        dspy.Example(prompt<span class="op">=</span>inp, generation<span class="op">=</span>out)</span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> inp, out <span class="kw">in</span> <span class="bu">zip</span>(training_inputs, training_outputs, strict<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a>    trainset <span class="op">=</span> [ex.with_inputs(<span class="st">"prompt"</span>) <span class="cf">for</span> ex <span class="kw">in</span> examples]</span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb54-55"><a href="#cb54-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2 .  Build (or wrap) the metric                                    #</span></span>
<span id="cb54-56"><a href="#cb54-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb54-57"><a href="#cb54-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">callable</span>(llm_judge):</span>
<span id="cb54-58"><a href="#cb54-58" aria-hidden="true" tabindex="-1"></a>        translation_judge <span class="op">=</span> llm_judge</span>
<span id="cb54-59"><a href="#cb54-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb54-60"><a href="#cb54-60" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Dynamically build a judge signature around the instruction string.</span></span>
<span id="cb54-61"><a href="#cb54-61" aria-hidden="true" tabindex="-1"></a>        judge_instructions <span class="op">=</span> <span class="bu">str</span>(llm_judge).strip()</span>
<span id="cb54-62"><a href="#cb54-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-63"><a href="#cb54-63" aria-hidden="true" tabindex="-1"></a>        <span class="kw">class</span> _AutoJudge(dspy.Signature):</span>
<span id="cb54-64"><a href="#cb54-64" aria-hidden="true" tabindex="-1"></a>            <span class="co">"""{0}"""</span>.<span class="bu">format</span>(judge_instructions)</span>
<span id="cb54-65"><a href="#cb54-65" aria-hidden="true" tabindex="-1"></a>            english_sentence <span class="op">=</span> dspy.InputField()</span>
<span id="cb54-66"><a href="#cb54-66" aria-hidden="true" tabindex="-1"></a>            french_translation <span class="op">=</span> dspy.InputField()</span>
<span id="cb54-67"><a href="#cb54-67" aria-hidden="true" tabindex="-1"></a>            score: <span class="bu">int</span> <span class="op">=</span> dspy.OutputField(desc<span class="op">=</span><span class="st">"0&nbsp;=&nbsp;bad,&nbsp;1&nbsp;=&nbsp;good"</span>)</span>
<span id="cb54-68"><a href="#cb54-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-69"><a href="#cb54-69" aria-hidden="true" tabindex="-1"></a>        judge_predict <span class="op">=</span> dspy.Predict(_AutoJudge)</span>
<span id="cb54-70"><a href="#cb54-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-71"><a href="#cb54-71" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> translation_judge(example, prediction, trace<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb54-72"><a href="#cb54-72" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb54-73"><a href="#cb54-73" aria-hidden="true" tabindex="-1"></a>                result <span class="op">=</span> judge_predict(</span>
<span id="cb54-74"><a href="#cb54-74" aria-hidden="true" tabindex="-1"></a>                    english_sentence<span class="op">=</span>example.prompt,</span>
<span id="cb54-75"><a href="#cb54-75" aria-hidden="true" tabindex="-1"></a>                    french_translation<span class="op">=</span>prediction.get(<span class="st">"generation"</span>, <span class="st">""</span>)</span>
<span id="cb54-76"><a href="#cb54-76" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb54-77"><a href="#cb54-77" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="bu">float</span>(result.score)</span>
<span id="cb54-78"><a href="#cb54-78" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb54-79"><a href="#cb54-79" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="fl">0.0</span></span>
<span id="cb54-80"><a href="#cb54-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-81"><a href="#cb54-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb54-82"><a href="#cb54-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3 .  Prepare the LM objects                                        #</span></span>
<span id="cb54-83"><a href="#cb54-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb54-84"><a href="#cb54-84" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _to_lm(obj):</span>
<span id="cb54-85"><a href="#cb54-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> obj <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb54-86"><a href="#cb54-86" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb54-87"><a href="#cb54-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> obj <span class="cf">if</span> <span class="bu">isinstance</span>(obj, dspy.LM) <span class="cf">else</span> dspy.LM(obj)</span>
<span id="cb54-88"><a href="#cb54-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-89"><a href="#cb54-89" aria-hidden="true" tabindex="-1"></a>    teacher_lm <span class="op">=</span> _to_lm(teacher_model)</span>
<span id="cb54-90"><a href="#cb54-90" aria-hidden="true" tabindex="-1"></a>    student_lm <span class="op">=</span> _to_lm(student_model)</span>
<span id="cb54-91"><a href="#cb54-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-92"><a href="#cb54-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If the reader supplied no student, fall back to whatever DSPy is</span></span>
<span id="cb54-93"><a href="#cb54-93" aria-hidden="true" tabindex="-1"></a>    <span class="co"># already configured with; otherwise bind the student to our programme.</span></span>
<span id="cb54-94"><a href="#cb54-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> student_lm <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb54-95"><a href="#cb54-95" aria-hidden="true" tabindex="-1"></a>        active_lm <span class="op">=</span> student_lm</span>
<span id="cb54-96"><a href="#cb54-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb54-97"><a href="#cb54-97" aria-hidden="true" tabindex="-1"></a>        active_lm <span class="op">=</span> dspy.settings.get(<span class="st">"lm"</span>)  <span class="co"># may still be None → DSPy default</span></span>
<span id="cb54-98"><a href="#cb54-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-99"><a href="#cb54-99" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb54-100"><a href="#cb54-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4 .  Build the programme                                           #</span></span>
<span id="cb54-101"><a href="#cb54-101" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb54-102"><a href="#cb54-102" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> OptimSignature(dspy.Signature):</span>
<span id="cb54-103"><a href="#cb54-103" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""{0}"""</span>.<span class="bu">format</span>(system_prompt)</span>
<span id="cb54-104"><a href="#cb54-104" aria-hidden="true" tabindex="-1"></a>        prompt <span class="op">=</span> dspy.InputField()</span>
<span id="cb54-105"><a href="#cb54-105" aria-hidden="true" tabindex="-1"></a>        generation <span class="op">=</span> dspy.OutputField()</span>
<span id="cb54-106"><a href="#cb54-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-107"><a href="#cb54-107" aria-hidden="true" tabindex="-1"></a>    programme <span class="op">=</span> MyPredict(OptimSignature)</span>
<span id="cb54-108"><a href="#cb54-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> active_lm <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb54-109"><a href="#cb54-109" aria-hidden="true" tabindex="-1"></a>        programme.set_lm(active_lm)</span>
<span id="cb54-110"><a href="#cb54-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-111"><a href="#cb54-111" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb54-112"><a href="#cb54-112" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5 .  Run MIPRO‑v2                                                  #</span></span>
<span id="cb54-113"><a href="#cb54-113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb54-114"><a href="#cb54-114" aria-hidden="true" tabindex="-1"></a>    optimiser <span class="op">=</span> dspy.MIPROv2(</span>
<span id="cb54-115"><a href="#cb54-115" aria-hidden="true" tabindex="-1"></a>        translation_judge,</span>
<span id="cb54-116"><a href="#cb54-116" aria-hidden="true" tabindex="-1"></a>        max_bootstrapped_demos<span class="op">=</span>max_few_shots,</span>
<span id="cb54-117"><a href="#cb54-117" aria-hidden="true" tabindex="-1"></a>        max_labeled_demos<span class="op">=</span>max_few_shots,</span>
<span id="cb54-118"><a href="#cb54-118" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-119"><a href="#cb54-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-120"><a href="#cb54-120" aria-hidden="true" tabindex="-1"></a>    compile_kwargs <span class="op">=</span> <span class="bu">dict</span>(</span>
<span id="cb54-121"><a href="#cb54-121" aria-hidden="true" tabindex="-1"></a>        trainset<span class="op">=</span>trainset,</span>
<span id="cb54-122"><a href="#cb54-122" aria-hidden="true" tabindex="-1"></a>        requires_permission_to_run<span class="op">=</span><span class="va">False</span></span>
<span id="cb54-123"><a href="#cb54-123" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-124"><a href="#cb54-124" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> teacher_lm <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb54-125"><a href="#cb54-125" aria-hidden="true" tabindex="-1"></a>        compile_kwargs[<span class="st">"teacher"</span>] <span class="op">=</span> teacher_lm</span>
<span id="cb54-126"><a href="#cb54-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-127"><a href="#cb54-127" aria-hidden="true" tabindex="-1"></a>    tuned_prog <span class="op">=</span> optimiser.<span class="bu">compile</span>(programme, <span class="op">**</span>compile_kwargs)</span>
<span id="cb54-128"><a href="#cb54-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-129"><a href="#cb54-129" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb54-130"><a href="#cb54-130" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 6 .  Extract the finished prompt&nbsp;(+ optional demos)                #</span></span>
<span id="cb54-131"><a href="#cb54-131" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb54-132"><a href="#cb54-132" aria-hidden="true" tabindex="-1"></a>    final_prompt <span class="op">=</span> tuned_prog.signature.instructions.strip()</span>
<span id="cb54-133"><a href="#cb54-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-134"><a href="#cb54-134" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">getattr</span>(tuned_prog, <span class="st">"demos"</span>, <span class="va">None</span>):</span>
<span id="cb54-135"><a href="#cb54-135" aria-hidden="true" tabindex="-1"></a>        final_prompt <span class="op">+=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> format_demos(tuned_prog.demos)</span>
<span id="cb54-136"><a href="#cb54-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-137"><a href="#cb54-137" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> final_prompt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s use it:</p>
<div id="ce84b955" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>optimized_system_prompt <span class="op">=</span> optimize(</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    training_inputs<span class="op">=</span>[</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"I'm going to the convenience store."</span>,</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"It's really cold out today."</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    training_outputs<span class="op">=</span>[</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Je m'en vais au dépanneur."</span>,</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Il fait frette en maudit aujourd'hui."</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    llm_judge<span class="op">=</span><span class="st">"Return 1 if the French looks natural and 0 otherwise."</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s see what system prompt we got:</p>
<div id="0e315186" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(optimized_system_prompt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>You are an expert Canadian-French translator who specializes in ultra-casual, idiomatic language.  
Given a short English sentence or phrase (the `prompt`), produce its Canadian-French equivalent (`generation`) that is just as informal and succinct. Preserve slang, contractions, and the exact tone of the original—no extra formality, no extra words.</code></pre>
</div>
</div>
<p>Not bad! Let’s test with all the parameters:</p>
<div id="5b78f17a" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>optimized_system_prompt <span class="op">=</span> optimize(</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    training_inputs<span class="op">=</span>[</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"I'm going to the convenience store."</span>,</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"It's really cold out today."</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    training_outputs<span class="op">=</span>[</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Je m'en vais au dépanneur."</span>,</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Il fait frette en maudit aujourd'hui."</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>    llm_judge<span class="op">=</span><span class="st">"Return 1 if the French looks natural and French Canadian and 0 otherwise."</span>,</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>    system_prompt <span class="op">=</span> <span class="st">"Translate from english to french"</span>,</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>    max_few_shots <span class="op">=</span> <span class="dv">2</span>,</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>    teacher_model <span class="op">=</span> <span class="st">"groq/moonshotai/kimi-k2-instruct"</span>,</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>    student_model <span class="op">=</span> <span class="st">"groq/llama-3.1-8b-instant"</span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And let’s see what we got:</p>
<div id="6423d988" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(optimized_system_prompt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>You are a bilingual Canadian-French speaker who translates casual English into the colloquial, idiomatic French used in everyday Québec conversations.  Given the prompt (an English sentence or short paragraph), return the generation: its natural-sounding, equally informal Canadian-French equivalent, keeping the same register, brevity, and tone.</code></pre>
</div>
</div>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/maximerivest\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb61" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Hacking DSPy into doing Automatic System Prompt Optimization"</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2025-07-21</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> Maxime Rivest</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "In this tutorial, I will show you how to make DSPy optimize a System Prompt Automatically."</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="an">draft:</span><span class="co"> false</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-location: right</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a><span class="co">    reference-location: margin</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a><span class="an">include-in-header:</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a><span class="co">  text: |</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;style&gt;</span></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a><span class="co">    .cell-output-stdout {</span></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a><span class="co">      overflow-y: scroll;</span></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a><span class="co">      max-height: 300px;</span></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a><span class="co">    }</span></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;/style&gt;</span></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a><span class="an">title-block-banner:</span><span class="co"> false</span></span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a><span class="an">title-block-style:</span><span class="co"> none</span></span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true  </span></span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a><span class="co">  cache: true</span></span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a><span class="co">  #freeze: true</span></span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setting up</span></span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a>For this tutorial, you will only need to install dspy and setup a LLM connections. I will be using several LLMs to demonstrate how easy it is to switch between them and show the student/teacher concept. You can however set only one up if you want. If you use a locally hosted model, (you can!) simply skip the setting up of the API key. .</span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-34"><a href="#cb61-34" aria-hidden="true" tabindex="-1"></a>For this tutorial, I have will use Kimi-K2 hosted by Groq <span class="co">[</span><span class="ot">Click here to get a groq api key</span><span class="co">](https://console.groq.com/keys)</span> and Llama models from OpenRouter <span class="co">[</span><span class="ot">Click here to get a OpenRouter key</span><span class="co">](https://openrouter.ai/settings/keys)</span>.</span>
<span id="cb61-35"><a href="#cb61-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-36"><a href="#cb61-36" aria-hidden="true" tabindex="-1"></a>::: {.callout-note icon=false appearance="simple" collapse="true"}</span>
<span id="cb61-37"><a href="#cb61-37" aria-hidden="true" tabindex="-1"></a><span class="fu">## python library requirements</span></span>
<span id="cb61-38"><a href="#cb61-38" aria-hidden="true" tabindex="-1"></a>I like to use uv to install my libraries.</span>
<span id="cb61-39"><a href="#cb61-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-42"><a href="#cb61-42" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-43"><a href="#cb61-43" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb61-44"><a href="#cb61-44" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb61-45"><a href="#cb61-45" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: ""</span></span>
<span id="cb61-46"><a href="#cb61-46" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>uv pip install dspy<span class="op">&gt;=</span><span class="fl">2.6.27</span></span>
<span id="cb61-47"><a href="#cb61-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-48"><a href="#cb61-48" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-49"><a href="#cb61-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-50"><a href="#cb61-50" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb61-51"><a href="#cb61-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-52"><a href="#cb61-52" aria-hidden="true" tabindex="-1"></a>::: {.callout-note icon=false appearance="simple" collapse="true"}</span>
<span id="cb61-53"><a href="#cb61-53" aria-hidden="true" tabindex="-1"></a><span class="fu">## api key setup</span></span>
<span id="cb61-54"><a href="#cb61-54" aria-hidden="true" tabindex="-1"></a>I generally setup my key permanently but you can also do this to set it up just for here and now.</span>
<span id="cb61-55"><a href="#cb61-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-56"><a href="#cb61-56" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-57"><a href="#cb61-57" aria-hidden="true" tabindex="-1"></a><span class="in">import os</span></span>
<span id="cb61-58"><a href="#cb61-58" aria-hidden="true" tabindex="-1"></a><span class="in">os.environ["GROQ_API_KEY"] = "[REDACTED]"</span></span>
<span id="cb61-59"><a href="#cb61-59" aria-hidden="true" tabindex="-1"></a><span class="in">os.environ["OPENROUTER_API_KEY"] = "[REDACTED]"</span></span>
<span id="cb61-60"><a href="#cb61-60" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-61"><a href="#cb61-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-62"><a href="#cb61-62" aria-hidden="true" tabindex="-1"></a>::: {.callout-note icon=false appearance="simple" collapse="true"}</span>
<span id="cb61-63"><a href="#cb61-63" aria-hidden="true" tabindex="-1"></a><span class="fu">## Make GROQ_API_KEY permanent</span></span>
<span id="cb61-64"><a href="#cb61-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-65"><a href="#cb61-65" aria-hidden="true" tabindex="-1"></a>Replace GROQ_API_KEY with OPENROUTER_API_KEY to set openrouter key permanently on your system.</span>
<span id="cb61-66"><a href="#cb61-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-67"><a href="#cb61-67" aria-hidden="true" tabindex="-1"></a><span class="fu">###### Linux / macOS</span></span>
<span id="cb61-68"><a href="#cb61-68" aria-hidden="true" tabindex="-1"></a>Append to your shell start-up file (pick the one you actually use):</span>
<span id="cb61-69"><a href="#cb61-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-70"><a href="#cb61-70" aria-hidden="true" tabindex="-1"></a><span class="in">```bash</span></span>
<span id="cb61-71"><a href="#cb61-71" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"export GROQ_API_KEY='gsk_[REDACTED]'"</span> <span class="op">&gt;&gt;</span> ~/.bashrc</span>
<span id="cb61-72"><a href="#cb61-72" aria-hidden="true" tabindex="-1"></a><span class="co"># or ~/.zshrc, ~/.profile, etc.</span></span>
<span id="cb61-73"><a href="#cb61-73" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> ~/.bashrc   <span class="co"># reload once</span></span>
<span id="cb61-74"><a href="#cb61-74" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-75"><a href="#cb61-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-76"><a href="#cb61-76" aria-hidden="true" tabindex="-1"></a><span class="fu">###### Windows – CMD</span></span>
<span id="cb61-77"><a href="#cb61-77" aria-hidden="true" tabindex="-1"></a><span class="in">```cmd</span></span>
<span id="cb61-78"><a href="#cb61-78" aria-hidden="true" tabindex="-1"></a><span class="in">setx GROQ_API_KEY "gsk_[REDACTED]"</span></span>
<span id="cb61-79"><a href="#cb61-79" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-80"><a href="#cb61-80" aria-hidden="true" tabindex="-1"></a>Close and reopen the terminal.</span>
<span id="cb61-81"><a href="#cb61-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-82"><a href="#cb61-82" aria-hidden="true" tabindex="-1"></a><span class="fu">###### Windows – PowerShell</span></span>
<span id="cb61-83"><a href="#cb61-83" aria-hidden="true" tabindex="-1"></a><span class="in">```powershell</span></span>
<span id="cb61-84"><a href="#cb61-84" aria-hidden="true" tabindex="-1"></a><span class="in">[Environment]::SetEnvironmentVariable("GROQ_API_KEY", "gsk_[REDACTED]", "User")</span></span>
<span id="cb61-85"><a href="#cb61-85" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-86"><a href="#cb61-86" aria-hidden="true" tabindex="-1"></a>Refresh with <span class="in">`refreshenv`</span> or open a new window.</span>
<span id="cb61-87"><a href="#cb61-87" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb61-88"><a href="#cb61-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-89"><a href="#cb61-89" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb61-90"><a href="#cb61-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-91"><a href="#cb61-91" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb61-92"><a href="#cb61-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-93"><a href="#cb61-93" aria-hidden="true" tabindex="-1"></a><span class="fu">## Making an automatic System Prompt tool</span></span>
<span id="cb61-94"><a href="#cb61-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-95"><a href="#cb61-95" aria-hidden="true" tabindex="-1"></a>In this tutorial, I’ll show you how I’ve modified and customized DSPy to make it handle system prompt optimization. Usually DSPy is doing program optimization. DSPy is very much batteries included, giving you tons of tools for everything. It’s general, and it gives you a framework for how to do things, which is powerful and useful. But that framework is about AI programming, not about system prompt optimization. That is why we will need to do some customization to DSPy. Don't worry, DSPy was built in a way that lets us do it without too much work.</span>
<span id="cb61-96"><a href="#cb61-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-97"><a href="#cb61-97" aria-hidden="true" tabindex="-1"></a>The nice thing about having to customize DSPy is that by the end you'll walk away with two things. First, a way to automatically optimize system prompts. Second, you'll have opened the hood: you'll understand better how DSPy works and this will help you use DSPy more proficiently when you actually want to do AI programs.</span>
<span id="cb61-98"><a href="#cb61-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-99"><a href="#cb61-99" aria-hidden="true" tabindex="-1"></a>So by the end of this tutorial we will have built this simple yet powerful automatic system prompt optimization utility and understood why we had to do what we did.</span>
<span id="cb61-100"><a href="#cb61-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-101"><a href="#cb61-101" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-102"><a href="#cb61-102" aria-hidden="true" tabindex="-1"></a><span class="in">optimzed_system_prompt = optimize(</span></span>
<span id="cb61-103"><a href="#cb61-103" aria-hidden="true" tabindex="-1"></a><span class="in">    training_inputs = ["User prompt example 1", "...", "User prompt exampl n"],</span></span>
<span id="cb61-104"><a href="#cb61-104" aria-hidden="true" tabindex="-1"></a><span class="in">    training_outputs = ["Desirable Assistant's example 1", "...", "Desirable Assistant's example 1"],</span></span>
<span id="cb61-105"><a href="#cb61-105" aria-hidden="true" tabindex="-1"></a><span class="in">    llm_judge = "Return a 1 if it's good and a 0 if it's bad."</span></span>
<span id="cb61-106"><a href="#cb61-106" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb61-107"><a href="#cb61-107" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-108"><a href="#cb61-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-109"><a href="#cb61-109" aria-hidden="true" tabindex="-1"></a>Our <span class="in">`optimize`</span> function will also be able to optionally take a starting system prompt, a max few-shots, and teacher and student model identifiers. Here is a mock-up of that:</span>
<span id="cb61-110"><a href="#cb61-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-111"><a href="#cb61-111" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-112"><a href="#cb61-112" aria-hidden="true" tabindex="-1"></a><span class="in">optimzed_system_prompt = optimize(</span></span>
<span id="cb61-113"><a href="#cb61-113" aria-hidden="true" tabindex="-1"></a><span class="in">    training_inputs = ["User prompt example 1", "...", "User prompt exampl n"],</span></span>
<span id="cb61-114"><a href="#cb61-114" aria-hidden="true" tabindex="-1"></a><span class="in">    training_outputs = ["Desirable Assistant's example 1", "...", "Desirable Assistant's example 1"],</span></span>
<span id="cb61-115"><a href="#cb61-115" aria-hidden="true" tabindex="-1"></a><span class="in">    llm_judge = "Return a 1 if it's good and a 0 if it's bad.",</span></span>
<span id="cb61-116"><a href="#cb61-116" aria-hidden="true" tabindex="-1"></a><span class="in">    system_prompt = "You are a model that perform well...",</span></span>
<span id="cb61-117"><a href="#cb61-117" aria-hidden="true" tabindex="-1"></a><span class="in">    max_few_shots = 2,</span></span>
<span id="cb61-118"><a href="#cb61-118" aria-hidden="true" tabindex="-1"></a><span class="in">    teacher_model = "a-smart-model",</span></span>
<span id="cb61-119"><a href="#cb61-119" aria-hidden="true" tabindex="-1"></a><span class="in">    student_model = "a-cheap-model"</span></span>
<span id="cb61-120"><a href="#cb61-120" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb61-121"><a href="#cb61-121" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-122"><a href="#cb61-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-123"><a href="#cb61-123" aria-hidden="true" tabindex="-1"></a>Now that we have our vision, let's get going!</span>
<span id="cb61-124"><a href="#cb61-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-125"><a href="#cb61-125" aria-hidden="true" tabindex="-1"></a><span class="fu">## The task</span></span>
<span id="cb61-126"><a href="#cb61-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-127"><a href="#cb61-127" aria-hidden="true" tabindex="-1"></a>All throughout this tutorial our task will be to make an English to Quebec-French translator.</span>
<span id="cb61-128"><a href="#cb61-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-129"><a href="#cb61-129" aria-hidden="true" tabindex="-1"></a>The first DSPy optimizer that we want to use is <span class="in">`dspy.MIPROv2`</span>. This optimizer can write (or improve) a program's instructions. Let's analyze the code below to learn what parts we must prepare to reach that goal of running MIPROv2 on task.</span>
<span id="cb61-130"><a href="#cb61-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-131"><a href="#cb61-131" aria-hidden="true" tabindex="-1"></a>First we pass <span class="in">`translation_judge`</span> to the optimizer initialisation. This should be a function that must return a score between 0 (bad) to 1 (good). In DSPy these are called metrics. Almost every DSPy optimizer requires a metric. After we have 2 <span class="in">`max_..._demos`</span> which are set to 0, this is because as a first run we would like to only optimise the text of the system prompt without adding few-shot examples. MIPROv2 can search for few-shot examples that would improve a program's performance.</span>
<span id="cb61-132"><a href="#cb61-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-133"><a href="#cb61-133" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-134"><a href="#cb61-134" aria-hidden="true" tabindex="-1"></a><span class="in">optimizer = dspy.MIPROv2(translation_judge, max_bootstrapped_demos = 0, max_labeled_demos = 0)</span></span>
<span id="cb61-135"><a href="#cb61-135" aria-hidden="true" tabindex="-1"></a><span class="in">my_program_optimized = optimizer.compile(my_program, trainset=trainset)</span></span>
<span id="cb61-136"><a href="#cb61-136" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-137"><a href="#cb61-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-138"><a href="#cb61-138" aria-hidden="true" tabindex="-1"></a>Second line of code, inside the <span class="in">`compile`</span> method, we must give a DSPy <span class="in">`program`</span>. This is not a string; it cannot be a system prompt. We will thus need to wrap up our system prompt + user/assistant simple LLM call into a lightweight program. And, finally, we have the trainset. In DSPy, this must be a list of <span class="in">`dspy.Example`</span> objects. This is the object that all of DSPy's internals are using, so there is no way around it; we must format our input/output training set as <span class="in">`dspy.Example`</span>.</span>
<span id="cb61-139"><a href="#cb61-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-140"><a href="#cb61-140" aria-hidden="true" tabindex="-1"></a>In summary, we need:</span>
<span id="cb61-141"><a href="#cb61-141" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>a metric</span>
<span id="cb61-142"><a href="#cb61-142" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>a program</span>
<span id="cb61-143"><a href="#cb61-143" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>a training set</span>
<span id="cb61-144"><a href="#cb61-144" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-145"><a href="#cb61-145" aria-hidden="true" tabindex="-1"></a>and we must format those appropriately.</span>
<span id="cb61-146"><a href="#cb61-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-147"><a href="#cb61-147" aria-hidden="true" tabindex="-1"></a>Let's first tackle the training set as it is quite straightforward</span>
<span id="cb61-148"><a href="#cb61-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-149"><a href="#cb61-149" aria-hidden="true" tabindex="-1"></a><span class="fu">## Training set</span></span>
<span id="cb61-150"><a href="#cb61-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-151"><a href="#cb61-151" aria-hidden="true" tabindex="-1"></a>The <span class="in">`Example()`</span> object can take any arguments. You can think of those as column names in a dataframe or "keys" in JSON. It is usually pretty important to consider these names thoughtfully and normally DSPy will present them to the LLM as part of the prompts. In our case, that is a behavior from DSPy that we will change, so it does not matter what we call them. I decided to go with something very general. The <span class="in">`prompt`</span> will be the user message and the <span class="in">`generation`</span> will be the assistant message.</span>
<span id="cb61-152"><a href="#cb61-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-155"><a href="#cb61-155" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-156"><a href="#cb61-156" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dspy</span>
<span id="cb61-157"><a href="#cb61-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-158"><a href="#cb61-158" aria-hidden="true" tabindex="-1"></a>examples <span class="op">=</span> [</span>
<span id="cb61-159"><a href="#cb61-159" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"I'm going to the convenience store."</span>, generation<span class="op">=</span><span class="st">"Je m'en vais au dépanneur."</span>),</span>
<span id="cb61-160"><a href="#cb61-160" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"It's really cold out today."</span>, generation<span class="op">=</span><span class="st">"Il fait frette en maudit aujourd'hui."</span>),</span>
<span id="cb61-161"><a href="#cb61-161" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"Can you help me move this weekend?"</span>, generation<span class="op">=</span><span class="st">"Tu peux m'aider à déménager ce weekend?"</span>),</span>
<span id="cb61-162"><a href="#cb61-162" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"We were stuck in traffic for two hours."</span>, generation<span class="op">=</span><span class="st">"On était pognés dans le trafic pendant deux heures."</span>),</span>
<span id="cb61-163"><a href="#cb61-163" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"She's my girlfriend."</span>, generation<span class="op">=</span><span class="st">"C'est ma blonde."</span>),</span>
<span id="cb61-164"><a href="#cb61-164" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"That car is so cool!"</span>, generation<span class="op">=</span><span class="st">"C'est ben l'fun ce char-là!"</span>),</span>
<span id="cb61-165"><a href="#cb61-165" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"I'll call you tonight."</span>, generation<span class="op">=</span><span class="st">"Je vais t'appeler ce soir."</span>),</span>
<span id="cb61-166"><a href="#cb61-166" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"He's always bragging."</span>, generation<span class="op">=</span><span class="st">"Il se vente tout l'temps."</span>),</span>
<span id="cb61-167"><a href="#cb61-167" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"We grabbed a coffee at Tim's."</span>, generation<span class="op">=</span><span class="st">"On a pris un café au Tim."</span>),</span>
<span id="cb61-168"><a href="#cb61-168" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"Close the window, it's chilly."</span>, generation<span class="op">=</span><span class="st">"Ferme la fenêtre, y fait frette."</span>),</span>
<span id="cb61-169"><a href="#cb61-169" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"I have an appointment at 3."</span>, generation<span class="op">=</span><span class="st">"J'ai un rendez-vous à trois heures."</span>),</span>
<span id="cb61-170"><a href="#cb61-170" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"They're celebrating their birthday."</span>, generation<span class="op">=</span><span class="st">"Ils fêtent leur fête."</span>),</span>
<span id="cb61-171"><a href="#cb61-171" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"I parked in the back."</span>, generation<span class="op">=</span><span class="st">"J'ai stationné dans l'fond."</span>),</span>
<span id="cb61-172"><a href="#cb61-172" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"The metro is packed."</span>, generation<span class="op">=</span><span class="st">"Le métro est plein à craquer."</span>),</span>
<span id="cb61-173"><a href="#cb61-173" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"We watched a movie last night."</span>, generation<span class="op">=</span><span class="st">"On a écouté un film hier soir."</span>),</span>
<span id="cb61-174"><a href="#cb61-174" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"I need to do my groceries."</span>, generation<span class="op">=</span><span class="st">"J'dois faire mon épicerie."</span>),</span>
<span id="cb61-175"><a href="#cb61-175" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"Don't forget your boots."</span>, generation<span class="op">=</span><span class="st">"Oublie pas tes bottes."</span>),</span>
<span id="cb61-176"><a href="#cb61-176" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"It's snowing again."</span>, generation<span class="op">=</span><span class="st">"Il neige encore."</span>),</span>
<span id="cb61-177"><a href="#cb61-177" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"I'll take the bus."</span>, generation<span class="op">=</span><span class="st">"J'va prendre l'bus."</span>),</span>
<span id="cb61-178"><a href="#cb61-178" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"We're out of milk."</span>, generation<span class="op">=</span><span class="st">"On est à court de lait."</span>),</span>
<span id="cb61-179"><a href="#cb61-179" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb61-180"><a href="#cb61-180" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-181"><a href="#cb61-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-182"><a href="#cb61-182" aria-hidden="true" tabindex="-1"></a>Before we are done with our training set we must do 1 more little thing:</span>
<span id="cb61-183"><a href="#cb61-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-186"><a href="#cb61-186" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-187"><a href="#cb61-187" aria-hidden="true" tabindex="-1"></a>trainset <span class="op">=</span> [x.with_inputs(<span class="st">'prompt'</span>) <span class="cf">for</span> x <span class="kw">in</span> examples]</span>
<span id="cb61-188"><a href="#cb61-188" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-189"><a href="#cb61-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-190"><a href="#cb61-190" aria-hidden="true" tabindex="-1"></a>This, again, is something we have to do because of DSPy's general powerful nature. Briefly, it is used by DSPy's code internally to know what fields of the Example object are input fields for the LLM. It helps internal development to separate inputs from outputs. In our case, we just need to know that we have to do it, and so we do.</span>
<span id="cb61-191"><a href="#cb61-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-192"><a href="#cb61-192" aria-hidden="true" tabindex="-1"></a>Let's move on to the Metric now!</span>
<span id="cb61-193"><a href="#cb61-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-194"><a href="#cb61-194" aria-hidden="true" tabindex="-1"></a><span class="fu">## Metric</span></span>
<span id="cb61-195"><a href="#cb61-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-196"><a href="#cb61-196" aria-hidden="true" tabindex="-1"></a>Our first metric will be somewhat dumb and a little bit bad. That is because it is hard to have code that measures the quality of a translation. Despite that, we will get pretty good results, you will see.</span>
<span id="cb61-197"><a href="#cb61-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-198"><a href="#cb61-198" aria-hidden="true" tabindex="-1"></a>In essence, all this code does is search for some very common French words that are not also common English words. If any of the words are found, the function returns a 1; otherwise it returns a 0.</span>
<span id="cb61-199"><a href="#cb61-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-202"><a href="#cb61-202" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-203"><a href="#cb61-203" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb61-204"><a href="#cb61-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-205"><a href="#cb61-205" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_french(text):</span>
<span id="cb61-206"><a href="#cb61-206" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Naive French detector: check for common French words/accents</span></span>
<span id="cb61-207"><a href="#cb61-207" aria-hidden="true" tabindex="-1"></a>    french_markers <span class="op">=</span> [</span>
<span id="cb61-208"><a href="#cb61-208" aria-hidden="true" tabindex="-1"></a>        <span class="vs">r"\b(le|la|les|un|une|des|du|de|et|à|est|sont|avec|pour|sur|par|mais|ou|où|que|qui|quand|comment|nous|vous|ils|elles|ça|ce|cette|ces)\b"</span>,</span>
<span id="cb61-209"><a href="#cb61-209" aria-hidden="true" tabindex="-1"></a>        <span class="vs">r"[éèêàùçîôâœëïü]"</span>,</span>
<span id="cb61-210"><a href="#cb61-210" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb61-211"><a href="#cb61-211" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">any</span>(re.search(marker, text.lower()) <span class="cf">for</span> marker <span class="kw">in</span> french_markers)</span>
<span id="cb61-212"><a href="#cb61-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-213"><a href="#cb61-213" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> translation_judge(example, prediction, trace<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb61-214"><a href="#cb61-214" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb61-215"><a href="#cb61-215" aria-hidden="true" tabindex="-1"></a><span class="co">    Return 1.0 if the output looks French, else 0.0.</span></span>
<span id="cb61-216"><a href="#cb61-216" aria-hidden="true" tabindex="-1"></a><span class="co">    Doing the cast explicitly guarantees we never hand DSPy a None.</span></span>
<span id="cb61-217"><a href="#cb61-217" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb61-218"><a href="#cb61-218" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> prediction.get(<span class="st">"generation"</span>, <span class="st">""</span>) <span class="kw">or</span> <span class="st">""</span></span>
<span id="cb61-219"><a href="#cb61-219" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb61-220"><a href="#cb61-220" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">float</span>(is_french(output))</span>
<span id="cb61-221"><a href="#cb61-221" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb61-222"><a href="#cb61-222" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Anything weird is just a miss</span></span>
<span id="cb61-223"><a href="#cb61-223" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.0</span></span>
<span id="cb61-224"><a href="#cb61-224" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-225"><a href="#cb61-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-226"><a href="#cb61-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-227"><a href="#cb61-227" aria-hidden="true" tabindex="-1"></a>Notice how <span class="in">`translation_judge`</span> takes 3 arguments: <span class="in">`example`</span>, <span class="in">`prediction`</span>, and <span class="in">`trace`</span>. </span>
<span id="cb61-228"><a href="#cb61-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-229"><a href="#cb61-229" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`example`</span> will essentially be an instance of the <span class="in">`Example()`</span> object as we defined above. </span>
<span id="cb61-230"><a href="#cb61-230" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`prediction`</span> will be the parsed LLM output. Usually DSPy can do a lot here, but we will modify and simplify that part too.</span>
<span id="cb61-231"><a href="#cb61-231" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span><span class="in">`trace`</span> can be ignored except when we want models to generate good examples themselves. This is called bootstrapping, and in that case, if <span class="in">`trace`</span> is not <span class="in">`None`</span>, we must return a boolean for whether the LLM-generated example is good (1) or not (0). This could be used, for instance, to make our list of translation pairs longer.</span>
<span id="cb61-232"><a href="#cb61-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-233"><a href="#cb61-233" aria-hidden="true" tabindex="-1"></a>Moving on the the program now!</span>
<span id="cb61-234"><a href="#cb61-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-235"><a href="#cb61-235" aria-hidden="true" tabindex="-1"></a><span class="fu">## Program</span></span>
<span id="cb61-236"><a href="#cb61-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-237"><a href="#cb61-237" aria-hidden="true" tabindex="-1"></a>The simplest program you can build in DSPy is one with only one input, one output, and empty instructions using <span class="in">`Predict`</span>. A core concept of DSPy is around that signature, but since we do not want to do program optimization I'll not go into it (see <span class="co">[</span><span class="ot">this post</span><span class="co">](https://maximerivest.com/posts/dspy-one-hour-guide.html)</span> for a simple introduction to DSPy).</span>
<span id="cb61-238"><a href="#cb61-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-241"><a href="#cb61-241" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-242"><a href="#cb61-242" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> signature(dspy.Signature):</span>
<span id="cb61-243"><a href="#cb61-243" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" </span></span>
<span id="cb61-244"><a href="#cb61-244" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb61-245"><a href="#cb61-245" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb61-246"><a href="#cb61-246" aria-hidden="true" tabindex="-1"></a>    prompt <span class="op">=</span> dspy.InputField()</span>
<span id="cb61-247"><a href="#cb61-247" aria-hidden="true" tabindex="-1"></a>    generation <span class="op">=</span> dspy.OutputField()</span>
<span id="cb61-248"><a href="#cb61-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-249"><a href="#cb61-249" aria-hidden="true" tabindex="-1"></a>initial_program <span class="op">=</span> dspy.Predict(signature)</span>
<span id="cb61-250"><a href="#cb61-250" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-251"><a href="#cb61-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-252"><a href="#cb61-252" aria-hidden="true" tabindex="-1"></a>The most interesting part for you to note is that <span class="in">`initial_program`</span> is now callable, and if we call it, we will get an LLM response, provided we set up an LLM like this:</span>
<span id="cb61-253"><a href="#cb61-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-254"><a href="#cb61-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-257"><a href="#cb61-257" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-258"><a href="#cb61-258" aria-hidden="true" tabindex="-1"></a>kimi <span class="op">=</span> dspy.LM(<span class="st">"groq/moonshotai/kimi-k2-instruct"</span>)</span>
<span id="cb61-259"><a href="#cb61-259" aria-hidden="true" tabindex="-1"></a>dspy.configure(lm <span class="op">=</span> kimi)</span>
<span id="cb61-260"><a href="#cb61-260" aria-hidden="true" tabindex="-1"></a>initial_program(prompt <span class="op">=</span> <span class="st">"Hello, how are you?"</span>)</span>
<span id="cb61-261"><a href="#cb61-261" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-262"><a href="#cb61-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-263"><a href="#cb61-263" aria-hidden="true" tabindex="-1"></a>But we have a few problems.</span>
<span id="cb61-264"><a href="#cb61-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-267"><a href="#cb61-267" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-268"><a href="#cb61-268" aria-hidden="true" tabindex="-1"></a>initial_program.inspect_history()</span>
<span id="cb61-269"><a href="#cb61-269" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-270"><a href="#cb61-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-271"><a href="#cb61-271" aria-hidden="true" tabindex="-1"></a>The above command prints the previous interaction we had with the LLM. In that interaction, the system prompt was:</span>
<span id="cb61-272"><a href="#cb61-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-275"><a href="#cb61-275" aria-hidden="true" tabindex="-1"></a><span class="in">```{text}</span></span>
<span id="cb61-276"><a href="#cb61-276" aria-hidden="true" tabindex="-1"></a><span class="in">Your input fields are:</span></span>
<span id="cb61-277"><a href="#cb61-277" aria-hidden="true" tabindex="-1"></a><span class="in">1. `prompt` (str):</span></span>
<span id="cb61-278"><a href="#cb61-278" aria-hidden="true" tabindex="-1"></a><span class="in">Your output fields are:</span></span>
<span id="cb61-279"><a href="#cb61-279" aria-hidden="true" tabindex="-1"></a><span class="in">1. `generation` (str):</span></span>
<span id="cb61-280"><a href="#cb61-280" aria-hidden="true" tabindex="-1"></a><span class="in">All interactions will be structured in the following way, with the appropriate values filled in.</span></span>
<span id="cb61-281"><a href="#cb61-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-282"><a href="#cb61-282" aria-hidden="true" tabindex="-1"></a><span class="in">[[ ## prompt ## ]]</span></span>
<span id="cb61-283"><a href="#cb61-283" aria-hidden="true" tabindex="-1"></a><span class="in">{prompt}</span></span>
<span id="cb61-284"><a href="#cb61-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-285"><a href="#cb61-285" aria-hidden="true" tabindex="-1"></a><span class="in">[[ ## generation ## ]]</span></span>
<span id="cb61-286"><a href="#cb61-286" aria-hidden="true" tabindex="-1"></a><span class="in">{generation}</span></span>
<span id="cb61-287"><a href="#cb61-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-288"><a href="#cb61-288" aria-hidden="true" tabindex="-1"></a><span class="in">[[ ## completed ## ]]</span></span>
<span id="cb61-289"><a href="#cb61-289" aria-hidden="true" tabindex="-1"></a><span class="in">In adhering to this structure, your objective is:</span></span>
<span id="cb61-290"><a href="#cb61-290" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-291"><a href="#cb61-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-292"><a href="#cb61-292" aria-hidden="true" tabindex="-1"></a>And the user message was:</span>
<span id="cb61-293"><a href="#cb61-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-296"><a href="#cb61-296" aria-hidden="true" tabindex="-1"></a><span class="in">```{text}</span></span>
<span id="cb61-297"><a href="#cb61-297" aria-hidden="true" tabindex="-1"></a><span class="in">[[ ## prompt ## ]]</span></span>
<span id="cb61-298"><a href="#cb61-298" aria-hidden="true" tabindex="-1"></a><span class="in">Hello, how are you?</span></span>
<span id="cb61-299"><a href="#cb61-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-300"><a href="#cb61-300" aria-hidden="true" tabindex="-1"></a><span class="in">Respond with the corresponding output fields, starting with the field `[[ ## generation ## ]]`, and then ending with the marker for `[[ ## completed ## ]]`.</span></span>
<span id="cb61-301"><a href="#cb61-301" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-302"><a href="#cb61-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-303"><a href="#cb61-303" aria-hidden="true" tabindex="-1"></a>And the assistant was:</span>
<span id="cb61-304"><a href="#cb61-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-307"><a href="#cb61-307" aria-hidden="true" tabindex="-1"></a><span class="in">```{text}</span></span>
<span id="cb61-308"><a href="#cb61-308" aria-hidden="true" tabindex="-1"></a><span class="in">[[ ## generation ## ]]</span></span>
<span id="cb61-309"><a href="#cb61-309" aria-hidden="true" tabindex="-1"></a><span class="in">I'm doing well, thank you for asking! How can I help you today?</span></span>
<span id="cb61-310"><a href="#cb61-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-311"><a href="#cb61-311" aria-hidden="true" tabindex="-1"></a><span class="in">[[ ## completed ## ]]</span></span>
<span id="cb61-312"><a href="#cb61-312" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-313"><a href="#cb61-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-314"><a href="#cb61-314" aria-hidden="true" tabindex="-1"></a>A lot of stuff was added, and if we run an optimizer as it is, we will be optimizing the LLM's performance in that prompt template. This is a little too different from the vanilla we would have expected, which is:</span>
<span id="cb61-315"><a href="#cb61-315" aria-hidden="true" tabindex="-1"></a><span class="in">`sp = ""`</span>,</span>
<span id="cb61-316"><a href="#cb61-316" aria-hidden="true" tabindex="-1"></a><span class="in">`user = "Hello, how are you?"`</span>,</span>
<span id="cb61-317"><a href="#cb61-317" aria-hidden="true" tabindex="-1"></a>and the assistant response could have been something like</span>
<span id="cb61-318"><a href="#cb61-318" aria-hidden="true" tabindex="-1"></a><span class="in">`assistant = "I'm doing well, thank you for asking! How can I help you today?"`</span>.</span>
<span id="cb61-319"><a href="#cb61-319" aria-hidden="true" tabindex="-1"></a>The culprit for the additions is DSPy's adapter. The adapter is amazing at turning a DSPy signature into an AI program, but right now, it's in the way.</span>
<span id="cb61-320"><a href="#cb61-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-321"><a href="#cb61-321" aria-hidden="true" tabindex="-1"></a>Let's replace DSPy's adapter with our own simplified version.</span>
<span id="cb61-322"><a href="#cb61-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-323"><a href="#cb61-323" aria-hidden="true" tabindex="-1"></a><span class="fu">## Making a Simple Custom Adapter</span></span>
<span id="cb61-324"><a href="#cb61-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-325"><a href="#cb61-325" aria-hidden="true" tabindex="-1"></a>Adapters are DSPy's interface to the LLMs. They are called with a few pieces of information, and DSPy expects a parsed LLM generation to be returned. The following is the simplest we can make an adapter. We are taking in the LM that DSPy's internals want us to use, keyword arguments if any, a signature, demos, and inputs.</span>
<span id="cb61-326"><a href="#cb61-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-327"><a href="#cb61-327" aria-hidden="true" tabindex="-1"></a>The signature can contain only 3 things: instructions, inputs, and outputs. In our case, we have "canned" the signature, so we also know that the input is named <span class="in">`prompt`</span> and the output is named <span class="in">`generation`</span>, simplifying our requirements for our adapter substantially from what DSPy usually has to worry about.</span>
<span id="cb61-328"><a href="#cb61-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-329"><a href="#cb61-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-332"><a href="#cb61-332" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-333"><a href="#cb61-333" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the SimplestAdapter as before</span></span>
<span id="cb61-334"><a href="#cb61-334" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SimplestAdapter(dspy.Adapter):</span>
<span id="cb61-335"><a href="#cb61-335" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, lm, lm_kwargs, signature, demos, inputs):</span>
<span id="cb61-336"><a href="#cb61-336" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(inputs)</span>
<span id="cb61-337"><a href="#cb61-337" aria-hidden="true" tabindex="-1"></a>        system_content <span class="op">=</span> signature.instructions</span>
<span id="cb61-338"><a href="#cb61-338" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> demos:</span>
<span id="cb61-339"><a href="#cb61-339" aria-hidden="true" tabindex="-1"></a>            system_content</span>
<span id="cb61-340"><a href="#cb61-340" aria-hidden="true" tabindex="-1"></a>        messages <span class="op">=</span> [</span>
<span id="cb61-341"><a href="#cb61-341" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"role"</span>: <span class="st">"system"</span>, <span class="st">"content"</span>: system_content},</span>
<span id="cb61-342"><a href="#cb61-342" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: inputs[<span class="st">"prompt"</span>]},</span>
<span id="cb61-343"><a href="#cb61-343" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb61-344"><a href="#cb61-344" aria-hidden="true" tabindex="-1"></a>        outputs <span class="op">=</span> lm(messages<span class="op">=</span>messages, <span class="op">**</span>lm_kwargs)</span>
<span id="cb61-345"><a href="#cb61-345" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [{<span class="st">"generation"</span>: outputs[<span class="dv">0</span>]}]</span>
<span id="cb61-346"><a href="#cb61-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-347"><a href="#cb61-347" aria-hidden="true" tabindex="-1"></a><span class="co"># Do NOT call dspy.configure(adapter=SimplestAdapter())</span></span>
<span id="cb61-348"><a href="#cb61-348" aria-hidden="true" tabindex="-1"></a><span class="co"># Subclass Predict to use the custom adapter only for this instance</span></span>
<span id="cb61-349"><a href="#cb61-349" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyPredict(dspy.Predict):</span>
<span id="cb61-350"><a href="#cb61-350" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, <span class="op">**</span>kwargs):</span>
<span id="cb61-351"><a href="#cb61-351" aria-hidden="true" tabindex="-1"></a>        adapter <span class="op">=</span> SimplestAdapter()</span>
<span id="cb61-352"><a href="#cb61-352" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> dspy.settings.context(adapter<span class="op">=</span>adapter):</span>
<span id="cb61-353"><a href="#cb61-353" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">super</span>().forward(<span class="op">**</span>kwargs)</span>
<span id="cb61-354"><a href="#cb61-354" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-355"><a href="#cb61-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-356"><a href="#cb61-356" aria-hidden="true" tabindex="-1"></a>We also have to subclass <span class="in">`dspy.Predict`</span> so that we are able to make a program that uses our adapter. Usually in DSPy, the adapter is set globally or within a scoped context, but in both cases, the adapter is applied recursively. This has the effect of making some DSPy programs inside the optimizer use our simple adapter, causing them all to break. And breaking everything is generally not good...</span>
<span id="cb61-357"><a href="#cb61-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-360"><a href="#cb61-360" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-361"><a href="#cb61-361" aria-hidden="true" tabindex="-1"></a>my_program <span class="op">=</span> MyPredict(signature)</span>
<span id="cb61-362"><a href="#cb61-362" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-363"><a href="#cb61-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-364"><a href="#cb61-364" aria-hidden="true" tabindex="-1"></a><span class="fu">## Automatically Generating a System Prompt</span></span>
<span id="cb61-365"><a href="#cb61-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-366"><a href="#cb61-366" aria-hidden="true" tabindex="-1"></a>We are now ready to run the optimizer!!!</span>
<span id="cb61-367"><a href="#cb61-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-368"><a href="#cb61-368" aria-hidden="true" tabindex="-1"></a><span class="fu">### Letting MIPROv2 write the System Prompt</span></span>
<span id="cb61-369"><a href="#cb61-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-372"><a href="#cb61-372" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-373"><a href="#cb61-373" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb61-374"><a href="#cb61-374" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> dspy.MIPROv2(translation_judge, max_bootstrapped_demos <span class="op">=</span> <span class="dv">0</span>, max_labeled_demos <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb61-375"><a href="#cb61-375" aria-hidden="true" tabindex="-1"></a>my_program_optimized <span class="op">=</span> optimizer.<span class="bu">compile</span>(my_program, trainset<span class="op">=</span>trainset, requires_permission_to_run <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb61-376"><a href="#cb61-376" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-377"><a href="#cb61-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-378"><a href="#cb61-378" aria-hidden="true" tabindex="-1"></a>Let's test the program right away:</span>
<span id="cb61-379"><a href="#cb61-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-382"><a href="#cb61-382" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-383"><a href="#cb61-383" aria-hidden="true" tabindex="-1"></a>my_program_optimized(prompt <span class="op">=</span> <span class="st">"Hello, how are you?"</span>)</span>
<span id="cb61-384"><a href="#cb61-384" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-385"><a href="#cb61-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-386"><a href="#cb61-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-387"><a href="#cb61-387" aria-hidden="true" tabindex="-1"></a>Good! It's a translation and not a response to our salutation. Let's inspect the messages.</span>
<span id="cb61-388"><a href="#cb61-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-391"><a href="#cb61-391" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-392"><a href="#cb61-392" aria-hidden="true" tabindex="-1"></a>my_program_optimized.inspect_history()</span>
<span id="cb61-393"><a href="#cb61-393" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-394"><a href="#cb61-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-395"><a href="#cb61-395" aria-hidden="true" tabindex="-1"></a>And this confirms that our adapter works! this is a completely 'vanilla' set of messages.</span>
<span id="cb61-396"><a href="#cb61-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-397"><a href="#cb61-397" aria-hidden="true" tabindex="-1"></a><span class="fu">### Using LLM in the Metric</span></span>
<span id="cb61-398"><a href="#cb61-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-399"><a href="#cb61-399" aria-hidden="true" tabindex="-1"></a>Here we redefine our <span class="in">`translation_judge`</span>, so that instead of using Python code to calculate a score between 0 and 1 we ask an LLM to do that.</span>
<span id="cb61-400"><a href="#cb61-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-401"><a href="#cb61-401" aria-hidden="true" tabindex="-1"></a>In this case, we are using DSPy in it's most natural way! So first we define a signature by subclassing <span class="in">`dspy.Signature`</span>.</span>
<span id="cb61-402"><a href="#cb61-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-403"><a href="#cb61-403" aria-hidden="true" tabindex="-1"></a>The doc string there is instruction that the adapter will put in a system prompt. The InputField are those we will pass to the program and the OutField are those that the program will return, in the case of <span class="in">`score: int = dspy.OutputField(desc="A single integer from 1 to 5.")`</span> dspy will ensure and parse the integer out of the llm generated string for us. If an int is not provided, DSPy will even retry for us, and try different adapters.</span>
<span id="cb61-404"><a href="#cb61-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-407"><a href="#cb61-407" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-408"><a href="#cb61-408" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> QuebecTranslationJudge(dspy.Signature):</span>
<span id="cb61-409"><a href="#cb61-409" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""You are an expert Quebec French linguist. For each English sentence and its proposed French translation, evaluate the translation on a scale of 1 to 5 based on the following criteria, with 5 being a perfect, natural-sounding translation.</span></span>
<span id="cb61-410"><a href="#cb61-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-411"><a href="#cb61-411" aria-hidden="true" tabindex="-1"></a><span class="co">1.  **Accuracy**: Does the French convey the same meaning as the English?</span></span>
<span id="cb61-412"><a href="#cb61-412" aria-hidden="true" tabindex="-1"></a><span class="co">2.  **Register**: Is the tone appropriately informal/colloquial (not formal textbook French)?</span></span>
<span id="cb61-413"><a href="#cb61-413" aria-hidden="true" tabindex="-1"></a><span class="co">3.  **Regional Vocabulary**: Does it use authentic Quebec French terms (e.g., "dépanneur", "frette", "char")?</span></span>
<span id="cb61-414"><a href="#cb61-414" aria-hidden="true" tabindex="-1"></a><span class="co">4.  **Contractions**: Are natural Quebec French contractions used (e.g., "j'va", "t'sais", "y fait")?</span></span>
<span id="cb61-415"><a href="#cb61-415" aria-hidden="true" tabindex="-1"></a><span class="co">5.  **Proper Nouns &amp; Anglicisms**: Are names (e.g., "Tim's") and common anglicisms (e.g., "weekend") handled appropriately for Quebec French?</span></span>
<span id="cb61-416"><a href="#cb61-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-417"><a href="#cb61-417" aria-hidden="true" tabindex="-1"></a><span class="co">Provide brief feedback on any issues and output only the final numerical score.</span></span>
<span id="cb61-418"><a href="#cb61-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-419"><a href="#cb61-419" aria-hidden="true" tabindex="-1"></a><span class="co">IMPORTANT IF MEANING IS CHANGED SET TO 0.</span></span>
<span id="cb61-420"><a href="#cb61-420" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb61-421"><a href="#cb61-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-422"><a href="#cb61-422" aria-hidden="true" tabindex="-1"></a>    english_sentence <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">"The original sentence in English."</span>)</span>
<span id="cb61-423"><a href="#cb61-423" aria-hidden="true" tabindex="-1"></a>    french_translation <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">"The proposed translation in Quebec French."</span>)</span>
<span id="cb61-424"><a href="#cb61-424" aria-hidden="true" tabindex="-1"></a>    feedback <span class="op">=</span> dspy.OutputField(desc<span class="op">=</span><span class="st">"Brief feedback on the translation's quality."</span>)</span>
<span id="cb61-425"><a href="#cb61-425" aria-hidden="true" tabindex="-1"></a>    score: <span class="bu">int</span> <span class="op">=</span> dspy.OutputField(desc<span class="op">=</span><span class="st">"A single integer from 1 to 5."</span>)</span>
<span id="cb61-426"><a href="#cb61-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-427"><a href="#cb61-427" aria-hidden="true" tabindex="-1"></a><span class="co"># If you have a capable model configured globally, just do this:</span></span>
<span id="cb61-428"><a href="#cb61-428" aria-hidden="true" tabindex="-1"></a>llm_judge <span class="op">=</span> dspy.Predict(QuebecTranslationJudge)</span>
<span id="cb61-429"><a href="#cb61-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-430"><a href="#cb61-430" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> translation_judge(example, prediction, trace<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb61-431"><a href="#cb61-431" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb61-432"><a href="#cb61-432" aria-hidden="true" tabindex="-1"></a><span class="co">    An LLM-based metric that judges translation quality.</span></span>
<span id="cb61-433"><a href="#cb61-433" aria-hidden="true" tabindex="-1"></a><span class="co">    It robustly parses the score and normalizes it to a 0.0-1.0 scale.</span></span>
<span id="cb61-434"><a href="#cb61-434" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb61-435"><a href="#cb61-435" aria-hidden="true" tabindex="-1"></a>    english_sentence <span class="op">=</span> example.prompt</span>
<span id="cb61-436"><a href="#cb61-436" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure the prediction's output is not empty</span></span>
<span id="cb61-437"><a href="#cb61-437" aria-hidden="true" tabindex="-1"></a>    french_translation <span class="op">=</span> prediction.get(<span class="st">"generation"</span>, <span class="st">""</span>)</span>
<span id="cb61-438"><a href="#cb61-438" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> french_translation:</span>
<span id="cb61-439"><a href="#cb61-439" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.0</span></span>
<span id="cb61-440"><a href="#cb61-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-441"><a href="#cb61-441" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb61-442"><a href="#cb61-442" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Call the LLM judge to get a score</span></span>
<span id="cb61-443"><a href="#cb61-443" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> llm_judge(</span>
<span id="cb61-444"><a href="#cb61-444" aria-hidden="true" tabindex="-1"></a>            english_sentence<span class="op">=</span>english_sentence,</span>
<span id="cb61-445"><a href="#cb61-445" aria-hidden="true" tabindex="-1"></a>            french_translation<span class="op">=</span>french_translation</span>
<span id="cb61-446"><a href="#cb61-446" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb61-447"><a href="#cb61-447" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parse the score and normalize it to a 0.0-1.0 range</span></span>
<span id="cb61-448"><a href="#cb61-448" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (e.g., a score of 5 becomes 1.0, 1 becomes 0.2)</span></span>
<span id="cb61-449"><a href="#cb61-449" aria-hidden="true" tabindex="-1"></a>        score <span class="op">=</span> <span class="bu">float</span>(result.score)</span>
<span id="cb61-450"><a href="#cb61-450" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> score <span class="op">/</span> <span class="fl">5.0</span></span>
<span id="cb61-451"><a href="#cb61-451" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> (<span class="pp">ValueError</span>, <span class="pp">AttributeError</span>, <span class="pp">TypeError</span>):</span>
<span id="cb61-452"><a href="#cb61-452" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If the LLM fails to output a valid score, return 0.0</span></span>
<span id="cb61-453"><a href="#cb61-453" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.0</span></span>
<span id="cb61-454"><a href="#cb61-454" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-455"><a href="#cb61-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-456"><a href="#cb61-456" aria-hidden="true" tabindex="-1"></a>Now that we have overwritten <span class="in">`translation_judge`</span> let's run the optimization again</span>
<span id="cb61-457"><a href="#cb61-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-460"><a href="#cb61-460" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-461"><a href="#cb61-461" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb61-462"><a href="#cb61-462" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> dspy.MIPROv2(translation_judge, max_bootstrapped_demos <span class="op">=</span> <span class="dv">0</span>, max_labeled_demos <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb61-463"><a href="#cb61-463" aria-hidden="true" tabindex="-1"></a>my_program_optimized <span class="op">=</span> optimizer.<span class="bu">compile</span>(my_program, trainset<span class="op">=</span>trainset, requires_permission_to_run <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb61-464"><a href="#cb61-464" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-465"><a href="#cb61-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-466"><a href="#cb61-466" aria-hidden="true" tabindex="-1"></a>Let's test the program right away:</span>
<span id="cb61-467"><a href="#cb61-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-470"><a href="#cb61-470" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-471"><a href="#cb61-471" aria-hidden="true" tabindex="-1"></a>my_program_optimized(prompt <span class="op">=</span> <span class="st">"Hello, how are you?"</span>)</span>
<span id="cb61-472"><a href="#cb61-472" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-473"><a href="#cb61-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-474"><a href="#cb61-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-475"><a href="#cb61-475" aria-hidden="true" tabindex="-1"></a>Good! It's again a translation and not a response to our salutation. Let's inspect the messages.</span>
<span id="cb61-476"><a href="#cb61-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-479"><a href="#cb61-479" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-480"><a href="#cb61-480" aria-hidden="true" tabindex="-1"></a>my_program_optimized.inspect_history()</span>
<span id="cb61-481"><a href="#cb61-481" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-482"><a href="#cb61-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-483"><a href="#cb61-483" aria-hidden="true" tabindex="-1"></a>And this confirms that our adapter works! this is a completely 'vanilla' set of messages.</span>
<span id="cb61-484"><a href="#cb61-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-485"><a href="#cb61-485" aria-hidden="true" tabindex="-1"></a><span class="fu">### Optimizing with Few-Shots Examples too</span></span>
<span id="cb61-486"><a href="#cb61-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-487"><a href="#cb61-487" aria-hidden="true" tabindex="-1"></a>Let's, now, make it possible for MIPROv2 to also add few-shots example into the system prompt.</span>
<span id="cb61-488"><a href="#cb61-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-489"><a href="#cb61-489" aria-hidden="true" tabindex="-1"></a>For this we need to improve our simple adapter to have a way to format the demos. So we first define <span class="in">`format_demos`</span>, this is a normal Python function that will expect a list of dspy Examples and turn that into a simple string with a light XML structure.</span>
<span id="cb61-490"><a href="#cb61-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-493"><a href="#cb61-493" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-494"><a href="#cb61-494" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> format_demos(demos):</span>
<span id="cb61-495"><a href="#cb61-495" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb61-496"><a href="#cb61-496" aria-hidden="true" tabindex="-1"></a><span class="co">    Wrap every demo once – no duplicated header lines.</span></span>
<span id="cb61-497"><a href="#cb61-497" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb61-498"><a href="#cb61-498" aria-hidden="true" tabindex="-1"></a>    parts <span class="op">=</span> [<span class="st">"Here are examples of your expected behavior."</span>,</span>
<span id="cb61-499"><a href="#cb61-499" aria-hidden="true" tabindex="-1"></a>             <span class="st">"&lt;examples&gt;"</span>]</span>
<span id="cb61-500"><a href="#cb61-500" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, demo <span class="kw">in</span> <span class="bu">enumerate</span>(demos, <span class="dv">1</span>):</span>
<span id="cb61-501"><a href="#cb61-501" aria-hidden="true" tabindex="-1"></a>        parts <span class="op">+=</span> [</span>
<span id="cb61-502"><a href="#cb61-502" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"&lt;example_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">&gt;"</span>,</span>
<span id="cb61-503"><a href="#cb61-503" aria-hidden="true" tabindex="-1"></a>            <span class="st">"User:"</span>,</span>
<span id="cb61-504"><a href="#cb61-504" aria-hidden="true" tabindex="-1"></a>            demo[<span class="st">"prompt"</span>],</span>
<span id="cb61-505"><a href="#cb61-505" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Assistant:"</span>,</span>
<span id="cb61-506"><a href="#cb61-506" aria-hidden="true" tabindex="-1"></a>            demo[<span class="st">"generation"</span>],</span>
<span id="cb61-507"><a href="#cb61-507" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"&lt;/example_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">&gt;"</span>,</span>
<span id="cb61-508"><a href="#cb61-508" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb61-509"><a href="#cb61-509" aria-hidden="true" tabindex="-1"></a>    parts.append(<span class="st">"&lt;/examples&gt;"</span>)</span>
<span id="cb61-510"><a href="#cb61-510" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(parts)</span>
<span id="cb61-511"><a href="#cb61-511" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-512"><a href="#cb61-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-513"><a href="#cb61-513" aria-hidden="true" tabindex="-1"></a>Let's try it:</span>
<span id="cb61-514"><a href="#cb61-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-517"><a href="#cb61-517" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-518"><a href="#cb61-518" aria-hidden="true" tabindex="-1"></a>examples <span class="op">=</span> [</span>
<span id="cb61-519"><a href="#cb61-519" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"She's my girlfriend."</span>, generation<span class="op">=</span><span class="st">"C'est ma blonde."</span>),</span>
<span id="cb61-520"><a href="#cb61-520" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"It's snowing again."</span>, generation<span class="op">=</span><span class="st">"Il neige encore."</span>),</span>
<span id="cb61-521"><a href="#cb61-521" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb61-522"><a href="#cb61-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-523"><a href="#cb61-523" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(format_demos(examples))</span>
<span id="cb61-524"><a href="#cb61-524" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-525"><a href="#cb61-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-526"><a href="#cb61-526" aria-hidden="true" tabindex="-1"></a>And we need to update our <span class="in">`SimplestAdapter`</span> with that line: <span class="in">`system_content += "\n" + format_demos(demos)`</span>.</span>
<span id="cb61-527"><a href="#cb61-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-530"><a href="#cb61-530" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-531"><a href="#cb61-531" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the SimplestAdapter as before</span></span>
<span id="cb61-532"><a href="#cb61-532" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SimplestAdapter(dspy.Adapter):</span>
<span id="cb61-533"><a href="#cb61-533" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, lm, lm_kwargs, signature, demos, inputs):</span>
<span id="cb61-534"><a href="#cb61-534" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(inputs)</span>
<span id="cb61-535"><a href="#cb61-535" aria-hidden="true" tabindex="-1"></a>        system_content <span class="op">=</span> signature.instructions</span>
<span id="cb61-536"><a href="#cb61-536" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> demos:</span>
<span id="cb61-537"><a href="#cb61-537" aria-hidden="true" tabindex="-1"></a>            system_content <span class="op">+=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> format_demos(demos)</span>
<span id="cb61-538"><a href="#cb61-538" aria-hidden="true" tabindex="-1"></a>        messages <span class="op">=</span> [</span>
<span id="cb61-539"><a href="#cb61-539" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"role"</span>: <span class="st">"system"</span>, <span class="st">"content"</span>: system_content},</span>
<span id="cb61-540"><a href="#cb61-540" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: inputs[<span class="st">"prompt"</span>]},</span>
<span id="cb61-541"><a href="#cb61-541" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb61-542"><a href="#cb61-542" aria-hidden="true" tabindex="-1"></a>        outputs <span class="op">=</span> lm(messages<span class="op">=</span>messages, <span class="op">**</span>lm_kwargs)</span>
<span id="cb61-543"><a href="#cb61-543" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [{<span class="st">"generation"</span>: outputs[<span class="dv">0</span>]}]</span>
<span id="cb61-544"><a href="#cb61-544" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-545"><a href="#cb61-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-546"><a href="#cb61-546" aria-hidden="true" tabindex="-1"></a>Let's run the optimization again but with <span class="in">`max_labeled_demos = 3`</span> this time.</span>
<span id="cb61-547"><a href="#cb61-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-550"><a href="#cb61-550" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-551"><a href="#cb61-551" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb61-552"><a href="#cb61-552" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> dspy.MIPROv2(translation_judge, max_bootstrapped_demos <span class="op">=</span> <span class="dv">3</span>, max_labeled_demos <span class="op">=</span> <span class="dv">3</span>)</span>
<span id="cb61-553"><a href="#cb61-553" aria-hidden="true" tabindex="-1"></a>my_program_optimized <span class="op">=</span> optimizer.<span class="bu">compile</span>(my_program, trainset<span class="op">=</span>trainset, requires_permission_to_run <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb61-554"><a href="#cb61-554" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-555"><a href="#cb61-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-556"><a href="#cb61-556" aria-hidden="true" tabindex="-1"></a>Let's test the program right away:</span>
<span id="cb61-557"><a href="#cb61-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-560"><a href="#cb61-560" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-561"><a href="#cb61-561" aria-hidden="true" tabindex="-1"></a>my_program_optimized(prompt <span class="op">=</span> <span class="st">"Hello, how are you?"</span>)</span>
<span id="cb61-562"><a href="#cb61-562" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-563"><a href="#cb61-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-564"><a href="#cb61-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-565"><a href="#cb61-565" aria-hidden="true" tabindex="-1"></a>Good! It's again a translation and not a response to our salutation. Let's inspect the messages.</span>
<span id="cb61-566"><a href="#cb61-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-569"><a href="#cb61-569" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-570"><a href="#cb61-570" aria-hidden="true" tabindex="-1"></a>my_program_optimized.inspect_history()</span>
<span id="cb61-571"><a href="#cb61-571" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-572"><a href="#cb61-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-573"><a href="#cb61-573" aria-hidden="true" tabindex="-1"></a>Now our System Prompt also contains a few examples.</span>
<span id="cb61-574"><a href="#cb61-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-575"><a href="#cb61-575" aria-hidden="true" tabindex="-1"></a><span class="fu">### Changing Optimizer</span></span>
<span id="cb61-576"><a href="#cb61-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-577"><a href="#cb61-577" aria-hidden="true" tabindex="-1"></a>We can easily change Optimizer, look this code now uses <span class="in">`SIMBA`</span> instead of <span class="in">`MIPROv2`</span></span>
<span id="cb61-578"><a href="#cb61-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-581"><a href="#cb61-581" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-582"><a href="#cb61-582" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb61-583"><a href="#cb61-583" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> dspy.SIMBA(metric <span class="op">=</span> translation_judge, bsize <span class="op">=</span> <span class="dv">8</span>)</span>
<span id="cb61-584"><a href="#cb61-584" aria-hidden="true" tabindex="-1"></a>my_program_optimized <span class="op">=</span> optimizer.<span class="bu">compile</span>(my_program, trainset<span class="op">=</span>trainset)</span>
<span id="cb61-585"><a href="#cb61-585" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-586"><a href="#cb61-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-587"><a href="#cb61-587" aria-hidden="true" tabindex="-1"></a>Let's check the results:</span>
<span id="cb61-588"><a href="#cb61-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-591"><a href="#cb61-591" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-592"><a href="#cb61-592" aria-hidden="true" tabindex="-1"></a>my_program_optimized(prompt <span class="op">=</span> <span class="st">"Hello, how are you?"</span>)</span>
<span id="cb61-593"><a href="#cb61-593" aria-hidden="true" tabindex="-1"></a>my_program_optimized.inspect_history()</span>
<span id="cb61-594"><a href="#cb61-594" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-595"><a href="#cb61-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-596"><a href="#cb61-596" aria-hidden="true" tabindex="-1"></a>In the case of SIMBA, we can see that it gradually added instructions to the system prompt.</span>
<span id="cb61-597"><a href="#cb61-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-598"><a href="#cb61-598" aria-hidden="true" tabindex="-1"></a><span class="fu">### Teacher-Student optimization</span></span>
<span id="cb61-599"><a href="#cb61-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-600"><a href="#cb61-600" aria-hidden="true" tabindex="-1"></a>Let's now optimize a for a smaller model while still using <span class="in">`Kimi`</span> to generate the system prompt.</span>
<span id="cb61-601"><a href="#cb61-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-602"><a href="#cb61-602" aria-hidden="true" tabindex="-1"></a>We must now create another LM connection, let's stay with groq for speed and to keep things simple. </span>
<span id="cb61-603"><a href="#cb61-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-606"><a href="#cb61-606" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-607"><a href="#cb61-607" aria-hidden="true" tabindex="-1"></a>llama8b <span class="op">=</span> dspy.LM(<span class="st">"groq/llama-3.1-8b-instant"</span>)</span>
<span id="cb61-608"><a href="#cb61-608" aria-hidden="true" tabindex="-1"></a>my_program.set_lm(lm <span class="op">=</span> llama8b)</span>
<span id="cb61-609"><a href="#cb61-609" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-610"><a href="#cb61-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-611"><a href="#cb61-611" aria-hidden="true" tabindex="-1"></a>Here, I have to add teacher argument to compile: <span class="in">`.compile(... teacher = kimi ...)`</span>.</span>
<span id="cb61-612"><a href="#cb61-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-615"><a href="#cb61-615" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-616"><a href="#cb61-616" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb61-617"><a href="#cb61-617" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> dspy.MIPROv2(translation_judge, max_bootstrapped_demos <span class="op">=</span> <span class="dv">0</span>, max_labeled_demos <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb61-618"><a href="#cb61-618" aria-hidden="true" tabindex="-1"></a>my_program_optimized <span class="op">=</span> optimizer.<span class="bu">compile</span>(my_program, trainset<span class="op">=</span>trainset, teacher <span class="op">=</span> kimi, requires_permission_to_run <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb61-619"><a href="#cb61-619" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-620"><a href="#cb61-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-621"><a href="#cb61-621" aria-hidden="true" tabindex="-1"></a>Let's confirm that <span class="in">`my_program_optimized`</span> is set to use Llama.</span>
<span id="cb61-622"><a href="#cb61-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-625"><a href="#cb61-625" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-626"><a href="#cb61-626" aria-hidden="true" tabindex="-1"></a>my_program_optimized.lm.model</span>
<span id="cb61-627"><a href="#cb61-627" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-628"><a href="#cb61-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-629"><a href="#cb61-629" aria-hidden="true" tabindex="-1"></a>Indeed it is!</span>
<span id="cb61-630"><a href="#cb61-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-631"><a href="#cb61-631" aria-hidden="true" tabindex="-1"></a>Let's try it: </span>
<span id="cb61-632"><a href="#cb61-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-635"><a href="#cb61-635" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-636"><a href="#cb61-636" aria-hidden="true" tabindex="-1"></a>my_program_optimized(prompt <span class="op">=</span> <span class="st">"Hello, how are you?"</span>)</span>
<span id="cb61-637"><a href="#cb61-637" aria-hidden="true" tabindex="-1"></a>my_program_optimized.inspect_history()</span>
<span id="cb61-638"><a href="#cb61-638" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-639"><a href="#cb61-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-640"><a href="#cb61-640" aria-hidden="true" tabindex="-1"></a>Cool so now we have Llama 3.1 8b as our translator :)</span>
<span id="cb61-641"><a href="#cb61-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-642"><a href="#cb61-642" aria-hidden="true" tabindex="-1"></a><span class="fu">### Bringing it all together</span></span>
<span id="cb61-643"><a href="#cb61-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-644"><a href="#cb61-644" aria-hidden="true" tabindex="-1"></a>Let's now make the <span class="in">`optimize()`</span> function we envisionned at the beginning.</span>
<span id="cb61-645"><a href="#cb61-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-646"><a href="#cb61-646" aria-hidden="true" tabindex="-1"></a>Here, I asked o3-pro to bring it all together for us, you'll recognize its comment style.</span>
<span id="cb61-647"><a href="#cb61-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-650"><a href="#cb61-650" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-651"><a href="#cb61-651" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> optimize(</span>
<span id="cb61-652"><a href="#cb61-652" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>,</span>
<span id="cb61-653"><a href="#cb61-653" aria-hidden="true" tabindex="-1"></a>    training_inputs: <span class="bu">list</span>[<span class="bu">str</span>],</span>
<span id="cb61-654"><a href="#cb61-654" aria-hidden="true" tabindex="-1"></a>    training_outputs: <span class="bu">list</span>[<span class="bu">str</span>],</span>
<span id="cb61-655"><a href="#cb61-655" aria-hidden="true" tabindex="-1"></a>    llm_judge,</span>
<span id="cb61-656"><a href="#cb61-656" aria-hidden="true" tabindex="-1"></a>    system_prompt: <span class="bu">str</span> <span class="op">=</span> <span class="st">""</span>,</span>
<span id="cb61-657"><a href="#cb61-657" aria-hidden="true" tabindex="-1"></a>    max_few_shots: <span class="bu">int</span> <span class="op">=</span> <span class="dv">0</span>,</span>
<span id="cb61-658"><a href="#cb61-658" aria-hidden="true" tabindex="-1"></a>    teacher_model<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb61-659"><a href="#cb61-659" aria-hidden="true" tabindex="-1"></a>    student_model<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb61-660"><a href="#cb61-660" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb61-661"><a href="#cb61-661" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb61-662"><a href="#cb61-662" aria-hidden="true" tabindex="-1"></a><span class="co">    One‑stop helper that (1) turns parallel input / output lists into a DSPy</span></span>
<span id="cb61-663"><a href="#cb61-663" aria-hidden="true" tabindex="-1"></a><span class="co">    training‑set, (2) builds / optimises a tiny translation programme, and</span></span>
<span id="cb61-664"><a href="#cb61-664" aria-hidden="true" tabindex="-1"></a><span class="co">    (3) returns the auto‑generated system‑prompt (with optional few‑shot</span></span>
<span id="cb61-665"><a href="#cb61-665" aria-hidden="true" tabindex="-1"></a><span class="co">    examples baked‑in).</span></span>
<span id="cb61-666"><a href="#cb61-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-667"><a href="#cb61-667" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb61-668"><a href="#cb61-668" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb61-669"><a href="#cb61-669" aria-hidden="true" tabindex="-1"></a><span class="co">    training_inputs, training_outputs : list[str]</span></span>
<span id="cb61-670"><a href="#cb61-670" aria-hidden="true" tabindex="-1"></a><span class="co">        Parallel lists of user prompts and the desired assistant replies.</span></span>
<span id="cb61-671"><a href="#cb61-671" aria-hidden="true" tabindex="-1"></a><span class="co">    llm_judge : str | Callable</span></span>
<span id="cb61-672"><a href="#cb61-672" aria-hidden="true" tabindex="-1"></a><span class="co">        Either a *string* with judging instructions **or** a fully‑formed</span></span>
<span id="cb61-673"><a href="#cb61-673" aria-hidden="true" tabindex="-1"></a><span class="co">        `metric(example, prediction, trace)-&gt;float` callable.</span></span>
<span id="cb61-674"><a href="#cb61-674" aria-hidden="true" tabindex="-1"></a><span class="co">    system_prompt : str, optional</span></span>
<span id="cb61-675"><a href="#cb61-675" aria-hidden="true" tabindex="-1"></a><span class="co">        A starting prompt to improve upon (default empty).</span></span>
<span id="cb61-676"><a href="#cb61-676" aria-hidden="true" tabindex="-1"></a><span class="co">    max_few_shots : int, optional</span></span>
<span id="cb61-677"><a href="#cb61-677" aria-hidden="true" tabindex="-1"></a><span class="co">        Upper‑bound on examples the optimiser may add to the prompt.</span></span>
<span id="cb61-678"><a href="#cb61-678" aria-hidden="true" tabindex="-1"></a><span class="co">    teacher_model, student_model : str | dspy.LM | None</span></span>
<span id="cb61-679"><a href="#cb61-679" aria-hidden="true" tabindex="-1"></a><span class="co">        Identifiers *or* `dspy.LM` objects.  If only one is given, we fall</span></span>
<span id="cb61-680"><a href="#cb61-680" aria-hidden="true" tabindex="-1"></a><span class="co">        back&nbsp;gracefully to the globally configured LM.</span></span>
<span id="cb61-681"><a href="#cb61-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-682"><a href="#cb61-682" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb61-683"><a href="#cb61-683" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb61-684"><a href="#cb61-684" aria-hidden="true" tabindex="-1"></a><span class="co">    str</span></span>
<span id="cb61-685"><a href="#cb61-685" aria-hidden="true" tabindex="-1"></a><span class="co">        The final system‑prompt text, ready to feed any chat‑completion API.</span></span>
<span id="cb61-686"><a href="#cb61-686" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb61-687"><a href="#cb61-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-688"><a href="#cb61-688" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb61-689"><a href="#cb61-689" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 0 .  Basic validation                                              #</span></span>
<span id="cb61-690"><a href="#cb61-690" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb61-691"><a href="#cb61-691" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(training_inputs) <span class="op">!=</span> <span class="bu">len</span>(training_outputs):</span>
<span id="cb61-692"><a href="#cb61-692" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"`training_inputs` and `training_outputs` must "</span></span>
<span id="cb61-693"><a href="#cb61-693" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"have the same length."</span>)</span>
<span id="cb61-694"><a href="#cb61-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-695"><a href="#cb61-695" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb61-696"><a href="#cb61-696" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1 .  Build the training set                                        #</span></span>
<span id="cb61-697"><a href="#cb61-697" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb61-698"><a href="#cb61-698" aria-hidden="true" tabindex="-1"></a>    examples <span class="op">=</span> [</span>
<span id="cb61-699"><a href="#cb61-699" aria-hidden="true" tabindex="-1"></a>        dspy.Example(prompt<span class="op">=</span>inp, generation<span class="op">=</span>out)</span>
<span id="cb61-700"><a href="#cb61-700" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> inp, out <span class="kw">in</span> <span class="bu">zip</span>(training_inputs, training_outputs, strict<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb61-701"><a href="#cb61-701" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb61-702"><a href="#cb61-702" aria-hidden="true" tabindex="-1"></a>    trainset <span class="op">=</span> [ex.with_inputs(<span class="st">"prompt"</span>) <span class="cf">for</span> ex <span class="kw">in</span> examples]</span>
<span id="cb61-703"><a href="#cb61-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-704"><a href="#cb61-704" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb61-705"><a href="#cb61-705" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2 .  Build (or wrap) the metric                                    #</span></span>
<span id="cb61-706"><a href="#cb61-706" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb61-707"><a href="#cb61-707" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">callable</span>(llm_judge):</span>
<span id="cb61-708"><a href="#cb61-708" aria-hidden="true" tabindex="-1"></a>        translation_judge <span class="op">=</span> llm_judge</span>
<span id="cb61-709"><a href="#cb61-709" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb61-710"><a href="#cb61-710" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Dynamically build a judge signature around the instruction string.</span></span>
<span id="cb61-711"><a href="#cb61-711" aria-hidden="true" tabindex="-1"></a>        judge_instructions <span class="op">=</span> <span class="bu">str</span>(llm_judge).strip()</span>
<span id="cb61-712"><a href="#cb61-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-713"><a href="#cb61-713" aria-hidden="true" tabindex="-1"></a>        <span class="kw">class</span> _AutoJudge(dspy.Signature):</span>
<span id="cb61-714"><a href="#cb61-714" aria-hidden="true" tabindex="-1"></a>            <span class="co">"""{0}"""</span>.<span class="bu">format</span>(judge_instructions)</span>
<span id="cb61-715"><a href="#cb61-715" aria-hidden="true" tabindex="-1"></a>            english_sentence <span class="op">=</span> dspy.InputField()</span>
<span id="cb61-716"><a href="#cb61-716" aria-hidden="true" tabindex="-1"></a>            french_translation <span class="op">=</span> dspy.InputField()</span>
<span id="cb61-717"><a href="#cb61-717" aria-hidden="true" tabindex="-1"></a>            score: <span class="bu">int</span> <span class="op">=</span> dspy.OutputField(desc<span class="op">=</span><span class="st">"0&nbsp;=&nbsp;bad,&nbsp;1&nbsp;=&nbsp;good"</span>)</span>
<span id="cb61-718"><a href="#cb61-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-719"><a href="#cb61-719" aria-hidden="true" tabindex="-1"></a>        judge_predict <span class="op">=</span> dspy.Predict(_AutoJudge)</span>
<span id="cb61-720"><a href="#cb61-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-721"><a href="#cb61-721" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> translation_judge(example, prediction, trace<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb61-722"><a href="#cb61-722" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb61-723"><a href="#cb61-723" aria-hidden="true" tabindex="-1"></a>                result <span class="op">=</span> judge_predict(</span>
<span id="cb61-724"><a href="#cb61-724" aria-hidden="true" tabindex="-1"></a>                    english_sentence<span class="op">=</span>example.prompt,</span>
<span id="cb61-725"><a href="#cb61-725" aria-hidden="true" tabindex="-1"></a>                    french_translation<span class="op">=</span>prediction.get(<span class="st">"generation"</span>, <span class="st">""</span>)</span>
<span id="cb61-726"><a href="#cb61-726" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb61-727"><a href="#cb61-727" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="bu">float</span>(result.score)</span>
<span id="cb61-728"><a href="#cb61-728" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb61-729"><a href="#cb61-729" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="fl">0.0</span></span>
<span id="cb61-730"><a href="#cb61-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-731"><a href="#cb61-731" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb61-732"><a href="#cb61-732" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3 .  Prepare the LM objects                                        #</span></span>
<span id="cb61-733"><a href="#cb61-733" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb61-734"><a href="#cb61-734" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _to_lm(obj):</span>
<span id="cb61-735"><a href="#cb61-735" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> obj <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb61-736"><a href="#cb61-736" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb61-737"><a href="#cb61-737" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> obj <span class="cf">if</span> <span class="bu">isinstance</span>(obj, dspy.LM) <span class="cf">else</span> dspy.LM(obj)</span>
<span id="cb61-738"><a href="#cb61-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-739"><a href="#cb61-739" aria-hidden="true" tabindex="-1"></a>    teacher_lm <span class="op">=</span> _to_lm(teacher_model)</span>
<span id="cb61-740"><a href="#cb61-740" aria-hidden="true" tabindex="-1"></a>    student_lm <span class="op">=</span> _to_lm(student_model)</span>
<span id="cb61-741"><a href="#cb61-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-742"><a href="#cb61-742" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If the reader supplied no student, fall back to whatever DSPy is</span></span>
<span id="cb61-743"><a href="#cb61-743" aria-hidden="true" tabindex="-1"></a>    <span class="co"># already configured with; otherwise bind the student to our programme.</span></span>
<span id="cb61-744"><a href="#cb61-744" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> student_lm <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb61-745"><a href="#cb61-745" aria-hidden="true" tabindex="-1"></a>        active_lm <span class="op">=</span> student_lm</span>
<span id="cb61-746"><a href="#cb61-746" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb61-747"><a href="#cb61-747" aria-hidden="true" tabindex="-1"></a>        active_lm <span class="op">=</span> dspy.settings.get(<span class="st">"lm"</span>)  <span class="co"># may still be None → DSPy default</span></span>
<span id="cb61-748"><a href="#cb61-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-749"><a href="#cb61-749" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb61-750"><a href="#cb61-750" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4 .  Build the programme                                           #</span></span>
<span id="cb61-751"><a href="#cb61-751" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb61-752"><a href="#cb61-752" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> OptimSignature(dspy.Signature):</span>
<span id="cb61-753"><a href="#cb61-753" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""{0}"""</span>.<span class="bu">format</span>(system_prompt)</span>
<span id="cb61-754"><a href="#cb61-754" aria-hidden="true" tabindex="-1"></a>        prompt <span class="op">=</span> dspy.InputField()</span>
<span id="cb61-755"><a href="#cb61-755" aria-hidden="true" tabindex="-1"></a>        generation <span class="op">=</span> dspy.OutputField()</span>
<span id="cb61-756"><a href="#cb61-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-757"><a href="#cb61-757" aria-hidden="true" tabindex="-1"></a>    programme <span class="op">=</span> MyPredict(OptimSignature)</span>
<span id="cb61-758"><a href="#cb61-758" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> active_lm <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb61-759"><a href="#cb61-759" aria-hidden="true" tabindex="-1"></a>        programme.set_lm(active_lm)</span>
<span id="cb61-760"><a href="#cb61-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-761"><a href="#cb61-761" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb61-762"><a href="#cb61-762" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5 .  Run MIPRO‑v2                                                  #</span></span>
<span id="cb61-763"><a href="#cb61-763" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb61-764"><a href="#cb61-764" aria-hidden="true" tabindex="-1"></a>    optimiser <span class="op">=</span> dspy.MIPROv2(</span>
<span id="cb61-765"><a href="#cb61-765" aria-hidden="true" tabindex="-1"></a>        translation_judge,</span>
<span id="cb61-766"><a href="#cb61-766" aria-hidden="true" tabindex="-1"></a>        max_bootstrapped_demos<span class="op">=</span>max_few_shots,</span>
<span id="cb61-767"><a href="#cb61-767" aria-hidden="true" tabindex="-1"></a>        max_labeled_demos<span class="op">=</span>max_few_shots,</span>
<span id="cb61-768"><a href="#cb61-768" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-769"><a href="#cb61-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-770"><a href="#cb61-770" aria-hidden="true" tabindex="-1"></a>    compile_kwargs <span class="op">=</span> <span class="bu">dict</span>(</span>
<span id="cb61-771"><a href="#cb61-771" aria-hidden="true" tabindex="-1"></a>        trainset<span class="op">=</span>trainset,</span>
<span id="cb61-772"><a href="#cb61-772" aria-hidden="true" tabindex="-1"></a>        requires_permission_to_run<span class="op">=</span><span class="va">False</span></span>
<span id="cb61-773"><a href="#cb61-773" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-774"><a href="#cb61-774" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> teacher_lm <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb61-775"><a href="#cb61-775" aria-hidden="true" tabindex="-1"></a>        compile_kwargs[<span class="st">"teacher"</span>] <span class="op">=</span> teacher_lm</span>
<span id="cb61-776"><a href="#cb61-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-777"><a href="#cb61-777" aria-hidden="true" tabindex="-1"></a>    tuned_prog <span class="op">=</span> optimiser.<span class="bu">compile</span>(programme, <span class="op">**</span>compile_kwargs)</span>
<span id="cb61-778"><a href="#cb61-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-779"><a href="#cb61-779" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb61-780"><a href="#cb61-780" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 6 .  Extract the finished prompt&nbsp;(+ optional demos)                #</span></span>
<span id="cb61-781"><a href="#cb61-781" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ------------------------------------------------------------------ #</span></span>
<span id="cb61-782"><a href="#cb61-782" aria-hidden="true" tabindex="-1"></a>    final_prompt <span class="op">=</span> tuned_prog.signature.instructions.strip()</span>
<span id="cb61-783"><a href="#cb61-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-784"><a href="#cb61-784" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">getattr</span>(tuned_prog, <span class="st">"demos"</span>, <span class="va">None</span>):</span>
<span id="cb61-785"><a href="#cb61-785" aria-hidden="true" tabindex="-1"></a>        final_prompt <span class="op">+=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> format_demos(tuned_prog.demos)</span>
<span id="cb61-786"><a href="#cb61-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-787"><a href="#cb61-787" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> final_prompt</span>
<span id="cb61-788"><a href="#cb61-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-789"><a href="#cb61-789" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-790"><a href="#cb61-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-791"><a href="#cb61-791" aria-hidden="true" tabindex="-1"></a>Let's use it:</span>
<span id="cb61-792"><a href="#cb61-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-795"><a href="#cb61-795" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-796"><a href="#cb61-796" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb61-797"><a href="#cb61-797" aria-hidden="true" tabindex="-1"></a>optimized_system_prompt <span class="op">=</span> optimize(</span>
<span id="cb61-798"><a href="#cb61-798" aria-hidden="true" tabindex="-1"></a>    training_inputs<span class="op">=</span>[</span>
<span id="cb61-799"><a href="#cb61-799" aria-hidden="true" tabindex="-1"></a>        <span class="st">"I'm going to the convenience store."</span>,</span>
<span id="cb61-800"><a href="#cb61-800" aria-hidden="true" tabindex="-1"></a>        <span class="st">"It's really cold out today."</span></span>
<span id="cb61-801"><a href="#cb61-801" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb61-802"><a href="#cb61-802" aria-hidden="true" tabindex="-1"></a>    training_outputs<span class="op">=</span>[</span>
<span id="cb61-803"><a href="#cb61-803" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Je m'en vais au dépanneur."</span>,</span>
<span id="cb61-804"><a href="#cb61-804" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Il fait frette en maudit aujourd'hui."</span></span>
<span id="cb61-805"><a href="#cb61-805" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb61-806"><a href="#cb61-806" aria-hidden="true" tabindex="-1"></a>    llm_judge<span class="op">=</span><span class="st">"Return 1 if the French looks natural and 0 otherwise."</span></span>
<span id="cb61-807"><a href="#cb61-807" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-808"><a href="#cb61-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-809"><a href="#cb61-809" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-810"><a href="#cb61-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-811"><a href="#cb61-811" aria-hidden="true" tabindex="-1"></a>Let's see what system prompt we got:</span>
<span id="cb61-812"><a href="#cb61-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-815"><a href="#cb61-815" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-816"><a href="#cb61-816" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(optimized_system_prompt)</span>
<span id="cb61-817"><a href="#cb61-817" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-818"><a href="#cb61-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-819"><a href="#cb61-819" aria-hidden="true" tabindex="-1"></a>Not bad! Let's test with all the parameters:</span>
<span id="cb61-820"><a href="#cb61-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-823"><a href="#cb61-823" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-824"><a href="#cb61-824" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb61-825"><a href="#cb61-825" aria-hidden="true" tabindex="-1"></a>optimized_system_prompt <span class="op">=</span> optimize(</span>
<span id="cb61-826"><a href="#cb61-826" aria-hidden="true" tabindex="-1"></a>    training_inputs<span class="op">=</span>[</span>
<span id="cb61-827"><a href="#cb61-827" aria-hidden="true" tabindex="-1"></a>        <span class="st">"I'm going to the convenience store."</span>,</span>
<span id="cb61-828"><a href="#cb61-828" aria-hidden="true" tabindex="-1"></a>        <span class="st">"It's really cold out today."</span></span>
<span id="cb61-829"><a href="#cb61-829" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb61-830"><a href="#cb61-830" aria-hidden="true" tabindex="-1"></a>    training_outputs<span class="op">=</span>[</span>
<span id="cb61-831"><a href="#cb61-831" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Je m'en vais au dépanneur."</span>,</span>
<span id="cb61-832"><a href="#cb61-832" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Il fait frette en maudit aujourd'hui."</span></span>
<span id="cb61-833"><a href="#cb61-833" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb61-834"><a href="#cb61-834" aria-hidden="true" tabindex="-1"></a>    llm_judge<span class="op">=</span><span class="st">"Return 1 if the French looks natural and French Canadian and 0 otherwise."</span>,</span>
<span id="cb61-835"><a href="#cb61-835" aria-hidden="true" tabindex="-1"></a>    system_prompt <span class="op">=</span> <span class="st">"Translate from english to french"</span>,</span>
<span id="cb61-836"><a href="#cb61-836" aria-hidden="true" tabindex="-1"></a>    max_few_shots <span class="op">=</span> <span class="dv">2</span>,</span>
<span id="cb61-837"><a href="#cb61-837" aria-hidden="true" tabindex="-1"></a>    teacher_model <span class="op">=</span> <span class="st">"groq/moonshotai/kimi-k2-instruct"</span>,</span>
<span id="cb61-838"><a href="#cb61-838" aria-hidden="true" tabindex="-1"></a>    student_model <span class="op">=</span> <span class="st">"groq/llama-3.1-8b-instant"</span></span>
<span id="cb61-839"><a href="#cb61-839" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-840"><a href="#cb61-840" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb61-841"><a href="#cb61-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-842"><a href="#cb61-842" aria-hidden="true" tabindex="-1"></a>And let's see what we got:</span>
<span id="cb61-843"><a href="#cb61-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-846"><a href="#cb61-846" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb61-847"><a href="#cb61-847" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(optimized_system_prompt)</span>
<span id="cb61-848"><a href="#cb61-848" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/MaximeRivest/maximerivest-blog/edit/main/posts/automatic-system-prompt-optimization.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer></body></html>