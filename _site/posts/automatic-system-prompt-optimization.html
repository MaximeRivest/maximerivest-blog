<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Maxime Rivest">
<meta name="dcterms.date" content="2025-07-21">
<meta name="description" content="In this tutorial, I will teach you how to automatically optimize your System Prompt.">

<title>Automatic System Prompt Optimization – Maxime Rivest</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-532FMB8ETS"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-532FMB8ETS', { 'anonymize_ip': true});
</script>
<style>
.cell-output-stdout {
  overflow-y: scroll;
  max-height: 300px;
}
</style>


<link rel="stylesheet" href="../custom.css">
<meta name="twitter:title" content="Automatic System Prompt Optimization – Maxime Rivest">
<meta name="twitter:description" content="In this tutorial, I will teach you how to automatically optimize your System Prompt.">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Maxime Rivest</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://x.com/maximerivest"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.youtube.com/@maximerivest"> <i class="bi bi-youtube" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/maximerivest"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../posts.html"> 
<span class="menu-text">Posts</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-task" id="toc-the-task" class="nav-link active" data-scroll-target="#the-task">The task</a></li>
  <li><a href="#optimizing-a-non-existent-system-prompt" id="toc-optimizing-a-non-existent-system-prompt" class="nav-link" data-scroll-target="#optimizing-a-non-existent-system-prompt">Optimizing a non existent system prompt</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/MaximeRivest/maximerivest-blog/edit/main/posts/automatic-system-prompt-optimization.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header">
<div class="quarto-title-block"><div><h1 class="title">Automatic System Prompt Optimization</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
<p class="author">Maxime Rivest</p>

<p class="date">2025-07-21</p>
</header>


<p>DSPy has quite a reputation for its automatic prompt optimization capability. Despite that, DSPy is relatively hard to use to optimize a system prompt. DSPy is the implementation of a new Paradigm (one where you do not write prompt you rather focus on your program ), so it does not focus on optimizing a prompt but it rather focus on optimizing a program. Although, I very strongly recommend that you learn DSPy’s signature, AI programming and the Intent-Oriented Pragramming paradigm DSPy, sometimes you just want a better system prompt.</p>
<p>In this tutorial, I will show you how to optimize as system prompt given a trainset set. The system prompt will be rewritten automatically by an LLM in a loop for several steps.</p>
<section id="the-task" class="level2">
<h2 class="anchored" data-anchor-id="the-task">The task</h2>
<p>All throughout this tutorial our task will be to make an english to french translator. We will do several optimization and will evolve that task as we progress through that tutorial, but it will always be variants of that.</p>
</section>
<section id="optimizing-a-non-existent-system-prompt" class="level2">
<h2 class="anchored" data-anchor-id="optimizing-a-non-existent-system-prompt">Optimizing a non existent system prompt</h2>
<p>As a first task, we will start with an empty system prompt and we will have dspy’s optimizer deduce the system prompt based on the training set</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Setting up
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>For this tutorial, you will only need to install dspy and setup a LLM connections. I will be using several LLMs to demonstrate how easy it is to switch between them and show the student/teacher concept. You can however set only one up if you want. If you use a locally hosted model, (you can!) simply skip the setting up of the API key. .</p>
<p>For this tutorial, I have will use Kimi-K2 hosted by Groq <a href="https://console.groq.com/keys">Click here to get a groq api key</a> and Llama models from OpenRouter <a href="https://openrouter.ai/settings/keys">Click here to get a OpenRouter key</a>.</p>
<div class="callout callout-style-simple callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
python library requirements
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>I like to use uv to install my libraries.</p>
<div id="6cc34524" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>uv pip install dspy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
api key setup
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>I generally setup my key permanently but you can also do this to set it up just for here and now.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="in">import os</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="in">os.environ["GROQ_API_KEY"] = "[REDACTED]"</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="in">os.environ["OPENROUTER_API_KEY"] = "[REDACTED]"</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-simple callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Make GROQ_API_KEY permanent
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Replace GROQ_API_KEY with OPENROUTER_API_KEY to set openrouter key permanently on your system.</p>
<section id="linux-macos" class="level6">
<h6 class="anchored" data-anchor-id="linux-macos">Linux / macOS</h6>
<p>Append to your shell start-up file (pick the one you actually use):</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"export GROQ_API_KEY='gsk_[REDACTED]'"</span> <span class="op">&gt;&gt;</span> ~/.bashrc</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># or ~/.zshrc, ~/.profile, etc.</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> ~/.bashrc   <span class="co"># reload once</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="windows-cmd" class="level6">
<h6 class="anchored" data-anchor-id="windows-cmd">Windows – CMD</h6>
<div class="sourceCode" id="cb4"><pre class="sourceCode cmd code-with-copy"><code class="sourceCode dosbat"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>setx GROQ_API_KEY <span class="st">"gsk_[REDACTED]"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Close and reopen the terminal.</p>
</section>
<section id="windows-powershell" class="level6">
<h6 class="anchored" data-anchor-id="windows-powershell">Windows – PowerShell</h6>
<div class="sourceCode" id="cb5"><pre class="sourceCode powershell code-with-copy"><code class="sourceCode powershell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="op">[</span>Environment<span class="op">]::</span>SetEnvironmentVariable<span class="op">(</span><span class="st">"GROQ_API_KEY"</span><span class="op">,</span> <span class="st">"gsk_[REDACTED]"</span><span class="op">,</span> <span class="st">"User"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Refresh with <code>refreshenv</code> or open a new window.</p>
</section>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<p>Usually the first thing to do whenever you work with dspy is to first configure you llm connection.</p>
<div id="3196498e" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dspy</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>kimi <span class="op">=</span> dspy.LM(<span class="st">"groq/moonshotai/kimi-k2-instruct"</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>dspy.configure(lm <span class="op">=</span> kimi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you are new, to dspy. Kimi can now be call just like that:</p>
<div id="5ddaf071" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>kimi(<span class="st">"Hello"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>['Hello! How can I help you today?']</code></pre>
</div>
</div>
<p>Although, convenient. This is never really used, when you are using DSPy according to it’s paradigm, in DSPy you would be using and calling a program instead. More like that:</p>
<div id="ff686695" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> signature(dspy.Signature):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">    You are a Pirate</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    prompt <span class="op">=</span> dspy.InputField()</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    generation <span class="op">=</span> dspy.OutputField()</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>my_program <span class="op">=</span> dspy.Predict(signature) </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>my_program(prompt <span class="op">=</span> <span class="st">"Hello :)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>Prediction(
    generation='Ahoy there, ye land-lubbin’ scallywag! Ye greetin’ be as gentle as a sea breeze, but don’t be fooled—I’ll still keelhaul ye if ye cross me. Now, what brings ye aboard me deck, eh? Speak swift, lest I make ye walk the plank!'
)</code></pre>
</div>
</div>
<p>It is out of scope to explain all about predict and signatures here as my goal is to simply get you to do automatic system prompt optimization. So let’s now focus on that. For optimization we need a training set. DSPy expects the training set to be a list of Example dspy object so we will create our training set like that:</p>
<div id="a58ddc9f" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>examples <span class="op">=</span> [</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"I'm going to the convenience store."</span>, generation<span class="op">=</span><span class="st">"Je m'en vais au dépanneur."</span>),</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"It's really cold out today."</span>, generation<span class="op">=</span><span class="st">"Il fait frette en maudit aujourd'hui."</span>),</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"Can you help me move this weekend?"</span>, generation<span class="op">=</span><span class="st">"Tu peux m'aider à déménager ce weekend?"</span>),</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"We were stuck in traffic for two hours."</span>, generation<span class="op">=</span><span class="st">"On était pognés dans le trafic pendant deux heures."</span>),</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"She's my girlfriend."</span>, generation<span class="op">=</span><span class="st">"C'est ma blonde."</span>),</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"That car is so cool!"</span>, generation<span class="op">=</span><span class="st">"C'est ben l'fun ce char-là!"</span>),</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"I'll call you tonight."</span>, generation<span class="op">=</span><span class="st">"Je vais t'appeler ce soir."</span>),</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"He's always bragging."</span>, generation<span class="op">=</span><span class="st">"Il se vente tout l'temps."</span>),</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"We grabbed a coffee at Tim's."</span>, generation<span class="op">=</span><span class="st">"On a pris un café au Tim."</span>),</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"Close the window, it's chilly."</span>, generation<span class="op">=</span><span class="st">"Ferme la fenêtre, y fait frette."</span>),</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"I have an appointment at 3."</span>, generation<span class="op">=</span><span class="st">"J'ai un rendez-vous à trois heures."</span>),</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"They're celebrating their birthday."</span>, generation<span class="op">=</span><span class="st">"Ils fêtent leur fête."</span>),</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"I parked in the back."</span>, generation<span class="op">=</span><span class="st">"J'ai stationné dans l'fond."</span>),</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"The metro is packed."</span>, generation<span class="op">=</span><span class="st">"Le métro est plein à craquer."</span>),</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"We watched a movie last night."</span>, generation<span class="op">=</span><span class="st">"On a écouté un film hier soir."</span>),</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"I need to do my groceries."</span>, generation<span class="op">=</span><span class="st">"J'dois faire mon épicerie."</span>),</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"Don't forget your boots."</span>, generation<span class="op">=</span><span class="st">"Oublie pas tes bottes."</span>),</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"It's snowing again."</span>, generation<span class="op">=</span><span class="st">"Il neige encore."</span>),</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"I'll take the bus."</span>, generation<span class="op">=</span><span class="st">"J'va prendre l'bus."</span>),</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"We're out of milk."</span>, generation<span class="op">=</span><span class="st">"On est à court de lait."</span>),</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>trainset <span class="op">=</span> [x.with_inputs(<span class="st">'prompt'</span>) <span class="cf">for</span> x <span class="kw">in</span> examples]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here the task</p>
<div id="4aac1e62" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> format_demos(demos):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Wrap every demo once – no duplicated header lines.</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    parts <span class="op">=</span> [<span class="st">"Here are examples of your expected behavior."</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>             <span class="st">"&lt;examples&gt;"</span>]</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, demo <span class="kw">in</span> <span class="bu">enumerate</span>(demos, <span class="dv">1</span>):</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        parts <span class="op">+=</span> [</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"&lt;example_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">&gt;"</span>,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">"User:"</span>,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>            demo[<span class="st">"prompt"</span>],</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Assistant:"</span>,</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>            demo[<span class="st">"generation"</span>],</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"&lt;/example_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">&gt;"</span>,</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    parts.append(<span class="st">"&lt;/examples&gt;"</span>)</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(parts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="ffcdecb6" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the SimplestAdapter as before</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SimplestAdapter(dspy.Adapter):</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, lm, lm_kwargs, signature, demos, inputs):</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(inputs)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        system_content <span class="op">=</span> signature.instructions</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> demos:</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>            system_content <span class="op">+=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> format_demos(demos)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>        messages <span class="op">=</span> [</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"role"</span>: <span class="st">"system"</span>, <span class="st">"content"</span>: system_content},</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: inputs[<span class="st">"prompt"</span>]},</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        outputs <span class="op">=</span> lm(messages<span class="op">=</span>messages, <span class="op">**</span>lm_kwargs)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [{<span class="st">"generation"</span>: outputs[<span class="dv">0</span>]}]</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Do NOT call dspy.configure(adapter=SimplestAdapter())</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Subclass Predict to use the custom adapter only for this instance</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyPredict(dspy.Predict):</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, <span class="op">**</span>kwargs):</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>        adapter <span class="op">=</span> SimplestAdapter()</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> dspy.settings.context(adapter<span class="op">=</span>adapter):</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">super</span>().forward(<span class="op">**</span>kwargs)</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Use MyPredict instead of dspy.Predict</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> signature(dspy.Signature):</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    prompt <span class="op">=</span> dspy.InputField()</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    generation <span class="op">=</span> dspy.OutputField()</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>system_prompt <span class="op">=</span> <span class="st">" "</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>my_program <span class="op">=</span> MyPredict(signature.with_instructions(system_prompt))</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Test</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>my_program(prompt<span class="op">=</span><span class="st">"Hi how are you?"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'prompt': 'Hi how are you?'}</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>Prediction(
    generation="Hi! I'm doing well—thanks for asking. How about you?"
)</code></pre>
</div>
</div>
<div id="f7414e99" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_french(text):</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Naive French detector: check for common French words/accents</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    french_markers <span class="op">=</span> [</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>        <span class="vs">r"\b(le|la|les|un|une|des|du|de|et|à|est|sont|avec|pour|sur|par|mais|ou|où|que|qui|quand|comment|nous|vous|ils|elles|ça|ce|cette|ces)\b"</span>,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>        <span class="vs">r"[éèêàùçîôâœëïü]"</span>,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">any</span>(re.search(marker, text.lower()) <span class="cf">for</span> marker <span class="kw">in</span> french_markers)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> translation_judge(example, prediction, trace<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Return 1.0 if the output looks French, else 0.0.</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Doing the cast explicitly guarantees we never hand DSPy a None.</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> prediction.get(<span class="st">"generation"</span>, <span class="st">""</span>) <span class="kw">or</span> <span class="st">""</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">float</span>(is_french(output))</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Anything weird is just a miss</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="28225a36" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> dspy.MIPROv2(translation_judge, max_bootstrapped_demos <span class="op">=</span> <span class="dv">0</span>, max_labeled_demos <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>my_program_optimized <span class="op">=</span> optimizer.<span class="bu">compile</span>(my_program, trainset<span class="op">=</span>trainset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/22 08:30:18 INFO dspy.teleprompt.mipro_optimizer_v2: 
RUNNING WITH THE FOLLOWING LIGHT AUTO RUN SETTINGS:
num_trials: 9
minibatch: False
num_fewshot_candidates: 6
num_instruct_candidates: 6
valset size: 16
</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Projected Language Model (LM) Calls

Based on the parameters you have set, the maximum number of LM calls is projected as follows:

- Prompt Generation: 10 data summarizer calls + 6 * 1 lm calls in program + (2) lm calls in program-aware proposer = 18 prompt model calls
- Program Evaluation: 16 examples in val set * 9 batches = 144 LM program calls

Estimated Cost Calculation:

Total Cost = (Number of calls to task model * (Avg Input Token Length per Call * Task Model Price per Input Token + Avg Output Token Length per Call * Task Model Price per Output Token)
            + (Number of program calls * (Avg Input Token Length per Call * Task Prompt Price per Input Token + Avg Output Token Length per Call * Prompt Model Price per Output Token).

For a preliminary estimate of potential costs, we recommend you perform your own calculations based on the task
and prompt models you intend to use. If the projected costs exceed your budget or expectations, you may consider:

- Reducing the number of trials (`num_trials`), the size of the valset, or the number of LM calls in your program.
- Using a cheaper task model to optimize the prompt.
- Setting `minibatch=True` if you haven't already.

To proceed with the execution of this program, please confirm by typing 'y' for yes or 'n' for no.
If no input is received within 20 seconds, the program will proceed automatically.

If you would like to bypass this confirmation step in future executions, set the `requires_permission_to_run` flag to `False` when calling compile.

Awaiting your input...

Do you wish to continue? (y/n): </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/22 08:30:18 INFO dspy.teleprompt.mipro_optimizer_v2: Compilation aborted by the user.</code></pre>
</div>
</div>
<div id="d3373eec" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>my_program_optimized(prompt <span class="op">=</span> <span class="st">"Hi how are you?"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'prompt': 'Hi how are you?'}</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>Prediction(
    generation="Hi! I'm doing well—thanks for asking. How about you?"
)</code></pre>
</div>
</div>
<div id="5d659e89" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>my_program_optimized.inspect_history()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>



[2025-07-22T08:30:18.429887]

System message:




User message:

Hi how are you?


Response:

Hi! I'm doing well—thanks for asking. How about you?




</code></pre>
</div>
</div>
<div id="fe9234fa" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>evaluator <span class="op">=</span> dspy.Evaluate(devset <span class="op">=</span> trainset, metric<span class="op">=</span>translation_judge)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>evaluator(my_program_optimized)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/22 08:30:18 INFO dspy.evaluate.evaluate: Average Metric: 0.0 / 20 (0.0%)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>{'prompt': 'We were stuck in traffic for two hours.'}{'prompt': "She's my girlfriend."}

{'prompt': "It's really cold out today."}
{'prompt': 'That car is so cool!'}
{'prompt': 'Can you help me move this weekend?'}
{'prompt': "I'll call you tonight."}
{'prompt': "I'm going to the convenience store."}
{'prompt': "He's always bragging."}
{'prompt': "We grabbed a coffee at Tim's."}
{'prompt': "Close the window, it's chilly."}
{'prompt': 'I have an appointment at 3.'}
{'prompt': 'I parked in the back.'}
{'prompt': 'The metro is packed.'}
{'prompt': "They're celebrating their birthday."}
{'prompt': 'We watched a movie last night.'}
{'prompt': 'I need to do my groceries.'}
{'prompt': "Don't forget your boots."}
{'prompt': "It's snowing again."}
{'prompt': "I'll take the bus."}
{'prompt': "We're out of milk."}</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>EvaluationResult(score=0.0, results=&lt;list of 20 results&gt;)</code></pre>
</div>
</div>
<div id="45b3060c" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>evaluator <span class="op">=</span> dspy.Evaluate(devset <span class="op">=</span> trainset, metric<span class="op">=</span>translation_judge)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>evaluator(my_program)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/22 08:30:18 INFO dspy.evaluate.evaluate: Average Metric: 0.0 / 20 (0.0%)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>{'prompt': "I'm going to the convenience store."}
{'prompt': 'Can you help me move this weekend?'}
{'prompt': 'We were stuck in traffic for two hours.'}
{'prompt': "It's really cold out today."}
{'prompt': "She's my girlfriend."}
{'prompt': "I'll call you tonight."}
{'prompt': 'That car is so cool!'}
{'prompt': "Close the window, it's chilly."}
{'prompt': 'I have an appointment at 3.'}
{'prompt': 'I parked in the back.'}
{'prompt': 'The metro is packed.'}
{'prompt': "He's always bragging."}
{'prompt': "They're celebrating their birthday."}
{'prompt': "We grabbed a coffee at Tim's."}
{'prompt': "Don't forget your boots."}
{'prompt': "I'll take the bus."}
{'prompt': 'I need to do my groceries.'}
{'prompt': "We're out of milk."}
{'prompt': 'We watched a movie last night.'}
{'prompt': "It's snowing again."}</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>EvaluationResult(score=0.0, results=&lt;list of 20 results&gt;)</code></pre>
</div>
</div>
<div id="fc9b60ef" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> dspy.MIPROv2(translation_judge, max_bootstrapped_demos <span class="op">=</span> <span class="dv">2</span>, max_labeled_demos <span class="op">=</span> <span class="dv">2</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>my_program_optimized_with_demo <span class="op">=</span> optimizer.<span class="bu">compile</span>(my_program, trainset<span class="op">=</span>trainset)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/22 08:30:18 INFO dspy.teleprompt.mipro_optimizer_v2: 
RUNNING WITH THE FOLLOWING LIGHT AUTO RUN SETTINGS:
num_trials: 10
minibatch: False
num_fewshot_candidates: 6
num_instruct_candidates: 3
valset size: 16
</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Projected Language Model (LM) Calls

Based on the parameters you have set, the maximum number of LM calls is projected as follows:

- Prompt Generation: 10 data summarizer calls + 3 * 1 lm calls in program + (2) lm calls in program-aware proposer = 15 prompt model calls
- Program Evaluation: 16 examples in val set * 10 batches = 160 LM program calls

Estimated Cost Calculation:

Total Cost = (Number of calls to task model * (Avg Input Token Length per Call * Task Model Price per Input Token + Avg Output Token Length per Call * Task Model Price per Output Token)
            + (Number of program calls * (Avg Input Token Length per Call * Task Prompt Price per Input Token + Avg Output Token Length per Call * Prompt Model Price per Output Token).

For a preliminary estimate of potential costs, we recommend you perform your own calculations based on the task
and prompt models you intend to use. If the projected costs exceed your budget or expectations, you may consider:

- Reducing the number of trials (`num_trials`), the size of the valset, or the number of LM calls in your program.
- Using a cheaper task model to optimize the prompt.
- Setting `minibatch=True` if you haven't already.

To proceed with the execution of this program, please confirm by typing 'y' for yes or 'n' for no.
If no input is received within 20 seconds, the program will proceed automatically.

If you would like to bypass this confirmation step in future executions, set the `requires_permission_to_run` flag to `False` when calling compile.

Awaiting your input...

Do you wish to continue? (y/n): </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/22 08:30:18 INFO dspy.teleprompt.mipro_optimizer_v2: Compilation aborted by the user.</code></pre>
</div>
</div>
<div id="b511004b" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>my_program_optimized_with_demo(prompt <span class="op">=</span> <span class="st">"Hi how are you?"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'prompt': 'Hi how are you?'}</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>Prediction(
    generation="Hi! I'm doing well—thanks for asking. How about you?"
)</code></pre>
</div>
</div>
<div id="1a0580f4" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>my_program_optimized_with_demo.inspect_history()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>



[2025-07-22T08:30:18.577775]

System message:




User message:

Hi how are you?


Response:

Hi! I'm doing well—thanks for asking. How about you?




</code></pre>
</div>
</div>
<div id="12e9c5ea" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> dspy.BootstrapFewShotWithOptuna(translation_judge, max_bootstrapped_demos <span class="op">=</span> <span class="dv">10</span>, max_labeled_demos <span class="op">=</span> <span class="dv">10</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>my_program_optimized_with_demo <span class="op">=</span> optimizer.<span class="bu">compile</span>(my_program, trainset<span class="op">=</span>trainset, max_demos<span class="op">=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Going to sample between 1 and 10 traces per predictor.
Will attempt to train 16 candidate sets.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  0%|          | 0/20 [00:00&lt;?, ?it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>{'prompt': "I'm going to the convenience store."}
{'prompt': "It's really cold out today."}
{'prompt': 'Can you help me move this weekend?'}</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 15%|█▌        | 3/20 [00:00&lt;00:00, 82.38it/s]
[I 2025-07-22 08:30:18,796] A new study created in memory with name: no-name-694786fb-1374-4c43-84d3-ba5bb3382d3b</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Bootstrapped 3 full traces after 3 examples for up to 1 rounds, amounting to 3 attempts.
{'prompt': "It's really cold out today."}
{'prompt': "I'm going to the convenience store."}
{'prompt': 'We were stuck in traffic for two hours.'}
{'prompt': 'Can you help me move this weekend?'}
{'prompt': "I'll call you tonight."}
{'prompt': "He's always bragging."}
{'prompt': "She's my girlfriend."}
{'prompt': 'That car is so cool!'}
  0%|          | 0/20 [00:00&lt;?, ?it/s]Average Metric: 1.00 / 1 (100.0%):   0%|          | 0/20 [00:00&lt;?, ?it/s]{'prompt': "We grabbed a coffee at Tim's."}
Average Metric: 2.00 / 2 (100.0%):   5%|▌         | 1/20 [00:00&lt;00:00, 85.50it/s]{'prompt': 'I have an appointment at 3.'}
{'prompt': 'The metro is packed.'}{'prompt': "Close the window, it's chilly."}

{'prompt': 'We watched a movie last night.'}
{'prompt': "They're celebrating their birthday."}
Average Metric: 3.00 / 3 (100.0%):  10%|█         | 2/20 [00:00&lt;00:00, 102.09it/s]{'prompt': 'I need to do my groceries.'}
Average Metric: 4.00 / 4 (100.0%):  15%|█▌        | 3/20 [00:00&lt;00:00, 136.11it/s]{'prompt': 'I parked in the back.'}
Average Metric: 5.00 / 5 (100.0%):  20%|██        | 4/20 [00:00&lt;00:00, 162.55it/s]Average Metric: 6.00 / 6 (100.0%):  25%|██▌       | 5/20 [00:00&lt;00:00, 193.11it/s]Average Metric: 7.00 / 7 (100.0%):  30%|███       | 6/20 [00:00&lt;00:00, 224.84it/s]Average Metric: 7.00 / 8 (87.5%):  35%|███▌      | 7/20 [00:00&lt;00:00, 252.70it/s] Average Metric: 8.00 / 9 (88.9%):  40%|████      | 8/20 [00:00&lt;00:00, 223.00it/s]Average Metric: 9.00 / 10 (90.0%):  45%|████▌     | 9/20 [00:00&lt;00:00, 234.49it/s]{'prompt': "I'll take the bus."}
Average Metric: 10.00 / 11 (90.9%):  50%|█████     | 10/20 [00:00&lt;00:00, 248.45it/s]{'prompt': "It's snowing again."}
{'prompt': "Don't forget your boots."}
Average Metric: 11.00 / 12 (91.7%):  55%|█████▌    | 11/20 [00:00&lt;00:00, 246.57it/s]Average Metric: 12.00 / 13 (92.3%):  60%|██████    | 12/20 [00:00&lt;00:00, 257.01it/s]Average Metric: 13.00 / 14 (92.9%):  65%|██████▌   | 13/20 [00:00&lt;00:00, 273.13it/s]{'prompt': "We're out of milk."}
Average Metric: 14.00 / 15 (93.3%):  70%|███████   | 14/20 [00:00&lt;00:00, 275.95it/s]Average Metric: 15.00 / 16 (93.8%):  75%|███████▌  | 15/20 [00:00&lt;00:00, 278.53it/s]Average Metric: 16.00 / 17 (94.1%):  80%|████████  | 16/20 [00:00&lt;00:00, 290.40it/s]Average Metric: 16.00 / 18 (88.9%):  85%|████████▌ | 17/20 [00:00&lt;00:00, 300.05it/s]Average Metric: 16.00 / 19 (84.2%):  90%|█████████ | 18/20 [00:00&lt;00:00, 310.11it/s]Average Metric: 17.00 / 20 (85.0%):  95%|█████████▌| 19/20 [00:00&lt;00:00, 319.54it/s]Average Metric: 17.00 / 20 (85.0%): 100%|██████████| 20/20 [00:00&lt;00:00, 332.31it/s]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/22 08:30:18 INFO dspy.evaluate.evaluate: Average Metric: 17.0 / 20 (85.0%)
[I 2025-07-22 08:30:18,876] Trial 0 finished with value: 85.0 and parameters: {'demo_index_for_self': 3}. Best is trial 0 with value: 85.0.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
{'prompt': "It's really cold out today."}
{'prompt': "I'm going to the convenience store."}
{'prompt': 'We were stuck in traffic for two hours.'}
{'prompt': 'Can you help me move this weekend?'}
{'prompt': 'That car is so cool!'}
{'prompt': "I'll call you tonight."}
{'prompt': "He's always bragging."}
{'prompt': "She's my girlfriend."}
  0%|          | 0/20 [00:00&lt;?, ?it/s]Average Metric: 1.00 / 1 (100.0%):   0%|          | 0/20 [00:00&lt;?, ?it/s]{'prompt': 'I have an appointment at 3.'}
{'prompt': "We grabbed a coffee at Tim's."}
{'prompt': "They're celebrating their birthday."}
{'prompt': 'I parked in the back.'}
Average Metric: 2.00 / 2 (100.0%):   5%|▌         | 1/20 [00:00&lt;00:00, 73.54it/s]{'prompt': "Close the window, it's chilly."}
Average Metric: 3.00 / 3 (100.0%):  10%|█         | 2/20 [00:00&lt;00:00, 120.86it/s]Average Metric: 4.00 / 4 (100.0%):  15%|█▌        | 3/20 [00:00&lt;00:00, 166.42it/s]{'prompt': 'We watched a movie last night.'}
{'prompt': 'The metro is packed.'}
Average Metric: 4.00 / 5 (80.0%):  20%|██        | 4/20 [00:00&lt;00:00, 191.15it/s] Average Metric: 5.00 / 6 (83.3%):  25%|██▌       | 5/20 [00:00&lt;00:00, 225.44it/s]Average Metric: 6.00 / 7 (85.7%):  30%|███       | 6/20 [00:00&lt;00:00, 262.41it/s]Average Metric: 7.00 / 8 (87.5%):  35%|███▌      | 7/20 [00:00&lt;00:00, 285.36it/s]{'prompt': 'I need to do my groceries.'}
Average Metric: 8.00 / 9 (88.9%):  40%|████      | 8/20 [00:00&lt;00:00, 277.65it/s]{'prompt': "Don't forget your boots."}
Average Metric: 9.00 / 10 (90.0%):  45%|████▌     | 9/20 [00:00&lt;00:00, 245.57it/s]{'prompt': "It's snowing again."}
Average Metric: 10.00 / 11 (90.9%):  50%|█████     | 10/20 [00:00&lt;00:00, 248.84it/s]Average Metric: 11.00 / 12 (91.7%):  55%|█████▌    | 11/20 [00:00&lt;00:00, 257.47it/s]{'prompt': "We're out of milk."}
{'prompt': "I'll take the bus."}
Average Metric: 12.00 / 13 (92.3%):  60%|██████    | 12/20 [00:00&lt;00:00, 260.83it/s]Average Metric: 13.00 / 14 (92.9%):  65%|██████▌   | 13/20 [00:00&lt;00:00, 268.26it/s]Average Metric: 14.00 / 15 (93.3%):  70%|███████   | 14/20 [00:00&lt;00:00, 279.56it/s]Average Metric: 15.00 / 16 (93.8%):  75%|███████▌  | 15/20 [00:00&lt;00:00, 288.73it/s]Average Metric: 15.00 / 17 (88.2%):  80%|████████  | 16/20 [00:00&lt;00:00, 296.17it/s]Average Metric: 16.00 / 18 (88.9%):  85%|████████▌ | 17/20 [00:00&lt;00:00, 302.41it/s]Average Metric: 16.00 / 19 (84.2%):  90%|█████████ | 18/20 [00:00&lt;00:00, 315.13it/s]Average Metric: 17.00 / 20 (85.0%):  95%|█████████▌| 19/20 [00:00&lt;00:00, 329.47it/s]Average Metric: 17.00 / 20 (85.0%): 100%|██████████| 20/20 [00:00&lt;00:00, 343.36it/s]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/22 08:30:18 INFO dspy.evaluate.evaluate: Average Metric: 17.0 / 20 (85.0%)
[I 2025-07-22 08:30:18,958] Trial 1 finished with value: 85.0 and parameters: {'demo_index_for_self': 7}. Best is trial 0 with value: 85.0.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
{'prompt': "It's really cold out today."}
{'prompt': 'Can you help me move this weekend?'}
{'prompt': 'We were stuck in traffic for two hours.'}
{'prompt': "She's my girlfriend."}
{'prompt': "I'm going to the convenience store."}
{'prompt': "I'll call you tonight."}
{'prompt': 'That car is so cool!'}
{'prompt': "He's always bragging."}
  0%|          | 0/20 [00:00&lt;?, ?it/s]Average Metric: 1.00 / 1 (100.0%):   0%|          | 0/20 [00:00&lt;?, ?it/s]{'prompt': "We grabbed a coffee at Tim's."}
Average Metric: 2.00 / 2 (100.0%):   5%|▌         | 1/20 [00:00&lt;00:00, 97.34it/s]{'prompt': "Close the window, it's chilly."}
{'prompt': 'I have an appointment at 3.'}
Average Metric: 3.00 / 3 (100.0%):  10%|█         | 2/20 [00:00&lt;00:00, 133.54it/s]Average Metric: 4.00 / 4 (100.0%):  15%|█▌        | 3/20 [00:00&lt;00:00, 179.11it/s]Average Metric: 5.00 / 5 (100.0%):  20%|██        | 4/20 [00:00&lt;00:00, 201.05it/s]{'prompt': 'I parked in the back.'}
{'prompt': 'The metro is packed.'}
{'prompt': "They're celebrating their birthday."}
Average Metric: 6.00 / 6 (100.0%):  25%|██▌       | 5/20 [00:00&lt;00:00, 205.87it/s]Average Metric: 6.00 / 7 (85.7%):  30%|███       | 6/20 [00:00&lt;00:00, 227.92it/s] {'prompt': 'We watched a movie last night.'}
Average Metric: 7.00 / 8 (87.5%):  35%|███▌      | 7/20 [00:00&lt;00:00, 220.49it/s]{'prompt': 'I need to do my groceries.'}
Average Metric: 8.00 / 9 (88.9%):  40%|████      | 8/20 [00:00&lt;00:00, 215.10it/s]{'prompt': "Don't forget your boots."}
Average Metric: 9.00 / 10 (90.0%):  45%|████▌     | 9/20 [00:00&lt;00:00, 214.52it/s]{'prompt': "It's snowing again."}
{'prompt': "I'll take the bus."}
Average Metric: 10.00 / 11 (90.9%):  50%|█████     | 10/20 [00:00&lt;00:00, 203.46it/s]Average Metric: 11.00 / 12 (91.7%):  55%|█████▌    | 11/20 [00:00&lt;00:00, 207.64it/s]Average Metric: 12.00 / 13 (92.3%):  60%|██████    | 12/20 [00:00&lt;00:00, 217.91it/s]Average Metric: 13.00 / 14 (92.9%):  65%|██████▌   | 13/20 [00:00&lt;00:00, 229.36it/s]{'prompt': "We're out of milk."}
Average Metric: 14.00 / 15 (93.3%):  70%|███████   | 14/20 [00:00&lt;00:00, 228.92it/s]Average Metric: 15.00 / 16 (93.8%):  75%|███████▌  | 15/20 [00:00&lt;00:00, 231.13it/s]Average Metric: 15.00 / 17 (88.2%):  80%|████████  | 16/20 [00:00&lt;00:00, 240.09it/s]Average Metric: 15.00 / 18 (83.3%):  85%|████████▌ | 17/20 [00:00&lt;00:00, 245.48it/s]Average Metric: 16.00 / 19 (84.2%):  90%|█████████ | 18/20 [00:00&lt;00:00, 251.70it/s]Average Metric: 16.00 / 20 (80.0%):  95%|█████████▌| 19/20 [00:00&lt;00:00, 263.05it/s]Average Metric: 16.00 / 20 (80.0%): 100%|██████████| 20/20 [00:00&lt;00:00, 274.14it/s]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/22 08:30:19 INFO dspy.evaluate.evaluate: Average Metric: 16.0 / 20 (80.0%)
[I 2025-07-22 08:30:19,057] Trial 2 finished with value: 80.0 and parameters: {'demo_index_for_self': 4}. Best is trial 0 with value: 85.0.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>{'prompt': 'Can you help me move this weekend?'}
{'prompt': 'We were stuck in traffic for two hours.'}
{'prompt': 'That car is so cool!'}
{'prompt': "She's my girlfriend."}
{'prompt': "I'm going to the convenience store."}
{'prompt': "It's really cold out today."}
{'prompt': "Close the window, it's chilly."}
{'prompt': 'I parked in the back.'}
{'prompt': 'I have an appointment at 3.'}
{'prompt': "We grabbed a coffee at Tim's."}
{'prompt': 'I need to do my groceries.'}
{'prompt': "Don't forget your boots."}
{'prompt': "We're out of milk."}
{'prompt': "They're celebrating their birthday."}
{'prompt': "It's snowing again."}
{'prompt': "I'll call you tonight."}
{'prompt': 'The metro is packed.'}
{'prompt': 'We watched a movie last night.'}
  0%|          | 0/20 [00:00&lt;?, ?it/s]{'prompt': "I'll take the bus."}
{'prompt': "He's always bragging."}Average Metric: 1.00 / 1 (100.0%):   0%|          | 0/20 [00:00&lt;?, ?it/s]
Average Metric: 2.00 / 2 (100.0%):   5%|▌         | 1/20 [00:00&lt;00:00, 682.00it/s]Average Metric: 3.00 / 3 (100.0%):  10%|█         | 2/20 [00:00&lt;00:00, 981.81it/s]Average Metric: 4.00 / 4 (100.0%):  15%|█▌        | 3/20 [00:00&lt;00:00, 1171.27it/s]Average Metric: 5.00 / 5 (100.0%):  20%|██        | 4/20 [00:00&lt;00:00, 1214.42it/s]Average Metric: 5.00 / 6 (83.3%):  25%|██▌       | 5/20 [00:00&lt;00:00, 1254.13it/s] Average Metric: 5.00 / 7 (71.4%):  30%|███       | 6/20 [00:00&lt;00:00, 1309.29it/s]Average Metric: 6.00 / 8 (75.0%):  35%|███▌      | 7/20 [00:00&lt;00:00, 1302.75it/s]Average Metric: 7.00 / 9 (77.8%):  40%|████      | 8/20 [00:00&lt;00:00, 1338.59it/s]Average Metric: 7.00 / 10 (70.0%):  45%|████▌     | 9/20 [00:00&lt;00:00, 1376.18it/s]Average Metric: 8.00 / 11 (72.7%):  50%|█████     | 10/20 [00:00&lt;00:00, 1413.18it/s]Average Metric: 9.00 / 12 (75.0%):  55%|█████▌    | 11/20 [00:00&lt;00:00, 1430.79it/s]Average Metric: 10.00 / 13 (76.9%):  60%|██████    | 12/20 [00:00&lt;00:00, 1424.21it/s]Average Metric: 11.00 / 14 (78.6%):  65%|██████▌   | 13/20 [00:00&lt;00:00, 1433.50it/s]Average Metric: 12.00 / 15 (80.0%):  70%|███████   | 14/20 [00:00&lt;00:00, 1422.42it/s]Average Metric: 13.00 / 16 (81.2%):  75%|███████▌  | 15/20 [00:00&lt;00:00, 1426.63it/s]Average Metric: 14.00 / 17 (82.4%):  80%|████████  | 16/20 [00:00&lt;00:00, 1439.36it/s]Average Metric: 15.00 / 18 (83.3%):  85%|████████▌ | 17/20 [00:00&lt;00:00, 1450.90it/s]Average Metric: 16.00 / 19 (84.2%):  90%|█████████ | 18/20 [00:00&lt;00:00, 1466.17it/s]Average Metric: 17.00 / 20 (85.0%):  95%|█████████▌| 19/20 [00:00&lt;00:00, 1468.70it/s]Average Metric: 17.00 / 20 (85.0%): 100%|██████████| 20/20 [00:00&lt;00:00, 1474.19it/s]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/22 08:30:19 INFO dspy.evaluate.evaluate: Average Metric: 17.0 / 20 (85.0%)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[I 2025-07-22 08:30:19,112] Trial 3 finished with value: 85.0 and parameters: {'demo_index_for_self': 3}. Best is trial 0 with value: 85.0.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>{'prompt': "It's really cold out today."}
{'prompt': 'Can you help me move this weekend?'}
{'prompt': 'We were stuck in traffic for two hours.'}
{'prompt': "I'm going to the convenience store."}
{'prompt': "He's always bragging."}
{'prompt': "I'll call you tonight."}{'prompt': "Close the window, it's chilly."}
{'prompt': 'I have an appointment at 3.'}
{'prompt': "They're celebrating their birthday."}

{'prompt': "She's my girlfriend."}
{'prompt': "We grabbed a coffee at Tim's."}
{'prompt': 'The metro is packed.'}
{'prompt': 'We watched a movie last night.'}
{'prompt': "Don't forget your boots."}
{'prompt': 'I parked in the back.'}
{'prompt': "It's snowing again."}
{'prompt': "We're out of milk."}
{'prompt': "I'll take the bus."}
{'prompt': 'I need to do my groceries.'}
  0%|          | 0/20 [00:00&lt;?, ?it/s]Average Metric: 1.00 / 1 (100.0%):   0%|          | 0/20 [00:00&lt;?, ?it/s]Average Metric: 2.00 / 2 (100.0%):   5%|▌         | 1/20 [00:00&lt;00:00, 1192.58it/s]Average Metric: 2.00 / 3 (66.7%):  10%|█         | 2/20 [00:00&lt;00:00, 886.56it/s]  Average Metric: 3.00 / 4 (75.0%):  15%|█▌        | 3/20 [00:00&lt;00:00, 824.14it/s]Average Metric: 3.00 / 5 (60.0%):  20%|██        | 4/20 [00:00&lt;00:00, 879.45it/s]Average Metric: 4.00 / 6 (66.7%):  25%|██▌       | 5/20 [00:00&lt;00:00, 950.18it/s]Average Metric: 4.00 / 7 (57.1%):  30%|███       | 6/20 [00:00&lt;00:00, 984.81it/s]Average Metric: 5.00 / 8 (62.5%):  35%|███▌      | 7/20 [00:00&lt;00:00, 952.17it/s]Average Metric: 6.00 / 9 (66.7%):  40%|████      | 8/20 [00:00&lt;00:00, 970.09it/s]Average Metric: 7.00 / 10 (70.0%):  45%|████▌     | 9/20 [00:00&lt;00:00, 980.64it/s]Average Metric: 8.00 / 11 (72.7%):  50%|█████     | 10/20 [00:00&lt;00:00, 983.70it/s]Average Metric: 9.00 / 12 (75.0%):  55%|█████▌    | 11/20 [00:00&lt;00:00, 984.52it/s]Average Metric: 10.00 / 13 (76.9%):  60%|██████    | 12/20 [00:00&lt;00:00, 986.14it/s]Average Metric: 11.00 / 14 (78.6%):  65%|██████▌   | 13/20 [00:00&lt;00:00, 1001.51it/s]Average Metric: 12.00 / 15 (80.0%):  70%|███████   | 14/20 [00:00&lt;00:00, 1017.28it/s]Average Metric: 13.00 / 16 (81.2%):  75%|███████▌  | 15/20 [00:00&lt;00:00, 1034.44it/s]Average Metric: 14.00 / 17 (82.4%):  80%|████████  | 16/20 [00:00&lt;00:00, 981.60it/s] Average Metric: 15.00 / 18 (83.3%):  85%|████████▌ | 17/20 [00:00&lt;00:00, 1006.48it/s]Average Metric: 16.00 / 19 (84.2%):  90%|█████████ | 18/20 [00:00&lt;00:00, 1034.91it/s]{'prompt': 'That car is so cool!'}
Average Metric: 17.00 / 20 (85.0%):  95%|█████████▌| 19/20 [00:00&lt;00:00, 931.14it/s] Average Metric: 17.00 / 20 (85.0%): 100%|██████████| 20/20 [00:00&lt;00:00, 942.67it/s]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/22 08:30:19 INFO dspy.evaluate.evaluate: Average Metric: 17.0 / 20 (85.0%)
[I 2025-07-22 08:30:19,176] Trial 4 finished with value: 85.0 and parameters: {'demo_index_for_self': 3}. Best is trial 0 with value: 85.0.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
{'prompt': "I'm going to the convenience store."}
{'prompt': 'Can you help me move this weekend?'}
{'prompt': 'We were stuck in traffic for two hours.'}
{'prompt': "She's my girlfriend."}
{'prompt': 'That car is so cool!'}
{'prompt': "It's really cold out today."}
{'prompt': "He's always bragging."}
  0%|          | 0/20 [00:00&lt;?, ?it/s]{'prompt': "I'll call you tonight."}
{'prompt': "Close the window, it's chilly."}
Average Metric: 1.00 / 1 (100.0%):   0%|          | 0/20 [00:00&lt;?, ?it/s]{'prompt': "We grabbed a coffee at Tim's."}
{'prompt': 'I have an appointment at 3.'}
Average Metric: 1.00 / 2 (50.0%):   5%|▌         | 1/20 [00:00&lt;00:00, 60.30it/s]{'prompt': 'I parked in the back.'}
{'prompt': 'The metro is packed.'}
Average Metric: 2.00 / 3 (66.7%):  10%|█         | 2/20 [00:00&lt;00:00, 88.22it/s]{'prompt': "They're celebrating their birthday."}
{'prompt': 'I need to do my groceries.'}
Average Metric: 3.00 / 4 (75.0%):  15%|█▌        | 3/20 [00:00&lt;00:00, 112.95it/s]Average Metric: 4.00 / 5 (80.0%):  20%|██        | 4/20 [00:00&lt;00:00, 140.86it/s]{'prompt': 'We watched a movie last night.'}
Average Metric: 5.00 / 6 (83.3%):  25%|██▌       | 5/20 [00:00&lt;00:00, 156.38it/s]{'prompt': "It's snowing again."}
Average Metric: 6.00 / 7 (85.7%):  30%|███       | 6/20 [00:00&lt;00:00, 158.29it/s]{'prompt': "Don't forget your boots."}
Average Metric: 7.00 / 8 (87.5%):  35%|███▌      | 7/20 [00:00&lt;00:00, 173.98it/s]Average Metric: 8.00 / 9 (88.9%):  40%|████      | 8/20 [00:00&lt;00:00, 182.16it/s]Average Metric: 9.00 / 10 (90.0%):  45%|████▌     | 9/20 [00:00&lt;00:00, 187.68it/s]Average Metric: 10.00 / 11 (90.9%):  50%|█████     | 10/20 [00:00&lt;00:00, 188.17it/s]{'prompt': "We're out of milk."}
Average Metric: 11.00 / 12 (91.7%):  55%|█████▌    | 11/20 [00:00&lt;00:00, 194.73it/s]{'prompt': "I'll take the bus."}
Average Metric: 12.00 / 13 (92.3%):  60%|██████    | 12/20 [00:00&lt;00:00, 198.62it/s]Average Metric: 13.00 / 14 (92.9%):  65%|██████▌   | 13/20 [00:00&lt;00:00, 206.56it/s]Average Metric: 14.00 / 15 (93.3%):  70%|███████   | 14/20 [00:00&lt;00:00, 210.58it/s]Average Metric: 15.00 / 16 (93.8%):  75%|███████▌  | 15/20 [00:00&lt;00:00, 219.73it/s]Average Metric: 16.00 / 17 (94.1%):  80%|████████  | 16/20 [00:00&lt;00:00, 229.33it/s]Average Metric: 16.00 / 18 (88.9%):  85%|████████▌ | 17/20 [00:00&lt;00:00, 239.68it/s]Average Metric: 16.00 / 19 (84.2%):  90%|█████████ | 18/20 [00:00&lt;00:00, 244.45it/s]Average Metric: 17.00 / 20 (85.0%):  95%|█████████▌| 19/20 [00:00&lt;00:00, 251.13it/s]Average Metric: 17.00 / 20 (85.0%): 100%|██████████| 20/20 [00:00&lt;00:00, 261.44it/s]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/22 08:30:19 INFO dspy.evaluate.evaluate: Average Metric: 17.0 / 20 (85.0%)
[I 2025-07-22 08:30:19,278] Trial 5 finished with value: 85.0 and parameters: {'demo_index_for_self': 2}. Best is trial 0 with value: 85.0.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
{'prompt': 'Can you help me move this weekend?'}
{'prompt': "I'm going to the convenience store."}
{'prompt': 'We were stuck in traffic for two hours.'}
{'prompt': "She's my girlfriend."}
{'prompt': 'That car is so cool!'}{'prompt': "I'll call you tonight."}

{'prompt': "It's really cold out today."}
{'prompt': "He's always bragging."}
  0%|          | 0/20 [00:00&lt;?, ?it/s]Average Metric: 1.00 / 1 (100.0%):   0%|          | 0/20 [00:00&lt;?, ?it/s]{'prompt': "We grabbed a coffee at Tim's."}
Average Metric: 2.00 / 2 (100.0%):   5%|▌         | 1/20 [00:00&lt;00:00, 91.13it/s]{'prompt': "Close the window, it's chilly."}
Average Metric: 3.00 / 3 (100.0%):  10%|█         | 2/20 [00:00&lt;00:00, 126.72it/s]Average Metric: 3.00 / 4 (75.0%):  15%|█▌        | 3/20 [00:00&lt;00:00, 169.94it/s] Average Metric: 4.00 / 5 (80.0%):  20%|██        | 4/20 [00:00&lt;00:00, 209.21it/s]{'prompt': 'I have an appointment at 3.'}
{'prompt': 'I parked in the back.'}
{'prompt': 'The metro is packed.'}
{'prompt': 'We watched a movie last night.'}
Average Metric: 5.00 / 6 (83.3%):  25%|██▌       | 5/20 [00:00&lt;00:00, 185.25it/s]{'prompt': "They're celebrating their birthday."}
Average Metric: 6.00 / 7 (85.7%):  30%|███       | 6/20 [00:00&lt;00:00, 206.52it/s]{'prompt': 'I need to do my groceries.'}Average Metric: 7.00 / 8 (87.5%):  35%|███▌      | 7/20 [00:00&lt;00:00, 214.90it/s]
Average Metric: 8.00 / 9 (88.9%):  40%|████      | 8/20 [00:00&lt;00:00, 193.39it/s]Average Metric: 9.00 / 10 (90.0%):  45%|████▌     | 9/20 [00:00&lt;00:00, 197.53it/s]{'prompt': "It's snowing again."}
{'prompt': "Don't forget your boots."}
{'prompt': "I'll take the bus."}
Average Metric: 10.00 / 11 (90.9%):  50%|█████     | 10/20 [00:00&lt;00:00, 185.27it/s]{'prompt': "We're out of milk."}
Average Metric: 11.00 / 12 (91.7%):  55%|█████▌    | 11/20 [00:00&lt;00:00, 184.84it/s]Average Metric: 12.00 / 13 (92.3%):  60%|██████    | 12/20 [00:00&lt;00:00, 196.67it/s]Average Metric: 13.00 / 14 (92.9%):  65%|██████▌   | 13/20 [00:00&lt;00:00, 206.99it/s]Average Metric: 13.00 / 15 (86.7%):  70%|███████   | 14/20 [00:00&lt;00:00, 217.68it/s]Average Metric: 14.00 / 16 (87.5%):  75%|███████▌  | 15/20 [00:00&lt;00:00, 224.76it/s]Average Metric: 15.00 / 17 (88.2%):  80%|████████  | 16/20 [00:00&lt;00:00, 235.44it/s]Average Metric: 15.00 / 18 (83.3%):  85%|████████▌ | 17/20 [00:00&lt;00:00, 239.72it/s]Average Metric: 15.00 / 19 (78.9%):  90%|█████████ | 18/20 [00:00&lt;00:00, 245.53it/s]Average Metric: 16.00 / 20 (80.0%):  95%|█████████▌| 19/20 [00:00&lt;00:00, 255.61it/s]Average Metric: 16.00 / 20 (80.0%): 100%|██████████| 20/20 [00:00&lt;00:00, 266.15it/s]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/22 08:30:19 INFO dspy.evaluate.evaluate: Average Metric: 16.0 / 20 (80.0%)
[I 2025-07-22 08:30:19,383] Trial 6 finished with value: 80.0 and parameters: {'demo_index_for_self': 0}. Best is trial 0 with value: 85.0.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
{'prompt': "It's really cold out today."}
{'prompt': 'Can you help me move this weekend?'}
{'prompt': "I'm going to the convenience store."}
{'prompt': "I'll call you tonight."}
{'prompt': "She's my girlfriend."}
{'prompt': 'That car is so cool!'}
{'prompt': 'We were stuck in traffic for two hours.'}
  0%|          | 0/20 [00:00&lt;?, ?it/s]{'prompt': "He's always bragging."}
Average Metric: 1.00 / 1 (100.0%):   0%|          | 0/20 [00:00&lt;?, ?it/s]{'prompt': "We grabbed a coffee at Tim's."}
{'prompt': 'I have an appointment at 3.'}
{'prompt': "Close the window, it's chilly."}
{'prompt': "They're celebrating their birthday."}
Average Metric: 2.00 / 2 (100.0%):   5%|▌         | 1/20 [00:00&lt;00:00, 41.78it/s]Average Metric: 3.00 / 3 (100.0%):  10%|█         | 2/20 [00:00&lt;00:00, 75.34it/s]{'prompt': 'I parked in the back.'}
Average Metric: 4.00 / 4 (100.0%):  15%|█▌        | 3/20 [00:00&lt;00:00, 93.07it/s]{'prompt': 'I need to do my groceries.'}
Average Metric: 5.00 / 5 (100.0%):  20%|██        | 4/20 [00:00&lt;00:00, 105.57it/s]{'prompt': 'We watched a movie last night.'}
Average Metric: 6.00 / 6 (100.0%):  25%|██▌       | 5/20 [00:00&lt;00:00, 117.36it/s]{'prompt': "Don't forget your boots."}
{'prompt': 'The metro is packed.'}
Average Metric: 7.00 / 7 (100.0%):  30%|███       | 6/20 [00:00&lt;00:00, 131.44it/s]Average Metric: 7.00 / 8 (87.5%):  35%|███▌      | 7/20 [00:00&lt;00:00, 146.52it/s] Average Metric: 8.00 / 9 (88.9%):  40%|████      | 8/20 [00:00&lt;00:00, 154.85it/s]Average Metric: 8.00 / 10 (80.0%):  45%|████▌     | 9/20 [00:00&lt;00:00, 171.54it/s]{'prompt': "It's snowing again."}
Average Metric: 9.00 / 11 (81.8%):  50%|█████     | 10/20 [00:00&lt;00:00, 162.44it/s]Average Metric: 10.00 / 12 (83.3%):  55%|█████▌    | 11/20 [00:00&lt;00:00, 172.02it/s]{'prompt': "We're out of milk."}
{'prompt': "I'll take the bus."}
Average Metric: 11.00 / 13 (84.6%):  60%|██████    | 12/20 [00:00&lt;00:00, 165.22it/s]Average Metric: 12.00 / 14 (85.7%):  65%|██████▌   | 13/20 [00:00&lt;00:00, 172.92it/s]Average Metric: 13.00 / 15 (86.7%):  70%|███████   | 14/20 [00:00&lt;00:00, 182.60it/s]Average Metric: 14.00 / 16 (87.5%):  75%|███████▌  | 15/20 [00:00&lt;00:00, 188.92it/s]Average Metric: 15.00 / 17 (88.2%):  80%|████████  | 16/20 [00:00&lt;00:00, 190.95it/s]Average Metric: 16.00 / 18 (88.9%):  85%|████████▌ | 17/20 [00:00&lt;00:00, 196.73it/s]Average Metric: 17.00 / 19 (89.5%):  90%|█████████ | 18/20 [00:00&lt;00:00, 201.55it/s]Average Metric: 17.00 / 20 (85.0%):  95%|█████████▌| 19/20 [00:00&lt;00:00, 208.21it/s]Average Metric: 17.00 / 20 (85.0%): 100%|██████████| 20/20 [00:00&lt;00:00, 217.17it/s]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/22 08:30:19 INFO dspy.evaluate.evaluate: Average Metric: 17.0 / 20 (85.0%)
[I 2025-07-22 08:30:19,508] Trial 7 finished with value: 85.0 and parameters: {'demo_index_for_self': 9}. Best is trial 0 with value: 85.0.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
{'prompt': "I'm going to the convenience store."}
{'prompt': 'Can you help me move this weekend?'}
{'prompt': "She's my girlfriend."}
{'prompt': "It's really cold out today."}
{'prompt': 'That car is so cool!'}
{'prompt': "I'll call you tonight."}
{'prompt': "We grabbed a coffee at Tim's."}
{'prompt': "Close the window, it's chilly."}
{'prompt': 'I have an appointment at 3.'}
{'prompt': 'I parked in the back.'}
{'prompt': "They're celebrating their birthday."}
{'prompt': "I'll take the bus."}
{'prompt': "He's always bragging."}
{'prompt': 'I need to do my groceries.'}
{'prompt': "It's snowing again."}
{'prompt': 'The metro is packed.'}
{'prompt': "We're out of milk."}
{'prompt': 'We watched a movie last night.'}
{'prompt': 'We were stuck in traffic for two hours.'}
{'prompt': "Don't forget your boots."}
  0%|          | 0/20 [00:00&lt;?, ?it/s]Average Metric: 0.00 / 1 (0.0%):   0%|          | 0/20 [00:00&lt;?, ?it/s]Average Metric: 1.00 / 2 (50.0%):   5%|▌         | 1/20 [00:00&lt;00:00, 451.53it/s]Average Metric: 1.00 / 3 (33.3%):  10%|█         | 2/20 [00:00&lt;00:00, 640.35it/s]Average Metric: 2.00 / 4 (50.0%):  15%|█▌        | 3/20 [00:00&lt;00:00, 711.18it/s]Average Metric: 3.00 / 5 (60.0%):  20%|██        | 4/20 [00:00&lt;00:00, 764.44it/s]Average Metric: 4.00 / 6 (66.7%):  25%|██▌       | 5/20 [00:00&lt;00:00, 805.23it/s]Average Metric: 5.00 / 7 (71.4%):  30%|███       | 6/20 [00:00&lt;00:00, 831.21it/s]Average Metric: 6.00 / 8 (75.0%):  35%|███▌      | 7/20 [00:00&lt;00:00, 863.20it/s]Average Metric: 7.00 / 9 (77.8%):  40%|████      | 8/20 [00:00&lt;00:00, 889.19it/s]Average Metric: 8.00 / 10 (80.0%):  45%|████▌     | 9/20 [00:00&lt;00:00, 789.62it/s]Average Metric: 9.00 / 11 (81.8%):  50%|█████     | 10/20 [00:00&lt;00:00, 816.95it/s]Average Metric: 10.00 / 12 (83.3%):  55%|█████▌    | 11/20 [00:00&lt;00:00, 843.79it/s]Average Metric: 11.00 / 13 (84.6%):  60%|██████    | 12/20 [00:00&lt;00:00, 867.16it/s]Average Metric: 12.00 / 14 (85.7%):  65%|██████▌   | 13/20 [00:00&lt;00:00, 885.65it/s]Average Metric: 13.00 / 15 (86.7%):  70%|███████   | 14/20 [00:00&lt;00:00, 884.31it/s]Average Metric: 14.00 / 16 (87.5%):  75%|███████▌  | 15/20 [00:00&lt;00:00, 860.75it/s]Average Metric: 15.00 / 17 (88.2%):  80%|████████  | 16/20 [00:00&lt;00:00, 871.72it/s]Average Metric: 15.00 / 18 (83.3%):  85%|████████▌ | 17/20 [00:00&lt;00:00, 871.61it/s]Average Metric: 16.00 / 19 (84.2%):  90%|█████████ | 18/20 [00:00&lt;00:00, 873.75it/s]Average Metric: 16.00 / 20 (80.0%):  95%|█████████▌| 19/20 [00:00&lt;00:00, 870.71it/s]Average Metric: 16.00 / 20 (80.0%): 100%|██████████| 20/20 [00:00&lt;00:00, 875.19it/s]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/22 08:30:19 INFO dspy.evaluate.evaluate: Average Metric: 16.0 / 20 (80.0%)
[I 2025-07-22 08:30:19,584] Trial 8 finished with value: 80.0 and parameters: {'demo_index_for_self': 4}. Best is trial 0 with value: 85.0.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>{'prompt': 'Can you help me move this weekend?'}
{'prompt': 'We were stuck in traffic for two hours.'}
{'prompt': "I'm going to the convenience store."}
{'prompt': "I'll call you tonight."}
{'prompt': 'That car is so cool!'}
{'prompt': "He's always bragging."}
{'prompt': "She's my girlfriend."}
{'prompt': "It's really cold out today."}
{'prompt': "We grabbed a coffee at Tim's."}
{'prompt': "Close the window, it's chilly."}
{'prompt': 'I have an appointment at 3.'}
{'prompt': "They're celebrating their birthday."}
{'prompt': 'The metro is packed.'}
{'prompt': 'I parked in the back.'}
{'prompt': 'I need to do my groceries.'}
{'prompt': 'We watched a movie last night.'}
  0%|          | 0/20 [00:00&lt;?, ?it/s]Average Metric: 1.00 / 1 (100.0%):   0%|          | 0/20 [00:00&lt;?, ?it/s]Average Metric: 1.00 / 2 (50.0%):   5%|▌         | 1/20 [00:00&lt;00:00, 604.98it/s]Average Metric: 2.00 / 3 (66.7%):  10%|█         | 2/20 [00:00&lt;00:00, 739.67it/s]Average Metric: 3.00 / 4 (75.0%):  15%|█▌        | 3/20 [00:00&lt;00:00, 638.63it/s]Average Metric: 3.00 / 5 (60.0%):  20%|██        | 4/20 [00:00&lt;00:00, 641.55it/s]Average Metric: 4.00 / 6 (66.7%):  25%|██▌       | 5/20 [00:00&lt;00:00, 652.67it/s]Average Metric: 5.00 / 7 (71.4%):  30%|███       | 6/20 [00:00&lt;00:00, 642.82it/s]Average Metric: 6.00 / 8 (75.0%):  35%|███▌      | 7/20 [00:00&lt;00:00, 489.00it/s]Average Metric: 7.00 / 9 (77.8%):  40%|████      | 8/20 [00:00&lt;00:00, 453.94it/s]{'prompt': "Don't forget your boots."}
Average Metric: 8.00 / 10 (80.0%):  45%|████▌     | 9/20 [00:00&lt;00:00, 360.71it/s]{'prompt': "It's snowing again."}
Average Metric: 9.00 / 11 (81.8%):  50%|█████     | 10/20 [00:00&lt;00:00, 324.75it/s]Average Metric: 10.00 / 12 (83.3%):  55%|█████▌    | 11/20 [00:00&lt;00:00, 305.20it/s]Average Metric: 11.00 / 13 (84.6%):  60%|██████    | 12/20 [00:00&lt;00:00, 321.65it/s]{'prompt': "I'll take the bus."}
Average Metric: 12.00 / 14 (85.7%):  65%|██████▌   | 13/20 [00:00&lt;00:00, 317.35it/s]Average Metric: 13.00 / 15 (86.7%):  70%|███████   | 14/20 [00:00&lt;00:00, 324.65it/s]Average Metric: 14.00 / 16 (87.5%):  75%|███████▌  | 15/20 [00:00&lt;00:00, 312.11it/s]{'prompt': "We're out of milk."}
Average Metric: 14.00 / 17 (82.4%):  80%|████████  | 16/20 [00:00&lt;00:00, 304.93it/s]Average Metric: 15.00 / 18 (83.3%):  85%|████████▌ | 17/20 [00:00&lt;00:00, 308.78it/s]Average Metric: 15.00 / 19 (78.9%):  90%|█████████ | 18/20 [00:00&lt;00:00, 313.24it/s]Average Metric: 16.00 / 20 (80.0%):  95%|█████████▌| 19/20 [00:00&lt;00:00, 321.99it/s]Average Metric: 16.00 / 20 (80.0%): 100%|██████████| 20/20 [00:00&lt;00:00, 332.74it/s]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/22 08:30:19 INFO dspy.evaluate.evaluate: Average Metric: 16.0 / 20 (80.0%)
[I 2025-07-22 08:30:19,712] Trial 9 finished with value: 80.0 and parameters: {'demo_index_for_self': 5}. Best is trial 0 with value: 85.0.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
{'prompt': "It's really cold out today."}
{'prompt': "She's my girlfriend."}
{'prompt': "I'm going to the convenience store."}
{'prompt': 'Can you help me move this weekend?'}
{'prompt': 'That car is so cool!'}
{'prompt': "I'll call you tonight."}
{'prompt': "He's always bragging."}
{'prompt': 'We were stuck in traffic for two hours.'}
{'prompt': "We grabbed a coffee at Tim's."}
{'prompt': "They're celebrating their birthday."}
{'prompt': "Close the window, it's chilly."}
{'prompt': 'I have an appointment at 3.'}
{'prompt': 'The metro is packed.'}
{'prompt': "I'll take the bus."}{'prompt': "We're out of milk."}

{'prompt': 'I parked in the back.'}
{'prompt': 'I need to do my groceries.'}
{'prompt': "Don't forget your boots."}
{'prompt': 'We watched a movie last night.'}
  0%|          | 0/20 [00:00&lt;?, ?it/s]{'prompt': "It's snowing again."}
Average Metric: 0.00 / 1 (0.0%):   0%|          | 0/20 [00:00&lt;?, ?it/s]Average Metric: 1.00 / 2 (50.0%):   5%|▌         | 1/20 [00:00&lt;00:00, 1100.87it/s]Average Metric: 2.00 / 3 (66.7%):  10%|█         | 2/20 [00:00&lt;00:00, 1192.41it/s]Average Metric: 3.00 / 4 (75.0%):  15%|█▌        | 3/20 [00:00&lt;00:00, 1094.83it/s]Average Metric: 4.00 / 5 (80.0%):  20%|██        | 4/20 [00:00&lt;00:00, 992.50it/s] Average Metric: 5.00 / 6 (83.3%):  25%|██▌       | 5/20 [00:00&lt;00:00, 1067.58it/s]Average Metric: 6.00 / 7 (85.7%):  30%|███       | 6/20 [00:00&lt;00:00, 1109.12it/s]Average Metric: 7.00 / 8 (87.5%):  35%|███▌      | 7/20 [00:00&lt;00:00, 1151.74it/s]Average Metric: 7.00 / 9 (77.8%):  40%|████      | 8/20 [00:00&lt;00:00, 1098.02it/s]Average Metric: 7.00 / 10 (70.0%):  45%|████▌     | 9/20 [00:00&lt;00:00, 1044.98it/s]Average Metric: 8.00 / 11 (72.7%):  50%|█████     | 10/20 [00:00&lt;00:00, 1066.85it/s]Average Metric: 9.00 / 12 (75.0%):  55%|█████▌    | 11/20 [00:00&lt;00:00, 1048.46it/s]Average Metric: 10.00 / 13 (76.9%):  60%|██████    | 12/20 [00:00&lt;00:00, 1062.61it/s]Average Metric: 10.00 / 14 (71.4%):  65%|██████▌   | 13/20 [00:00&lt;00:00, 1015.31it/s]Average Metric: 11.00 / 15 (73.3%):  70%|███████   | 14/20 [00:00&lt;00:00, 999.43it/s] Average Metric: 12.00 / 16 (75.0%):  75%|███████▌  | 15/20 [00:00&lt;00:00, 977.10it/s]Average Metric: 13.00 / 17 (76.5%):  80%|████████  | 16/20 [00:00&lt;00:00, 970.72it/s]Average Metric: 14.00 / 18 (77.8%):  85%|████████▌ | 17/20 [00:00&lt;00:00, 973.36it/s]Average Metric: 15.00 / 19 (78.9%):  90%|█████████ | 18/20 [00:00&lt;00:00, 983.36it/s]Average Metric: 16.00 / 20 (80.0%):  95%|█████████▌| 19/20 [00:00&lt;00:00, 983.53it/s]Average Metric: 16.00 / 20 (80.0%): 100%|██████████| 20/20 [00:00&lt;00:00, 991.09it/s]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/22 08:30:19 INFO dspy.evaluate.evaluate: Average Metric: 16.0 / 20 (80.0%)
[I 2025-07-22 08:30:19,788] Trial 10 finished with value: 80.0 and parameters: {'demo_index_for_self': 0}. Best is trial 0 with value: 85.0.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
{'prompt': "I'm going to the convenience store."}
{'prompt': "It's really cold out today."}
{'prompt': 'Can you help me move this weekend?'}
{'prompt': 'We were stuck in traffic for two hours.'}
{'prompt': 'I have an appointment at 3.'}
{'prompt': 'That car is so cool!'}
{'prompt': "I'll call you tonight."}
{'prompt': "He's always bragging."}
{'prompt': 'We watched a movie last night.'}
{'prompt': 'The metro is packed.'}
{'prompt': "It's snowing again."}
{'prompt': "We grabbed a coffee at Tim's."}
{'prompt': 'I need to do my groceries.'}
{'prompt': "They're celebrating their birthday."}
{'prompt': "I'll take the bus."}
{'prompt': "She's my girlfriend."}
{'prompt': "Don't forget your boots."}
{'prompt': 'I parked in the back.'}
  0%|          | 0/20 [00:00&lt;?, ?it/s]{'prompt': "We're out of milk."}
Average Metric: 1.00 / 1 (100.0%):   0%|          | 0/20 [00:00&lt;?, ?it/s]Average Metric: 2.00 / 2 (100.0%):   5%|▌         | 1/20 [00:00&lt;00:00, 959.36it/s]Average Metric: 2.00 / 3 (66.7%):  10%|█         | 2/20 [00:00&lt;00:00, 1031.68it/s]Average Metric: 3.00 / 4 (75.0%):  15%|█▌        | 3/20 [00:00&lt;00:00, 770.96it/s] Average Metric: 4.00 / 5 (80.0%):  20%|██        | 4/20 [00:00&lt;00:00, 807.53it/s]Average Metric: 5.00 / 6 (83.3%):  25%|██▌       | 5/20 [00:00&lt;00:00, 865.13it/s]Average Metric: 6.00 / 7 (85.7%):  30%|███       | 6/20 [00:00&lt;00:00, 849.65it/s]Average Metric: 7.00 / 8 (87.5%):  35%|███▌      | 7/20 [00:00&lt;00:00, 871.25it/s]Average Metric: 8.00 / 9 (88.9%):  40%|████      | 8/20 [00:00&lt;00:00, 930.03it/s]Average Metric: 8.00 / 10 (80.0%):  45%|████▌     | 9/20 [00:00&lt;00:00, 971.43it/s]Average Metric: 9.00 / 11 (81.8%):  50%|█████     | 10/20 [00:00&lt;00:00, 874.16it/s]Average Metric: 9.00 / 12 (75.0%):  55%|█████▌    | 11/20 [00:00&lt;00:00, 893.84it/s]Average Metric: 10.00 / 13 (76.9%):  60%|██████    | 12/20 [00:00&lt;00:00, 923.48it/s]Average Metric: 11.00 / 14 (78.6%):  65%|██████▌   | 13/20 [00:00&lt;00:00, 958.23it/s]Average Metric: 12.00 / 15 (80.0%):  70%|███████   | 14/20 [00:00&lt;00:00, 984.35it/s]Average Metric: 13.00 / 16 (81.2%):  75%|███████▌  | 15/20 [00:00&lt;00:00, 1009.02it/s]Average Metric: 14.00 / 17 (82.4%):  80%|████████  | 16/20 [00:00&lt;00:00, 1023.23it/s]Average Metric: 15.00 / 18 (83.3%):  85%|████████▌ | 17/20 [00:00&lt;00:00, 1042.63it/s]Average Metric: 16.00 / 19 (84.2%):  90%|█████████ | 18/20 [00:00&lt;00:00, 1051.76it/s]{'prompt': "Close the window, it's chilly."}
Average Metric: 17.00 / 20 (85.0%):  95%|█████████▌| 19/20 [00:00&lt;00:00, 944.28it/s] Average Metric: 17.00 / 20 (85.0%): 100%|██████████| 20/20 [00:00&lt;00:00, 967.56it/s]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/22 08:30:19 INFO dspy.evaluate.evaluate: Average Metric: 17.0 / 20 (85.0%)
[I 2025-07-22 08:30:19,863] Trial 11 finished with value: 85.0 and parameters: {'demo_index_for_self': 7}. Best is trial 0 with value: 85.0.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
{'prompt': "I'm going to the convenience store."}
{'prompt': "It's really cold out today."}
{'prompt': 'We were stuck in traffic for two hours.'}
{'prompt': 'That car is so cool!'}
{'prompt': 'Can you help me move this weekend?'}
{'prompt': "He's always bragging."}
{'prompt': "We grabbed a coffee at Tim's."}
{'prompt': "Close the window, it's chilly."}
{'prompt': 'I have an appointment at 3.'}
{'prompt': "They're celebrating their birthday."}
{'prompt': "I'll call you tonight."}
{'prompt': 'I parked in the back.'}
{'prompt': "She's my girlfriend."}
{'prompt': 'I need to do my groceries.'}
{'prompt': "Don't forget your boots."}
  0%|          | 0/20 [00:00&lt;?, ?it/s]{'prompt': 'We watched a movie last night.'}
{'prompt': 'The metro is packed.'}
{'prompt': "It's snowing again."}
{'prompt': "We're out of milk."}
Average Metric: 1.00 / 1 (100.0%):   0%|          | 0/20 [00:00&lt;?, ?it/s]Average Metric: 2.00 / 2 (100.0%):   5%|▌         | 1/20 [00:00&lt;00:00, 629.68it/s]{'prompt': "I'll take the bus."}
Average Metric: 3.00 / 3 (100.0%):  10%|█         | 2/20 [00:00&lt;00:00, 595.06it/s]Average Metric: 3.00 / 4 (75.0%):  15%|█▌        | 3/20 [00:00&lt;00:00, 719.48it/s] Average Metric: 4.00 / 5 (80.0%):  20%|██        | 4/20 [00:00&lt;00:00, 776.94it/s]Average Metric: 5.00 / 6 (83.3%):  25%|██▌       | 5/20 [00:00&lt;00:00, 800.07it/s]Average Metric: 6.00 / 7 (85.7%):  30%|███       | 6/20 [00:00&lt;00:00, 819.39it/s]Average Metric: 7.00 / 8 (87.5%):  35%|███▌      | 7/20 [00:00&lt;00:00, 852.25it/s]Average Metric: 8.00 / 9 (88.9%):  40%|████      | 8/20 [00:00&lt;00:00, 878.76it/s]Average Metric: 9.00 / 10 (90.0%):  45%|████▌     | 9/20 [00:00&lt;00:00, 914.48it/s]Average Metric: 10.00 / 11 (90.9%):  50%|█████     | 10/20 [00:00&lt;00:00, 939.84it/s]Average Metric: 11.00 / 12 (91.7%):  55%|█████▌    | 11/20 [00:00&lt;00:00, 963.62it/s]Average Metric: 11.00 / 13 (84.6%):  60%|██████    | 12/20 [00:00&lt;00:00, 855.69it/s]Average Metric: 12.00 / 14 (85.7%):  65%|██████▌   | 13/20 [00:00&lt;00:00, 894.07it/s]Average Metric: 13.00 / 15 (86.7%):  70%|███████   | 14/20 [00:00&lt;00:00, 913.71it/s]Average Metric: 14.00 / 16 (87.5%):  75%|███████▌  | 15/20 [00:00&lt;00:00, 932.55it/s]Average Metric: 14.00 / 17 (82.4%):  80%|████████  | 16/20 [00:00&lt;00:00, 949.92it/s]Average Metric: 15.00 / 18 (83.3%):  85%|████████▌ | 17/20 [00:00&lt;00:00, 967.95it/s]Average Metric: 16.00 / 19 (84.2%):  90%|█████████ | 18/20 [00:00&lt;00:00, 985.14it/s]Average Metric: 17.00 / 20 (85.0%):  95%|█████████▌| 19/20 [00:00&lt;00:00, 997.19it/s]Average Metric: 17.00 / 20 (85.0%): 100%|██████████| 20/20 [00:00&lt;00:00, 1005.00it/s]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/22 08:30:19 INFO dspy.evaluate.evaluate: Average Metric: 17.0 / 20 (85.0%)
[I 2025-07-22 08:30:19,928] Trial 12 finished with value: 85.0 and parameters: {'demo_index_for_self': 7}. Best is trial 0 with value: 85.0.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
{'prompt': 'We were stuck in traffic for two hours.'}
{'prompt': 'Can you help me move this weekend?'}
{'prompt': "I'm going to the convenience store."}
{'prompt': "She's my girlfriend."}
{'prompt': 'That car is so cool!'}
{'prompt': "I'll call you tonight."}
{'prompt': "It's really cold out today."}
{'prompt': "He's always bragging."}
  0%|          | 0/20 [00:00&lt;?, ?it/s]Average Metric: 1.00 / 1 (100.0%):   0%|          | 0/20 [00:00&lt;?, ?it/s]{'prompt': "We grabbed a coffee at Tim's."}
Average Metric: 2.00 / 2 (100.0%):   5%|▌         | 1/20 [00:00&lt;00:00, 86.27it/s]{'prompt': "Close the window, it's chilly."}
Average Metric: 3.00 / 3 (100.0%):  10%|█         | 2/20 [00:00&lt;00:00, 145.31it/s]{'prompt': "They're celebrating their birthday."}
{'prompt': 'I have an appointment at 3.'}
Average Metric: 4.00 / 4 (100.0%):  15%|█▌        | 3/20 [00:00&lt;00:00, 163.85it/s]Average Metric: 5.00 / 5 (100.0%):  20%|██        | 4/20 [00:00&lt;00:00, 200.64it/s]Average Metric: 5.00 / 6 (83.3%):  25%|██▌       | 5/20 [00:00&lt;00:00, 203.31it/s] {'prompt': 'We watched a movie last night.'}
Average Metric: 6.00 / 7 (85.7%):  30%|███       | 6/20 [00:00&lt;00:00, 212.57it/s]{'prompt': 'I parked in the back.'}
{'prompt': 'The metro is packed.'}
Average Metric: 7.00 / 8 (87.5%):  35%|███▌      | 7/20 [00:00&lt;00:00, 201.17it/s]{'prompt': 'I need to do my groceries.'}
{'prompt': "Don't forget your boots."}
Average Metric: 8.00 / 9 (88.9%):  40%|████      | 8/20 [00:00&lt;00:00, 197.38it/s]Average Metric: 9.00 / 10 (90.0%):  45%|████▌     | 9/20 [00:00&lt;00:00, 196.42it/s]{'prompt': "It's snowing again."}
Average Metric: 10.00 / 11 (90.9%):  50%|█████     | 10/20 [00:00&lt;00:00, 195.91it/s]{'prompt': "I'll take the bus."}
Average Metric: 11.00 / 12 (91.7%):  55%|█████▌    | 11/20 [00:00&lt;00:00, 205.83it/s]Average Metric: 12.00 / 13 (92.3%):  60%|██████    | 12/20 [00:00&lt;00:00, 212.04it/s]{'prompt': "We're out of milk."}
Average Metric: 13.00 / 14 (92.9%):  65%|██████▌   | 13/20 [00:00&lt;00:00, 212.72it/s]Average Metric: 14.00 / 15 (93.3%):  70%|███████   | 14/20 [00:00&lt;00:00, 222.44it/s]Average Metric: 15.00 / 16 (93.8%):  75%|███████▌  | 15/20 [00:00&lt;00:00, 233.63it/s]Average Metric: 15.00 / 17 (88.2%):  80%|████████  | 16/20 [00:00&lt;00:00, 241.94it/s]Average Metric: 15.00 / 18 (83.3%):  85%|████████▌ | 17/20 [00:00&lt;00:00, 247.69it/s]Average Metric: 16.00 / 19 (84.2%):  90%|█████████ | 18/20 [00:00&lt;00:00, 256.24it/s]Average Metric: 17.00 / 20 (85.0%):  95%|█████████▌| 19/20 [00:00&lt;00:00, 265.67it/s]Average Metric: 17.00 / 20 (85.0%): 100%|██████████| 20/20 [00:00&lt;00:00, 276.33it/s]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/22 08:30:20 INFO dspy.evaluate.evaluate: Average Metric: 17.0 / 20 (85.0%)
[I 2025-07-22 08:30:20,031] Trial 13 finished with value: 85.0 and parameters: {'demo_index_for_self': 6}. Best is trial 0 with value: 85.0.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
{'prompt': "I'm going to the convenience store."}
{'prompt': "It's really cold out today."}
{'prompt': 'We were stuck in traffic for two hours.'}
{'prompt': 'That car is so cool!'}
{'prompt': 'Can you help me move this weekend?'}
{'prompt': "I'll call you tonight."}
{'prompt': "He's always bragging."}
  0%|          | 0/20 [00:00&lt;?, ?it/s]Average Metric: 1.00 / 1 (100.0%):   0%|          | 0/20 [00:00&lt;?, ?it/s]{'prompt': "We grabbed a coffee at Tim's."}
Average Metric: 1.00 / 2 (50.0%):   5%|▌         | 1/20 [00:00&lt;00:00, 91.53it/s]{'prompt': "Close the window, it's chilly."}Average Metric: 2.00 / 3 (66.7%):  10%|█         | 2/20 [00:00&lt;00:00, 138.34it/s]
{'prompt': 'I have an appointment at 3.'}
{'prompt': 'I parked in the back.'}
Average Metric: 3.00 / 4 (75.0%):  15%|█▌        | 3/20 [00:00&lt;00:00, 148.85it/s]Average Metric: 4.00 / 5 (80.0%):  20%|██        | 4/20 [00:00&lt;00:00, 186.12it/s]{'prompt': "They're celebrating their birthday."}
Average Metric: 5.00 / 6 (83.3%):  25%|██▌       | 5/20 [00:00&lt;00:00, 195.23it/s]{'prompt': 'We watched a movie last night.'}
Average Metric: 6.00 / 7 (85.7%):  30%|███       | 6/20 [00:00&lt;00:00, 205.31it/s]{'prompt': "She's my girlfriend."}
{'prompt': 'The metro is packed.'}
Average Metric: 7.00 / 8 (87.5%):  35%|███▌      | 7/20 [00:00&lt;00:00, 178.44it/s]{'prompt': 'I need to do my groceries.'}
Average Metric: 8.00 / 9 (88.9%):  40%|████      | 8/20 [00:00&lt;00:00, 188.99it/s]{'prompt': "I'll take the bus."}
{'prompt': "Don't forget your boots."}Average Metric: 9.00 / 10 (90.0%):  45%|████▌     | 9/20 [00:00&lt;00:00, 187.09it/s]{'prompt': "We're out of milk."}

Average Metric: 10.00 / 11 (90.9%):  50%|█████     | 10/20 [00:00&lt;00:00, 194.42it/s]{'prompt': "It's snowing again."}
Average Metric: 11.00 / 12 (91.7%):  55%|█████▌    | 11/20 [00:00&lt;00:00, 202.81it/s]Average Metric: 12.00 / 13 (92.3%):  60%|██████    | 12/20 [00:00&lt;00:00, 212.66it/s]Average Metric: 13.00 / 14 (92.9%):  65%|██████▌   | 13/20 [00:00&lt;00:00, 223.32it/s]Average Metric: 14.00 / 15 (93.3%):  70%|███████   | 14/20 [00:00&lt;00:00, 229.91it/s]Average Metric: 15.00 / 16 (93.8%):  75%|███████▌  | 15/20 [00:00&lt;00:00, 237.28it/s]Average Metric: 16.00 / 17 (94.1%):  80%|████████  | 16/20 [00:00&lt;00:00, 242.97it/s]Average Metric: 16.00 / 18 (88.9%):  85%|████████▌ | 17/20 [00:00&lt;00:00, 248.65it/s]Average Metric: 16.00 / 19 (84.2%):  90%|█████████ | 18/20 [00:00&lt;00:00, 257.25it/s]Average Metric: 16.00 / 20 (80.0%):  95%|█████████▌| 19/20 [00:00&lt;00:00, 269.29it/s]Average Metric: 16.00 / 20 (80.0%): 100%|██████████| 20/20 [00:00&lt;00:00, 280.56it/s]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/22 08:30:20 INFO dspy.evaluate.evaluate: Average Metric: 16.0 / 20 (80.0%)
[I 2025-07-22 08:30:20,136] Trial 14 finished with value: 80.0 and parameters: {'demo_index_for_self': 8}. Best is trial 0 with value: 85.0.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
{'prompt': "I'm going to the convenience store."}
{'prompt': 'Can you help me move this weekend?'}
{'prompt': "It's really cold out today."}
{'prompt': "She's my girlfriend."}
{'prompt': 'We were stuck in traffic for two hours.'}
{'prompt': "We grabbed a coffee at Tim's."}
{'prompt': "He's always bragging."}
{'prompt': "I'll call you tonight."}
{'prompt': "Close the window, it's chilly."}
{'prompt': 'I parked in the back.'}
{'prompt': "They're celebrating their birthday."}
{'prompt': 'We watched a movie last night.'}
{'prompt': 'The metro is packed.'}
{'prompt': 'I have an appointment at 3.'}
{'prompt': "I'll take the bus."}
{'prompt': 'I need to do my groceries.'}
{'prompt': 'That car is so cool!'}
{'prompt': "We're out of milk."}
{'prompt': "It's snowing again."}
{'prompt': "Don't forget your boots."}
  0%|          | 0/20 [00:00&lt;?, ?it/s]Average Metric: 1.00 / 1 (100.0%):   0%|          | 0/20 [00:00&lt;?, ?it/s]Average Metric: 2.00 / 2 (100.0%):   5%|▌         | 1/20 [00:00&lt;00:00, 1090.00it/s]Average Metric: 3.00 / 3 (100.0%):  10%|█         | 2/20 [00:00&lt;00:00, 1236.16it/s]Average Metric: 4.00 / 4 (100.0%):  15%|█▌        | 3/20 [00:00&lt;00:00, 1350.24it/s]Average Metric: 5.00 / 5 (100.0%):  20%|██        | 4/20 [00:00&lt;00:00, 1412.58it/s]Average Metric: 5.00 / 6 (83.3%):  25%|██▌       | 5/20 [00:00&lt;00:00, 1463.57it/s] Average Metric: 6.00 / 7 (85.7%):  30%|███       | 6/20 [00:00&lt;00:00, 1497.07it/s]Average Metric: 7.00 / 8 (87.5%):  35%|███▌      | 7/20 [00:00&lt;00:00, 1489.76it/s]Average Metric: 8.00 / 9 (88.9%):  40%|████      | 8/20 [00:00&lt;00:00, 1490.78it/s]Average Metric: 9.00 / 10 (90.0%):  45%|████▌     | 9/20 [00:00&lt;00:00, 1502.98it/s]Average Metric: 9.00 / 11 (81.8%):  50%|█████     | 10/20 [00:00&lt;00:00, 1523.54it/s]Average Metric: 10.00 / 12 (83.3%):  55%|█████▌    | 11/20 [00:00&lt;00:00, 1562.87it/s]Average Metric: 11.00 / 13 (84.6%):  60%|██████    | 12/20 [00:00&lt;00:00, 1595.85it/s]Average Metric: 12.00 / 14 (85.7%):  65%|██████▌   | 13/20 [00:00&lt;00:00, 1630.27it/s]Average Metric: 13.00 / 15 (86.7%):  70%|███████   | 14/20 [00:00&lt;00:00, 1641.10it/s]Average Metric: 14.00 / 16 (87.5%):  75%|███████▌  | 15/20 [00:00&lt;00:00, 1634.31it/s]Average Metric: 14.00 / 17 (82.4%):  80%|████████  | 16/20 [00:00&lt;00:00, 1643.50it/s]Average Metric: 15.00 / 18 (83.3%):  85%|████████▌ | 17/20 [00:00&lt;00:00, 1667.29it/s]Average Metric: 16.00 / 19 (84.2%):  90%|█████████ | 18/20 [00:00&lt;00:00, 1690.65it/s]Average Metric: 17.00 / 20 (85.0%):  95%|█████████▌| 19/20 [00:00&lt;00:00, 1717.31it/s]Average Metric: 17.00 / 20 (85.0%): 100%|██████████| 20/20 [00:00&lt;00:00, 1691.22it/s]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/07/22 08:30:20 INFO dspy.evaluate.evaluate: Average Metric: 17.0 / 20 (85.0%)
[I 2025-07-22 08:30:20,193] Trial 15 finished with value: 85.0 and parameters: {'demo_index_for_self': 2}. Best is trial 0 with value: 85.0.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Best score: 85.0
Best program: MyPredict(StringSignature(prompt -&gt; generation
    instructions=''
    prompt = Field(annotation=str required=True json_schema_extra={'__dspy_field_type': 'input', 'prefix': 'Prompt:', 'desc': '${prompt}'})
    generation = Field(annotation=str required=True json_schema_extra={'__dspy_field_type': 'output', 'prefix': 'Generation:', 'desc': '${generation}'})
))</code></pre>
</div>
</div>
<div id="a672ece7" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>my_program_optimized_with_demo(prompt <span class="op">=</span> <span class="st">"Hi how are you?"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'prompt': 'Hi how are you?'}</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>Prediction(
    generation='Salut, comment ça va ?'
)</code></pre>
</div>
</div>
<div id="276e0c9c" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>my_program_optimized_with_demo.inspect_history()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>



[2025-07-22T08:30:20.868581]

System message:

Here are examples of your expected behavior.
&lt;examples&gt;
&lt;example_1&gt;
User:
They're celebrating their birthday.
Assistant:
Ils fêtent leur fête.
&lt;/example_1&gt;
&lt;/examples&gt;


User message:

Hi how are you?


Response:

Salut, comment ça va ?




</code></pre>
</div>
</div>
<div id="8c6d172c" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dspy</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> QuebecTranslationJudge(dspy.Signature):</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""You are an expert Quebec French linguist. For each English sentence and its proposed French translation, evaluate the translation on a scale of 1 to 5 based on the following criteria, with 5 being a perfect, natural-sounding translation.</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a><span class="co">1.  **Accuracy**: Does the French convey the same meaning as the English?</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a><span class="co">2.  **Register**: Is the tone appropriately informal/colloquial (not formal textbook French)?</span></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a><span class="co">3.  **Regional Vocabulary**: Does it use authentic Quebec French terms (e.g., "dépanneur", "frette", "char")?</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a><span class="co">4.  **Contractions**: Are natural Quebec French contractions used (e.g., "j'va", "t'sais", "y fait")?</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a><span class="co">5.  **Proper Nouns &amp; Anglicisms**: Are names (e.g., "Tim's") and common anglicisms (e.g., "weekend") handled appropriately for Quebec French?</span></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a><span class="co">Provide brief feedback on any issues and output only the final numerical score."""</span></span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>    english_sentence <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">"The original sentence in English."</span>)</span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>    french_translation <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">"The proposed translation in Quebec French."</span>)</span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>    feedback <span class="op">=</span> dspy.OutputField(desc<span class="op">=</span><span class="st">"Brief feedback on the translation's quality."</span>)</span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>    score <span class="op">=</span> dspy.OutputField(desc<span class="op">=</span><span class="st">"A single integer from 1 to 5."</span>)</span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a><span class="co"># If you have a capable model configured globally, just do this:</span></span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a>llm_judge <span class="op">=</span> dspy.Predict(QuebecTranslationJudge)</span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> translation_judge(example, prediction, trace<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a><span class="co">    An LLM-based metric that judges translation quality.</span></span>
<span id="cb88-25"><a href="#cb88-25" aria-hidden="true" tabindex="-1"></a><span class="co">    It robustly parses the score and normalizes it to a 0.0-1.0 scale.</span></span>
<span id="cb88-26"><a href="#cb88-26" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb88-27"><a href="#cb88-27" aria-hidden="true" tabindex="-1"></a>    english_sentence <span class="op">=</span> example.prompt</span>
<span id="cb88-28"><a href="#cb88-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure the prediction's output is not empty</span></span>
<span id="cb88-29"><a href="#cb88-29" aria-hidden="true" tabindex="-1"></a>    french_translation <span class="op">=</span> prediction.get(<span class="st">"generation"</span>, <span class="st">""</span>)</span>
<span id="cb88-30"><a href="#cb88-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> french_translation:</span>
<span id="cb88-31"><a href="#cb88-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.0</span></span>
<span id="cb88-32"><a href="#cb88-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-33"><a href="#cb88-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb88-34"><a href="#cb88-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Call the LLM judge to get a score</span></span>
<span id="cb88-35"><a href="#cb88-35" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> llm_judge(</span>
<span id="cb88-36"><a href="#cb88-36" aria-hidden="true" tabindex="-1"></a>            english_sentence<span class="op">=</span>english_sentence,</span>
<span id="cb88-37"><a href="#cb88-37" aria-hidden="true" tabindex="-1"></a>            french_translation<span class="op">=</span>french_translation</span>
<span id="cb88-38"><a href="#cb88-38" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb88-39"><a href="#cb88-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parse the score and normalize it to a 0.0-1.0 range</span></span>
<span id="cb88-40"><a href="#cb88-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (e.g., a score of 5 becomes 1.0, 1 becomes 0.2)</span></span>
<span id="cb88-41"><a href="#cb88-41" aria-hidden="true" tabindex="-1"></a>        score <span class="op">=</span> <span class="bu">float</span>(result.score)</span>
<span id="cb88-42"><a href="#cb88-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> score <span class="op">/</span> <span class="fl">5.0</span></span>
<span id="cb88-43"><a href="#cb88-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> (<span class="pp">ValueError</span>, <span class="pp">AttributeError</span>, <span class="pp">TypeError</span>):</span>
<span id="cb88-44"><a href="#cb88-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If the LLM fails to output a valid score, return 0.0</span></span>
<span id="cb88-45"><a href="#cb88-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/maximerivest\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb89" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Automatic System Prompt Optimization"</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2025-07-21</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> Maxime Rivest</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> "In this tutorial, I will teach you how to automatically optimize your System Prompt."</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a><span class="an">draft:</span><span class="co"> false</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-location: right</span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a><span class="co">    reference-location: margin</span></span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a><span class="an">include-in-header:</span></span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a><span class="co">  text: |</span></span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;style&gt;</span></span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a><span class="co">    .cell-output-stdout {</span></span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a><span class="co">      overflow-y: scroll;</span></span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a><span class="co">      max-height: 300px;</span></span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a><span class="co">    }</span></span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a><span class="co">    &lt;/style&gt;</span></span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a><span class="an">title-block-banner:</span><span class="co"> false</span></span>
<span id="cb89-22"><a href="#cb89-22" aria-hidden="true" tabindex="-1"></a><span class="an">title-block-style:</span><span class="co"> none</span></span>
<span id="cb89-23"><a href="#cb89-23" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb89-24"><a href="#cb89-24" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true  </span></span>
<span id="cb89-25"><a href="#cb89-25" aria-hidden="true" tabindex="-1"></a><span class="co">  #cache: true</span></span>
<span id="cb89-26"><a href="#cb89-26" aria-hidden="true" tabindex="-1"></a><span class="co">  #freeze: true</span></span>
<span id="cb89-27"><a href="#cb89-27" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb89-28"><a href="#cb89-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-29"><a href="#cb89-29" aria-hidden="true" tabindex="-1"></a>DSPy has quite a reputation for its automatic prompt optimization capability. Despite that, DSPy is relatively hard to use to optimize a system prompt. DSPy is the implementation of a new Paradigm (one where you do not write prompt you rather focus on your program ), so it does not focus on optimizing a prompt but it rather focus on optimizing a program. Although, I very strongly recommend that you learn DSPy's signature, AI programming and the Intent-Oriented Pragramming paradigm DSPy, sometimes you just want a better system prompt. </span>
<span id="cb89-30"><a href="#cb89-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-31"><a href="#cb89-31" aria-hidden="true" tabindex="-1"></a>In this tutorial, I will show you how to optimize as system prompt given a trainset set. The system prompt will be rewritten automatically by an LLM in a loop for several steps.</span>
<span id="cb89-32"><a href="#cb89-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-33"><a href="#cb89-33" aria-hidden="true" tabindex="-1"></a><span class="fu">## The task</span></span>
<span id="cb89-34"><a href="#cb89-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-35"><a href="#cb89-35" aria-hidden="true" tabindex="-1"></a>All throughout this tutorial our task will be to make an english to french translator. We will do several optimization and will evolve that task as we progress through that tutorial, but it will always be variants of that.</span>
<span id="cb89-36"><a href="#cb89-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-37"><a href="#cb89-37" aria-hidden="true" tabindex="-1"></a><span class="fu">## Optimizing a non existent system prompt</span></span>
<span id="cb89-38"><a href="#cb89-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-39"><a href="#cb89-39" aria-hidden="true" tabindex="-1"></a>As a first task, we will start with an empty system prompt and we will have dspy's optimizer deduce the system prompt based on the training set</span>
<span id="cb89-40"><a href="#cb89-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-41"><a href="#cb89-41" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip collapse="true"}</span>
<span id="cb89-42"><a href="#cb89-42" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setting up</span></span>
<span id="cb89-43"><a href="#cb89-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-44"><a href="#cb89-44" aria-hidden="true" tabindex="-1"></a>For this tutorial, you will only need to install dspy and setup a LLM connections. I will be using several LLMs to demonstrate how easy it is to switch between them and show the student/teacher concept. You can however set only one up if you want. If you use a locally hosted model, (you can!) simply skip the setting up of the API key. .</span>
<span id="cb89-45"><a href="#cb89-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-46"><a href="#cb89-46" aria-hidden="true" tabindex="-1"></a>For this tutorial, I have will use Kimi-K2 hosted by Groq <span class="co">[</span><span class="ot">Click here to get a groq api key</span><span class="co">](https://console.groq.com/keys)</span> and Llama models from OpenRouter <span class="co">[</span><span class="ot">Click here to get a OpenRouter key</span><span class="co">](https://openrouter.ai/settings/keys)</span>.</span>
<span id="cb89-47"><a href="#cb89-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-48"><a href="#cb89-48" aria-hidden="true" tabindex="-1"></a>::: {.callout-note icon=false appearance="simple" collapse="true"}</span>
<span id="cb89-49"><a href="#cb89-49" aria-hidden="true" tabindex="-1"></a><span class="fu">## python library requirements</span></span>
<span id="cb89-50"><a href="#cb89-50" aria-hidden="true" tabindex="-1"></a>I like to use uv to install my libraries.</span>
<span id="cb89-51"><a href="#cb89-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-54"><a href="#cb89-54" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb89-55"><a href="#cb89-55" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb89-56"><a href="#cb89-56" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb89-57"><a href="#cb89-57" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: ""</span></span>
<span id="cb89-58"><a href="#cb89-58" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>uv pip install dspy</span>
<span id="cb89-59"><a href="#cb89-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-60"><a href="#cb89-60" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-61"><a href="#cb89-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-62"><a href="#cb89-62" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb89-63"><a href="#cb89-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-64"><a href="#cb89-64" aria-hidden="true" tabindex="-1"></a>::: {.callout-note icon=false appearance="simple" collapse="true"}</span>
<span id="cb89-65"><a href="#cb89-65" aria-hidden="true" tabindex="-1"></a><span class="fu">## api key setup</span></span>
<span id="cb89-66"><a href="#cb89-66" aria-hidden="true" tabindex="-1"></a>I generally setup my key permanently but you can also do this to set it up just for here and now.</span>
<span id="cb89-67"><a href="#cb89-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-68"><a href="#cb89-68" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb89-69"><a href="#cb89-69" aria-hidden="true" tabindex="-1"></a><span class="in">import os</span></span>
<span id="cb89-70"><a href="#cb89-70" aria-hidden="true" tabindex="-1"></a><span class="in">os.environ["GROQ_API_KEY"] = "[REDACTED]"</span></span>
<span id="cb89-71"><a href="#cb89-71" aria-hidden="true" tabindex="-1"></a><span class="in">os.environ["OPENROUTER_API_KEY"] = "[REDACTED]"</span></span>
<span id="cb89-72"><a href="#cb89-72" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-73"><a href="#cb89-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-74"><a href="#cb89-74" aria-hidden="true" tabindex="-1"></a>::: {.callout-note icon=false appearance="simple" collapse="true"}</span>
<span id="cb89-75"><a href="#cb89-75" aria-hidden="true" tabindex="-1"></a><span class="fu">## Make GROQ_API_KEY permanent</span></span>
<span id="cb89-76"><a href="#cb89-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-77"><a href="#cb89-77" aria-hidden="true" tabindex="-1"></a>Replace GROQ_API_KEY with OPENROUTER_API_KEY to set openrouter key permanently on your system.</span>
<span id="cb89-78"><a href="#cb89-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-79"><a href="#cb89-79" aria-hidden="true" tabindex="-1"></a><span class="fu">###### Linux / macOS</span></span>
<span id="cb89-80"><a href="#cb89-80" aria-hidden="true" tabindex="-1"></a>Append to your shell start-up file (pick the one you actually use):</span>
<span id="cb89-81"><a href="#cb89-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-82"><a href="#cb89-82" aria-hidden="true" tabindex="-1"></a><span class="in">```bash</span></span>
<span id="cb89-83"><a href="#cb89-83" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"export GROQ_API_KEY='gsk_[REDACTED]'"</span> <span class="op">&gt;&gt;</span> ~/.bashrc</span>
<span id="cb89-84"><a href="#cb89-84" aria-hidden="true" tabindex="-1"></a><span class="co"># or ~/.zshrc, ~/.profile, etc.</span></span>
<span id="cb89-85"><a href="#cb89-85" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> ~/.bashrc   <span class="co"># reload once</span></span>
<span id="cb89-86"><a href="#cb89-86" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-87"><a href="#cb89-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-88"><a href="#cb89-88" aria-hidden="true" tabindex="-1"></a><span class="fu">###### Windows – CMD</span></span>
<span id="cb89-89"><a href="#cb89-89" aria-hidden="true" tabindex="-1"></a><span class="in">```cmd</span></span>
<span id="cb89-90"><a href="#cb89-90" aria-hidden="true" tabindex="-1"></a><span class="in">setx GROQ_API_KEY "gsk_[REDACTED]"</span></span>
<span id="cb89-91"><a href="#cb89-91" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-92"><a href="#cb89-92" aria-hidden="true" tabindex="-1"></a>Close and reopen the terminal.</span>
<span id="cb89-93"><a href="#cb89-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-94"><a href="#cb89-94" aria-hidden="true" tabindex="-1"></a><span class="fu">###### Windows – PowerShell</span></span>
<span id="cb89-95"><a href="#cb89-95" aria-hidden="true" tabindex="-1"></a><span class="in">```powershell</span></span>
<span id="cb89-96"><a href="#cb89-96" aria-hidden="true" tabindex="-1"></a><span class="in">[Environment]::SetEnvironmentVariable("GROQ_API_KEY", "gsk_[REDACTED]", "User")</span></span>
<span id="cb89-97"><a href="#cb89-97" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-98"><a href="#cb89-98" aria-hidden="true" tabindex="-1"></a>Refresh with <span class="in">`refreshenv`</span> or open a new window.</span>
<span id="cb89-99"><a href="#cb89-99" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb89-100"><a href="#cb89-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-101"><a href="#cb89-101" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb89-102"><a href="#cb89-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-103"><a href="#cb89-103" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb89-104"><a href="#cb89-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-105"><a href="#cb89-105" aria-hidden="true" tabindex="-1"></a>Usually the first thing to do whenever you work with dspy is to first configure you llm connection.</span>
<span id="cb89-106"><a href="#cb89-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-109"><a href="#cb89-109" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb89-110"><a href="#cb89-110" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dspy</span>
<span id="cb89-111"><a href="#cb89-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-112"><a href="#cb89-112" aria-hidden="true" tabindex="-1"></a>kimi <span class="op">=</span> dspy.LM(<span class="st">"groq/moonshotai/kimi-k2-instruct"</span>)</span>
<span id="cb89-113"><a href="#cb89-113" aria-hidden="true" tabindex="-1"></a>dspy.configure(lm <span class="op">=</span> kimi)</span>
<span id="cb89-114"><a href="#cb89-114" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-115"><a href="#cb89-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-116"><a href="#cb89-116" aria-hidden="true" tabindex="-1"></a>If you are new, to dspy. Kimi can now be call just like that:</span>
<span id="cb89-117"><a href="#cb89-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-120"><a href="#cb89-120" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb89-121"><a href="#cb89-121" aria-hidden="true" tabindex="-1"></a>kimi(<span class="st">"Hello"</span>)</span>
<span id="cb89-122"><a href="#cb89-122" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-123"><a href="#cb89-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-124"><a href="#cb89-124" aria-hidden="true" tabindex="-1"></a>Although, convenient. This is never really used, when you are using DSPy according to it's paradigm, in DSPy you would be using and calling a program instead. More like that:</span>
<span id="cb89-125"><a href="#cb89-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-128"><a href="#cb89-128" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb89-129"><a href="#cb89-129" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> signature(dspy.Signature):</span>
<span id="cb89-130"><a href="#cb89-130" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb89-131"><a href="#cb89-131" aria-hidden="true" tabindex="-1"></a><span class="co">    You are a Pirate</span></span>
<span id="cb89-132"><a href="#cb89-132" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb89-133"><a href="#cb89-133" aria-hidden="true" tabindex="-1"></a>    prompt <span class="op">=</span> dspy.InputField()</span>
<span id="cb89-134"><a href="#cb89-134" aria-hidden="true" tabindex="-1"></a>    generation <span class="op">=</span> dspy.OutputField()</span>
<span id="cb89-135"><a href="#cb89-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-136"><a href="#cb89-136" aria-hidden="true" tabindex="-1"></a>my_program <span class="op">=</span> dspy.Predict(signature) </span>
<span id="cb89-137"><a href="#cb89-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-138"><a href="#cb89-138" aria-hidden="true" tabindex="-1"></a>my_program(prompt <span class="op">=</span> <span class="st">"Hello :)"</span>)</span>
<span id="cb89-139"><a href="#cb89-139" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-140"><a href="#cb89-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-141"><a href="#cb89-141" aria-hidden="true" tabindex="-1"></a>It is out of scope to explain all about predict and signatures here as my goal is to simply get you to do automatic system prompt optimization. So let's now focus on that. For optimization we need a training set. DSPy expects the training set to be a list of Example dspy object so we will create our training set like that:</span>
<span id="cb89-142"><a href="#cb89-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-145"><a href="#cb89-145" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb89-146"><a href="#cb89-146" aria-hidden="true" tabindex="-1"></a>examples <span class="op">=</span> [</span>
<span id="cb89-147"><a href="#cb89-147" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"I'm going to the convenience store."</span>, generation<span class="op">=</span><span class="st">"Je m'en vais au dépanneur."</span>),</span>
<span id="cb89-148"><a href="#cb89-148" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"It's really cold out today."</span>, generation<span class="op">=</span><span class="st">"Il fait frette en maudit aujourd'hui."</span>),</span>
<span id="cb89-149"><a href="#cb89-149" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"Can you help me move this weekend?"</span>, generation<span class="op">=</span><span class="st">"Tu peux m'aider à déménager ce weekend?"</span>),</span>
<span id="cb89-150"><a href="#cb89-150" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"We were stuck in traffic for two hours."</span>, generation<span class="op">=</span><span class="st">"On était pognés dans le trafic pendant deux heures."</span>),</span>
<span id="cb89-151"><a href="#cb89-151" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"She's my girlfriend."</span>, generation<span class="op">=</span><span class="st">"C'est ma blonde."</span>),</span>
<span id="cb89-152"><a href="#cb89-152" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"That car is so cool!"</span>, generation<span class="op">=</span><span class="st">"C'est ben l'fun ce char-là!"</span>),</span>
<span id="cb89-153"><a href="#cb89-153" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"I'll call you tonight."</span>, generation<span class="op">=</span><span class="st">"Je vais t'appeler ce soir."</span>),</span>
<span id="cb89-154"><a href="#cb89-154" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"He's always bragging."</span>, generation<span class="op">=</span><span class="st">"Il se vente tout l'temps."</span>),</span>
<span id="cb89-155"><a href="#cb89-155" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"We grabbed a coffee at Tim's."</span>, generation<span class="op">=</span><span class="st">"On a pris un café au Tim."</span>),</span>
<span id="cb89-156"><a href="#cb89-156" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"Close the window, it's chilly."</span>, generation<span class="op">=</span><span class="st">"Ferme la fenêtre, y fait frette."</span>),</span>
<span id="cb89-157"><a href="#cb89-157" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"I have an appointment at 3."</span>, generation<span class="op">=</span><span class="st">"J'ai un rendez-vous à trois heures."</span>),</span>
<span id="cb89-158"><a href="#cb89-158" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"They're celebrating their birthday."</span>, generation<span class="op">=</span><span class="st">"Ils fêtent leur fête."</span>),</span>
<span id="cb89-159"><a href="#cb89-159" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"I parked in the back."</span>, generation<span class="op">=</span><span class="st">"J'ai stationné dans l'fond."</span>),</span>
<span id="cb89-160"><a href="#cb89-160" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"The metro is packed."</span>, generation<span class="op">=</span><span class="st">"Le métro est plein à craquer."</span>),</span>
<span id="cb89-161"><a href="#cb89-161" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"We watched a movie last night."</span>, generation<span class="op">=</span><span class="st">"On a écouté un film hier soir."</span>),</span>
<span id="cb89-162"><a href="#cb89-162" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"I need to do my groceries."</span>, generation<span class="op">=</span><span class="st">"J'dois faire mon épicerie."</span>),</span>
<span id="cb89-163"><a href="#cb89-163" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"Don't forget your boots."</span>, generation<span class="op">=</span><span class="st">"Oublie pas tes bottes."</span>),</span>
<span id="cb89-164"><a href="#cb89-164" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"It's snowing again."</span>, generation<span class="op">=</span><span class="st">"Il neige encore."</span>),</span>
<span id="cb89-165"><a href="#cb89-165" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"I'll take the bus."</span>, generation<span class="op">=</span><span class="st">"J'va prendre l'bus."</span>),</span>
<span id="cb89-166"><a href="#cb89-166" aria-hidden="true" tabindex="-1"></a>    dspy.Example(prompt<span class="op">=</span><span class="st">"We're out of milk."</span>, generation<span class="op">=</span><span class="st">"On est à court de lait."</span>),</span>
<span id="cb89-167"><a href="#cb89-167" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb89-168"><a href="#cb89-168" aria-hidden="true" tabindex="-1"></a>trainset <span class="op">=</span> [x.with_inputs(<span class="st">'prompt'</span>) <span class="cf">for</span> x <span class="kw">in</span> examples]</span>
<span id="cb89-169"><a href="#cb89-169" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-170"><a href="#cb89-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-171"><a href="#cb89-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-172"><a href="#cb89-172" aria-hidden="true" tabindex="-1"></a>Here the task</span>
<span id="cb89-173"><a href="#cb89-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-174"><a href="#cb89-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-177"><a href="#cb89-177" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb89-178"><a href="#cb89-178" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> format_demos(demos):</span>
<span id="cb89-179"><a href="#cb89-179" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb89-180"><a href="#cb89-180" aria-hidden="true" tabindex="-1"></a><span class="co">    Wrap every demo once – no duplicated header lines.</span></span>
<span id="cb89-181"><a href="#cb89-181" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb89-182"><a href="#cb89-182" aria-hidden="true" tabindex="-1"></a>    parts <span class="op">=</span> [<span class="st">"Here are examples of your expected behavior."</span>,</span>
<span id="cb89-183"><a href="#cb89-183" aria-hidden="true" tabindex="-1"></a>             <span class="st">"&lt;examples&gt;"</span>]</span>
<span id="cb89-184"><a href="#cb89-184" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, demo <span class="kw">in</span> <span class="bu">enumerate</span>(demos, <span class="dv">1</span>):</span>
<span id="cb89-185"><a href="#cb89-185" aria-hidden="true" tabindex="-1"></a>        parts <span class="op">+=</span> [</span>
<span id="cb89-186"><a href="#cb89-186" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"&lt;example_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">&gt;"</span>,</span>
<span id="cb89-187"><a href="#cb89-187" aria-hidden="true" tabindex="-1"></a>            <span class="st">"User:"</span>,</span>
<span id="cb89-188"><a href="#cb89-188" aria-hidden="true" tabindex="-1"></a>            demo[<span class="st">"prompt"</span>],</span>
<span id="cb89-189"><a href="#cb89-189" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Assistant:"</span>,</span>
<span id="cb89-190"><a href="#cb89-190" aria-hidden="true" tabindex="-1"></a>            demo[<span class="st">"generation"</span>],</span>
<span id="cb89-191"><a href="#cb89-191" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"&lt;/example_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">&gt;"</span>,</span>
<span id="cb89-192"><a href="#cb89-192" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb89-193"><a href="#cb89-193" aria-hidden="true" tabindex="-1"></a>    parts.append(<span class="st">"&lt;/examples&gt;"</span>)</span>
<span id="cb89-194"><a href="#cb89-194" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(parts)</span>
<span id="cb89-195"><a href="#cb89-195" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-196"><a href="#cb89-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-199"><a href="#cb89-199" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb89-200"><a href="#cb89-200" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the SimplestAdapter as before</span></span>
<span id="cb89-201"><a href="#cb89-201" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SimplestAdapter(dspy.Adapter):</span>
<span id="cb89-202"><a href="#cb89-202" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, lm, lm_kwargs, signature, demos, inputs):</span>
<span id="cb89-203"><a href="#cb89-203" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(inputs)</span>
<span id="cb89-204"><a href="#cb89-204" aria-hidden="true" tabindex="-1"></a>        system_content <span class="op">=</span> signature.instructions</span>
<span id="cb89-205"><a href="#cb89-205" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> demos:</span>
<span id="cb89-206"><a href="#cb89-206" aria-hidden="true" tabindex="-1"></a>            system_content <span class="op">+=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> format_demos(demos)</span>
<span id="cb89-207"><a href="#cb89-207" aria-hidden="true" tabindex="-1"></a>        messages <span class="op">=</span> [</span>
<span id="cb89-208"><a href="#cb89-208" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"role"</span>: <span class="st">"system"</span>, <span class="st">"content"</span>: system_content},</span>
<span id="cb89-209"><a href="#cb89-209" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: inputs[<span class="st">"prompt"</span>]},</span>
<span id="cb89-210"><a href="#cb89-210" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb89-211"><a href="#cb89-211" aria-hidden="true" tabindex="-1"></a>        outputs <span class="op">=</span> lm(messages<span class="op">=</span>messages, <span class="op">**</span>lm_kwargs)</span>
<span id="cb89-212"><a href="#cb89-212" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [{<span class="st">"generation"</span>: outputs[<span class="dv">0</span>]}]</span>
<span id="cb89-213"><a href="#cb89-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-214"><a href="#cb89-214" aria-hidden="true" tabindex="-1"></a><span class="co"># Do NOT call dspy.configure(adapter=SimplestAdapter())</span></span>
<span id="cb89-215"><a href="#cb89-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-216"><a href="#cb89-216" aria-hidden="true" tabindex="-1"></a><span class="co"># Subclass Predict to use the custom adapter only for this instance</span></span>
<span id="cb89-217"><a href="#cb89-217" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyPredict(dspy.Predict):</span>
<span id="cb89-218"><a href="#cb89-218" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, <span class="op">**</span>kwargs):</span>
<span id="cb89-219"><a href="#cb89-219" aria-hidden="true" tabindex="-1"></a>        adapter <span class="op">=</span> SimplestAdapter()</span>
<span id="cb89-220"><a href="#cb89-220" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> dspy.settings.context(adapter<span class="op">=</span>adapter):</span>
<span id="cb89-221"><a href="#cb89-221" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">super</span>().forward(<span class="op">**</span>kwargs)</span>
<span id="cb89-222"><a href="#cb89-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-223"><a href="#cb89-223" aria-hidden="true" tabindex="-1"></a><span class="co"># Use MyPredict instead of dspy.Predict</span></span>
<span id="cb89-224"><a href="#cb89-224" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> signature(dspy.Signature):</span>
<span id="cb89-225"><a href="#cb89-225" aria-hidden="true" tabindex="-1"></a>    prompt <span class="op">=</span> dspy.InputField()</span>
<span id="cb89-226"><a href="#cb89-226" aria-hidden="true" tabindex="-1"></a>    generation <span class="op">=</span> dspy.OutputField()</span>
<span id="cb89-227"><a href="#cb89-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-228"><a href="#cb89-228" aria-hidden="true" tabindex="-1"></a>system_prompt <span class="op">=</span> <span class="st">" "</span></span>
<span id="cb89-229"><a href="#cb89-229" aria-hidden="true" tabindex="-1"></a>my_program <span class="op">=</span> MyPredict(signature.with_instructions(system_prompt))</span>
<span id="cb89-230"><a href="#cb89-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-231"><a href="#cb89-231" aria-hidden="true" tabindex="-1"></a><span class="co"># Test</span></span>
<span id="cb89-232"><a href="#cb89-232" aria-hidden="true" tabindex="-1"></a>my_program(prompt<span class="op">=</span><span class="st">"Hi how are you?"</span>)</span>
<span id="cb89-233"><a href="#cb89-233" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-234"><a href="#cb89-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-237"><a href="#cb89-237" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb89-238"><a href="#cb89-238" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb89-239"><a href="#cb89-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-240"><a href="#cb89-240" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_french(text):</span>
<span id="cb89-241"><a href="#cb89-241" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Naive French detector: check for common French words/accents</span></span>
<span id="cb89-242"><a href="#cb89-242" aria-hidden="true" tabindex="-1"></a>    french_markers <span class="op">=</span> [</span>
<span id="cb89-243"><a href="#cb89-243" aria-hidden="true" tabindex="-1"></a>        <span class="vs">r"\b(le|la|les|un|une|des|du|de|et|à|est|sont|avec|pour|sur|par|mais|ou|où|que|qui|quand|comment|nous|vous|ils|elles|ça|ce|cette|ces)\b"</span>,</span>
<span id="cb89-244"><a href="#cb89-244" aria-hidden="true" tabindex="-1"></a>        <span class="vs">r"[éèêàùçîôâœëïü]"</span>,</span>
<span id="cb89-245"><a href="#cb89-245" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb89-246"><a href="#cb89-246" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">any</span>(re.search(marker, text.lower()) <span class="cf">for</span> marker <span class="kw">in</span> french_markers)</span>
<span id="cb89-247"><a href="#cb89-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-248"><a href="#cb89-248" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> translation_judge(example, prediction, trace<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb89-249"><a href="#cb89-249" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb89-250"><a href="#cb89-250" aria-hidden="true" tabindex="-1"></a><span class="co">    Return 1.0 if the output looks French, else 0.0.</span></span>
<span id="cb89-251"><a href="#cb89-251" aria-hidden="true" tabindex="-1"></a><span class="co">    Doing the cast explicitly guarantees we never hand DSPy a None.</span></span>
<span id="cb89-252"><a href="#cb89-252" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb89-253"><a href="#cb89-253" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> prediction.get(<span class="st">"generation"</span>, <span class="st">""</span>) <span class="kw">or</span> <span class="st">""</span></span>
<span id="cb89-254"><a href="#cb89-254" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb89-255"><a href="#cb89-255" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">float</span>(is_french(output))</span>
<span id="cb89-256"><a href="#cb89-256" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb89-257"><a href="#cb89-257" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Anything weird is just a miss</span></span>
<span id="cb89-258"><a href="#cb89-258" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.0</span></span>
<span id="cb89-259"><a href="#cb89-259" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-260"><a href="#cb89-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-263"><a href="#cb89-263" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb89-264"><a href="#cb89-264" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> dspy.MIPROv2(translation_judge, max_bootstrapped_demos <span class="op">=</span> <span class="dv">0</span>, max_labeled_demos <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb89-265"><a href="#cb89-265" aria-hidden="true" tabindex="-1"></a>my_program_optimized <span class="op">=</span> optimizer.<span class="bu">compile</span>(my_program, trainset<span class="op">=</span>trainset)</span>
<span id="cb89-266"><a href="#cb89-266" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-267"><a href="#cb89-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-268"><a href="#cb89-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-269"><a href="#cb89-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-272"><a href="#cb89-272" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb89-273"><a href="#cb89-273" aria-hidden="true" tabindex="-1"></a>my_program_optimized(prompt <span class="op">=</span> <span class="st">"Hi how are you?"</span>)</span>
<span id="cb89-274"><a href="#cb89-274" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-275"><a href="#cb89-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-276"><a href="#cb89-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-279"><a href="#cb89-279" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb89-280"><a href="#cb89-280" aria-hidden="true" tabindex="-1"></a>my_program_optimized.inspect_history()</span>
<span id="cb89-281"><a href="#cb89-281" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-282"><a href="#cb89-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-283"><a href="#cb89-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-286"><a href="#cb89-286" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb89-287"><a href="#cb89-287" aria-hidden="true" tabindex="-1"></a>evaluator <span class="op">=</span> dspy.Evaluate(devset <span class="op">=</span> trainset, metric<span class="op">=</span>translation_judge)</span>
<span id="cb89-288"><a href="#cb89-288" aria-hidden="true" tabindex="-1"></a>evaluator(my_program_optimized)</span>
<span id="cb89-289"><a href="#cb89-289" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-290"><a href="#cb89-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-291"><a href="#cb89-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-294"><a href="#cb89-294" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb89-295"><a href="#cb89-295" aria-hidden="true" tabindex="-1"></a>evaluator <span class="op">=</span> dspy.Evaluate(devset <span class="op">=</span> trainset, metric<span class="op">=</span>translation_judge)</span>
<span id="cb89-296"><a href="#cb89-296" aria-hidden="true" tabindex="-1"></a>evaluator(my_program)</span>
<span id="cb89-297"><a href="#cb89-297" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-298"><a href="#cb89-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-299"><a href="#cb89-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-302"><a href="#cb89-302" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb89-303"><a href="#cb89-303" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> dspy.MIPROv2(translation_judge, max_bootstrapped_demos <span class="op">=</span> <span class="dv">2</span>, max_labeled_demos <span class="op">=</span> <span class="dv">2</span>)</span>
<span id="cb89-304"><a href="#cb89-304" aria-hidden="true" tabindex="-1"></a>my_program_optimized_with_demo <span class="op">=</span> optimizer.<span class="bu">compile</span>(my_program, trainset<span class="op">=</span>trainset)</span>
<span id="cb89-305"><a href="#cb89-305" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-306"><a href="#cb89-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-307"><a href="#cb89-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-308"><a href="#cb89-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-311"><a href="#cb89-311" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb89-312"><a href="#cb89-312" aria-hidden="true" tabindex="-1"></a>my_program_optimized_with_demo(prompt <span class="op">=</span> <span class="st">"Hi how are you?"</span>)</span>
<span id="cb89-313"><a href="#cb89-313" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-314"><a href="#cb89-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-315"><a href="#cb89-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-318"><a href="#cb89-318" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb89-319"><a href="#cb89-319" aria-hidden="true" tabindex="-1"></a>my_program_optimized_with_demo.inspect_history()</span>
<span id="cb89-320"><a href="#cb89-320" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-321"><a href="#cb89-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-322"><a href="#cb89-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-325"><a href="#cb89-325" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb89-326"><a href="#cb89-326" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> dspy.BootstrapFewShotWithOptuna(translation_judge, max_bootstrapped_demos <span class="op">=</span> <span class="dv">10</span>, max_labeled_demos <span class="op">=</span> <span class="dv">10</span>)</span>
<span id="cb89-327"><a href="#cb89-327" aria-hidden="true" tabindex="-1"></a>my_program_optimized_with_demo <span class="op">=</span> optimizer.<span class="bu">compile</span>(my_program, trainset<span class="op">=</span>trainset, max_demos<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb89-328"><a href="#cb89-328" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-329"><a href="#cb89-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-330"><a href="#cb89-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-331"><a href="#cb89-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-334"><a href="#cb89-334" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb89-335"><a href="#cb89-335" aria-hidden="true" tabindex="-1"></a>my_program_optimized_with_demo(prompt <span class="op">=</span> <span class="st">"Hi how are you?"</span>)</span>
<span id="cb89-336"><a href="#cb89-336" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-337"><a href="#cb89-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-338"><a href="#cb89-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-341"><a href="#cb89-341" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb89-342"><a href="#cb89-342" aria-hidden="true" tabindex="-1"></a>my_program_optimized_with_demo.inspect_history()</span>
<span id="cb89-343"><a href="#cb89-343" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-344"><a href="#cb89-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-345"><a href="#cb89-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-348"><a href="#cb89-348" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb89-349"><a href="#cb89-349" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dspy</span>
<span id="cb89-350"><a href="#cb89-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-351"><a href="#cb89-351" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> QuebecTranslationJudge(dspy.Signature):</span>
<span id="cb89-352"><a href="#cb89-352" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""You are an expert Quebec French linguist. For each English sentence and its proposed French translation, evaluate the translation on a scale of 1 to 5 based on the following criteria, with 5 being a perfect, natural-sounding translation.</span></span>
<span id="cb89-353"><a href="#cb89-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-354"><a href="#cb89-354" aria-hidden="true" tabindex="-1"></a><span class="co">1.  **Accuracy**: Does the French convey the same meaning as the English?</span></span>
<span id="cb89-355"><a href="#cb89-355" aria-hidden="true" tabindex="-1"></a><span class="co">2.  **Register**: Is the tone appropriately informal/colloquial (not formal textbook French)?</span></span>
<span id="cb89-356"><a href="#cb89-356" aria-hidden="true" tabindex="-1"></a><span class="co">3.  **Regional Vocabulary**: Does it use authentic Quebec French terms (e.g., "dépanneur", "frette", "char")?</span></span>
<span id="cb89-357"><a href="#cb89-357" aria-hidden="true" tabindex="-1"></a><span class="co">4.  **Contractions**: Are natural Quebec French contractions used (e.g., "j'va", "t'sais", "y fait")?</span></span>
<span id="cb89-358"><a href="#cb89-358" aria-hidden="true" tabindex="-1"></a><span class="co">5.  **Proper Nouns &amp; Anglicisms**: Are names (e.g., "Tim's") and common anglicisms (e.g., "weekend") handled appropriately for Quebec French?</span></span>
<span id="cb89-359"><a href="#cb89-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-360"><a href="#cb89-360" aria-hidden="true" tabindex="-1"></a><span class="co">Provide brief feedback on any issues and output only the final numerical score."""</span></span>
<span id="cb89-361"><a href="#cb89-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-362"><a href="#cb89-362" aria-hidden="true" tabindex="-1"></a>    english_sentence <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">"The original sentence in English."</span>)</span>
<span id="cb89-363"><a href="#cb89-363" aria-hidden="true" tabindex="-1"></a>    french_translation <span class="op">=</span> dspy.InputField(desc<span class="op">=</span><span class="st">"The proposed translation in Quebec French."</span>)</span>
<span id="cb89-364"><a href="#cb89-364" aria-hidden="true" tabindex="-1"></a>    feedback <span class="op">=</span> dspy.OutputField(desc<span class="op">=</span><span class="st">"Brief feedback on the translation's quality."</span>)</span>
<span id="cb89-365"><a href="#cb89-365" aria-hidden="true" tabindex="-1"></a>    score <span class="op">=</span> dspy.OutputField(desc<span class="op">=</span><span class="st">"A single integer from 1 to 5."</span>)</span>
<span id="cb89-366"><a href="#cb89-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-367"><a href="#cb89-367" aria-hidden="true" tabindex="-1"></a><span class="co"># If you have a capable model configured globally, just do this:</span></span>
<span id="cb89-368"><a href="#cb89-368" aria-hidden="true" tabindex="-1"></a>llm_judge <span class="op">=</span> dspy.Predict(QuebecTranslationJudge)</span>
<span id="cb89-369"><a href="#cb89-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-370"><a href="#cb89-370" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> translation_judge(example, prediction, trace<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb89-371"><a href="#cb89-371" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb89-372"><a href="#cb89-372" aria-hidden="true" tabindex="-1"></a><span class="co">    An LLM-based metric that judges translation quality.</span></span>
<span id="cb89-373"><a href="#cb89-373" aria-hidden="true" tabindex="-1"></a><span class="co">    It robustly parses the score and normalizes it to a 0.0-1.0 scale.</span></span>
<span id="cb89-374"><a href="#cb89-374" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb89-375"><a href="#cb89-375" aria-hidden="true" tabindex="-1"></a>    english_sentence <span class="op">=</span> example.prompt</span>
<span id="cb89-376"><a href="#cb89-376" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure the prediction's output is not empty</span></span>
<span id="cb89-377"><a href="#cb89-377" aria-hidden="true" tabindex="-1"></a>    french_translation <span class="op">=</span> prediction.get(<span class="st">"generation"</span>, <span class="st">""</span>)</span>
<span id="cb89-378"><a href="#cb89-378" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> french_translation:</span>
<span id="cb89-379"><a href="#cb89-379" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.0</span></span>
<span id="cb89-380"><a href="#cb89-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-381"><a href="#cb89-381" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb89-382"><a href="#cb89-382" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Call the LLM judge to get a score</span></span>
<span id="cb89-383"><a href="#cb89-383" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> llm_judge(</span>
<span id="cb89-384"><a href="#cb89-384" aria-hidden="true" tabindex="-1"></a>            english_sentence<span class="op">=</span>english_sentence,</span>
<span id="cb89-385"><a href="#cb89-385" aria-hidden="true" tabindex="-1"></a>            french_translation<span class="op">=</span>french_translation</span>
<span id="cb89-386"><a href="#cb89-386" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb89-387"><a href="#cb89-387" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parse the score and normalize it to a 0.0-1.0 range</span></span>
<span id="cb89-388"><a href="#cb89-388" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (e.g., a score of 5 becomes 1.0, 1 becomes 0.2)</span></span>
<span id="cb89-389"><a href="#cb89-389" aria-hidden="true" tabindex="-1"></a>        score <span class="op">=</span> <span class="bu">float</span>(result.score)</span>
<span id="cb89-390"><a href="#cb89-390" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> score <span class="op">/</span> <span class="fl">5.0</span></span>
<span id="cb89-391"><a href="#cb89-391" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> (<span class="pp">ValueError</span>, <span class="pp">AttributeError</span>, <span class="pp">TypeError</span>):</span>
<span id="cb89-392"><a href="#cb89-392" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If the LLM fails to output a valid score, return 0.0</span></span>
<span id="cb89-393"><a href="#cb89-393" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.0</span></span>
<span id="cb89-394"><a href="#cb89-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-395"><a href="#cb89-395" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/MaximeRivest/maximerivest-blog/edit/main/posts/automatic-system-prompt-optimization.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer></body></html>